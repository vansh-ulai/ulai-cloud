"use strict";(globalThis.webpackChunknotion_next=globalThis.webpackChunknotion_next||[]).push([[59388,90871],{53592:(e,t,o)=>{o.r(t),o.d(t,{attemptServerBackedLocalDuplicate:()=>B,serverBackedLocalDuplicate:()=>M});o(944114),o(581454);var a=()=>o(165358),r=()=>o(386164),i=()=>o(388821),s=()=>o(912720),c=()=>o(199378),n=()=>o(229833),l=()=>o(763824),d=()=>o(973647),u=()=>o(466614),p=()=>o(559506),m=()=>o(666144),g=()=>o(231297),h=()=>o(974233),v=()=>o(611191),k=()=>o(866654),_=()=>o(261450),y=()=>o(503388),f=()=>o(966152),S=()=>o(59110),I=()=>o(949653),b=()=>o(677733);function M(e){const{environment:t,sourceBlock:o,targetInMemoryRecordCache:a,transaction:r,options:s,targetSpaceId:c,installationImprint:n,templateInstallationMetadata:u={},shouldUseSynchronousDuplicationAPI:p,stopwatch:m,from:g}=e,h=performance.now();null==m||m.mark("server_duplicate_start");const v=e.copyIndicators??(0,y().U8)({environment:t,sourceBlocks:[o],targetRecordCache:a,transaction:r,spaceId:c});null==m||m.mark("create_copy_indicators");const k=l().yX();return r.postSubmitCallbacks.push((async e=>{if(null==m||m.mark("transaction_post_submit_callback"),e)return(0,f().P0)({environment:t,type:"server_duplicate_transaction_post_submit_callback_error",data:{copyIndicatorIds:v.map((e=>e.id)),error:e,targetSpaceId:c,options:s}}),void k.resolve(d().Q.fail(e));(0,y().Yj)(v),null==m||m.mark("initialize_copy_indicators_progress_state");const a=await B({environment:t,sourceBlockPointer:o,targetBlockStore:v[0],options:s,templateInstallationMetadata:u,stopwatch:m,from:g});if(d().Q.isSuccess(a))return(0,_().E)({environment:t,success:!0,time:performance.now()-h,user_action:r.getUserActionForAnalyticsPurposesOnly(),is_duplication_local:!0,duplication_size:a.value.size,method:"server_backed_local_duplication",from:g}),null==m||m.mark("server_backed_local_duplicate_success"),(0,y().dH)(v),void k.resolve(d().Q.success({}));const l=r.getUserActionForAnalyticsPurposesOnly(),S=await(0,b().performServerDuplicate)({environment:t,copyIndicators:v,sourceBlocks:[o],targetSpaceId:c,options:s,templateInstallationMetadata:u,installationImprint:n,shouldUseSynchronousDuplicationAPI:p,stopwatch:m,userAction:l});if((0,y().dH)(v),d().Q.isFail(S))return(0,y().uC)({environment:t,copyIndicators:v}),(0,f().lI)({environment:t,type:"server_duplicate_iterator_error",error:S.error,data:{}}),void k.resolve(S);(0,_().E)({environment:t,success:!0,time:performance.now()-h,user_action:r.getUserActionForAnalyticsPurposesOnly(),is_duplication_local:!0,duplication_size:S.value.size,method:"sbld_fallback_server_duplication",from:g}),null==m||m.mark("server_duplicate_success"),k.resolve(d().Q.success({recordIdMap:S.value.recordIdMapJson?i().RecordMapPolymorphic.create(S.value.recordIdMapJson):void 0}))})),d().Q.success({blockStores:v,onComplete:k.promise})}async function B(e){const{environment:t,sourceBlockPointer:o,targetBlockStore:l,options:_,templateInstallationMetadata:y,recordLimit:b=500,targetInMemoryRecordCache:M,stopwatch:B,from:C}=e;null==B||B.mark("attempt_server_backed_local_duplicate_start"),(0,f().JW)({environment:t,type:"server_duplicate_attempt_server_backed_local_duplicate",data:{sourceBlockPointer:o,targetBlockStore:l,targetSpaceId:l.getSpaceId(),options:_}});const w=(0,v().$J)(),T=await async function(e){const{environment:t,sourceBlockPointer:o,targetBlockStore:s,targetInMemoryRecordCache:c,options:l,enableLegacyTransclusionFixing:d,recordLimit:u}=e,g=c??s.inMemoryRecordCache,v={environment:t,blockId:o.id,inMemoryRecordCache:g,options:{allowCopyCollections:!0,requireFullSubtree:!0,skipTransclusionContainerChildren:!l.deepCopyTransclusionContainers,allowCopyExternalObjectInstances:!l.convertExternalObjectInstancesToPlaceholders,includeLegacyTransclusionBlockValues:d}};let _;if(_=(0,S().loadLocalSubtree)(v),!_.recordMap&&g===t.defaultRecordCache.inMemoryRecordCache)try{(0,f().JW)({environment:t,type:"performInexactPagePreload",data:{message:"No local subtree found, performing performInexactPagePreload",loadLocalSubtreeArgs:v}}),await(0,k().A$)(t,{table:"block",id:o.id,spaceId:o.spaceId}),_=(0,S().loadLocalSubtree)(v)}catch(y){a().log({level:"warning",from:"attemptServerBackedLocalDuplicate",type:"persistedRecordCachePreloadError",error:(0,n().convertErrorToLog)(y),data:{message:"Failed to preload subtree from persisted record cache"}})}_.recordMap||((0,f().JW)({environment:t,type:"loadLocalSubtreeApi",data:{message:"No local subtree found from previous attempts, attemping API call to loadBlockSubtree",currentLocalSubtreeResponse:_}}),_=await async function(e){const{environment:t,sourceBlockPointer:o,recordLimit:s,targetBlockStore:c,loadLocalSubtreeArgs:l}=e;try{const e=await p().callApi({eventName:"loadBlockSubtree",environment:t,data:{block:{id:o.id,spaceId:o.spaceId},shallow:!1,recordCountLimit:s},headers:(0,r().WS)({spaceId:o.spaceId})});if((0,f().JW)({environment:t,type:"loadBlockSubtreeApiResult",data:{message:"Result from loadBlockSubtree API call",subtreeResult:e,apiArgs:{block:{id:o.id,spaceId:o.spaceId},shallow:!1,recordCountLimit:s}}}),"success"===e.type){const o=i().RecordMapWithRole.create(e.data.subtreeRecordMap);return await m()._O({environment:t,inMemoryRecordCache:l.inMemoryRecordCache,recordMap:o,debugSource:"load_local_subtree_from_server"}),(0,S().loadLocalSubtree)(l)}{const t=(0,h().V)(e);a().log({level:"warning",from:"attemptServerBackedLocalDuplicate",type:"loadBlockSubtreeFailure",data:{message:"Error fetching subtree",miscDataToConvertToString:{error:t,sourceBlockPointer:o,cacheSize:c.inMemoryRecordCache.size,targetBlockPointer:{id:c.id,spaceId:c.getSpaceId(),type:c.getType()}}}})}}catch(y){a().log({level:"error",from:"attemptServerBackedLocalDuplicate",type:"subtreeLoadError",error:(0,n().convertErrorToLog)(y),data:{message:"Error loading subtree",miscDataToConvertToString:{sourceBlockPointer:o,cacheSize:c.inMemoryRecordCache.size,targetBlockPointer:{id:c.id,spaceId:c.getSpaceId(),type:c.getType()}}}})}}({environment:t,sourceBlockPointer:o,recordLimit:u,targetBlockStore:s,loadLocalSubtreeArgs:v}));_&&!_.recordMap&&a().log({level:"warning",from:"attemptServerBackedLocalDuplicate",type:"subtreeLoadFailure",data:{message:"Failed to load subtree",miscDataToConvertToString:{sourceBlockPointer:o,cacheSize:s.inMemoryRecordCache.size,reason:"error"===_.type?_.reason:void 0,targetBlockPointer:{id:s.id,spaceId:s.getSpaceId(),type:s.getType()},missingRecord:"error"===_.type?_.pointer:void 0}}});return _}({environment:t,sourceBlockPointer:o,targetBlockStore:l,targetInMemoryRecordCache:M,options:_,enableLegacyTransclusionFixing:w,recordLimit:b});if(null==B||B.mark("try_load_local_subtree_finished"),!T||!T.recordMap)return d().Q.fail({});if(u().Lw({sourceSpaceId:o.spaceId,targetSpaceId:l.getSpaceId(),sourceBlockSubtree:T.recordMap}))return a().log({level:"warning",from:"attemptServerBackedLocalDuplicate",type:"accessLockingWarning",data:{message:"Unable to perform local duplication",miscDataToConvertToString:{sourceBlockPointer:o,targetBlockPointer:{id:l.id,spaceId:l.getSpaceId(),type:l.getType()}}}}),null==B||B.mark("attempt_server_backed_local_duplicate_failure"),d().Q.fail({});for(const r of T.recordMap.getTables())if(r===s().yB||r===c().SC)return a().log({level:"warning",from:"attemptServerBackedLocalDuplicate",type:"invalidRecordType",data:{message:"Local duplication does not support automation tables",miscDataToConvertToString:{sourceBlockPointer:o,targetBlockPointer:{id:l.id,spaceId:l.getSpaceId(),type:l.getType()}}}}),null==B||B.mark("attempt_server_backed_local_duplicate_failure"),d().Q.fail({});try{var D;(0,f().JW)({environment:t,type:"server_backed_duplicate_start_transaction",data:{message:"Starting transactionActions.createAndCommit for localDuplicate",sourceBlockPointer:o,targetBlockPointer:{id:l.id,spaceId:l.getSpaceId(),type:l.getType()}}});const{serverCommitResult:e}=g().createAndCommit({userAction:"server_backed_local_duplicate",environment:t,canUndo:!0,isTemplateInstantiationTransaction:Boolean(y),perform:e=>(0,I().localDuplicate)({environment:t,sourceBlockId:o.id,targetBlockPointer:l.pointer,sourceBlockSubtree:T.recordMap,targetInMemoryRecordCache:l.inMemoryRecordCache,transaction:e,templateInstallationMetadata:y,stopwatch:B,options:{..._,preventLegacyTransclusions:w},from:C})});return await e,null==B||B.mark("server_backed_local_duplicate_finished"),(0,f().JW)({environment:t,type:"server_duplicate_attempt_server_backed_local_duplicate_success",data:{targetSpaceId:l.getSpaceId(),options:_}}),d().Q.success({size:null===(D=T.recordMap)||void 0===D?void 0:D.getSize(),pageStore:l,transactionPromise:e})}catch(P){return a().log({level:"error",from:"attemptServerBackedLocalDuplicate",type:"subtreeLoadError",error:(0,n().convertErrorToLog)(P),data:{message:"Failed to load subtree",miscDataToConvertToString:{sourceBlockPointer:o,targetBlockPointer:{id:l.id,spaceId:l.getSpaceId(),type:l.getType()}}}}),d().Q.fail({})}}},418375:(e,t,o)=>{o.d(t,{A:()=>a});const a=o(757695).Store.createValue({executionTarget:null},{name:"DuplicationDebuggingStore"})},568131:(e,t,o)=>{o.r(t),o.d(t,{duplicateBlock:()=>C});o(16280),o(898992),o(823215),o(581454),o(737550);var a=()=>o(929219),r=()=>o(665344),i=()=>o(854150),s=()=>o(763824),c=()=>o(973647),n=()=>o(970330),l=()=>o(901389),d=()=>o(863168),u=()=>o(972435),p=()=>o(494043),m=()=>o(406792);class g{constructor(e){this.environment=void 0,this.metricName=void 0,this.startMetric=void 0,this.prevLapMetric=void 0,this.extraData=void 0,this.environment=e.environment,this.metricName=e.metricName,this.startMetric=m().default.mark(e.metricName),this.prevLapMetric=m().default.mark(e.metricName),this.extraData=e.extraData??{}}mark(e){m().default.measure(this.prevLapMetric,{environment:this.environment,data:{type:e,...this.extraData},sampleDecision:"default"}),this.prevLapMetric=m().default.mark(this.metricName)}end(){m().default.measure(this.startMetric,{environment:this.environment,data:{type:"total",...this.extraData},sampleDecision:"default"})}}var h=()=>o(765957),v=()=>o(261358),k=()=>o(95758),_=()=>o(418375),y=()=>o(261450),f=()=>o(977529),S=()=>o(112589),I=()=>o(985284),b=()=>o(949653),M=()=>o(53592),B=()=>o(677733);function C(e){if(e.skipUserFacingMessages)return w(e);const t=I().CU({sourceBlocks:e.stores});try{const o=w({...e,onRedundantDuplicationError:()=>{(0,f().Yv)()}});return{...o,onComplete:o.onComplete.then((e=>("success"===e.status?I().MK(t):I().UO(t),e))).catch((e=>{throw I().UO(t),e}))}}catch(o){throw I().UO(t),o}}function w(e){const{environment:t,stores:o,transaction:m,targetSpaceId:f,executionTarget:I,from:C,options:w,installationImprint:T,shouldAttemptServerBackedLocalDuplication:D,templateInstallationMetadata:P,shouldUseSynchronousDuplicationAPI:L,skipUserFacingMessages:A,onRedundantDuplicationError:R}=e,x="local"===(_().A.getState().executionTarget??I)?"local_duplication":D?"server_backed_local_duplication":L?"server_synchronous_duplication":"server_duplication",U=new g({environment:t,metricName:"duplicate_block_stopwatch",extraData:{duplication_type:x,from:C}});if(0===o.length)throw new Error("Must duplicate at least one block");const E=o[0].getSpaceId();if(!o.every((e=>e.getSpaceId()===E)))throw new Error("All stores must be in the same space");if(o.length>1&&!o.every((e=>e.isTypedCollectionViewBlock())))throw new Error("Multiple source blocks only supported for grouped typed DB duplication");!function(e){const{environment:t,stores:o}=e;for(const s of o){var a,r;const e=(0,v().zH)(s).getValue();if(!e)continue;const{sidebarSpaceStore:o}=h().default.getState();let c;o&&e.parent_table===i().yK&&(c=k().h.createChildStore(o,{table:i().yK,id:e.parent_id}));const l=s.getAssociatedCollectionId()??(null===(a=s.getCollectionStore())||void 0===a?void 0:a.id),d={from:"copy",type:e.type,teamStore:c,is_toggleable:(0,p().Yt)(e.type,e.format),collection_id:s.getAssociatedCollectionId()??(null===(r=s.getCollectionStore())||void 0===r?void 0:r.id),new_page_id:"page"===e.type?s.id:void 0,creating_block_id:s.id,parent_collection_id:s.getParentCollectionIdUpToTwoLevels(),form_id:s.getFirstFormIdInCollectionViewBlock()};n().tP(e.type)?n().vH(t,{...d,type:e.type,collection_id:l||""}):n().vH(t,{...d,type:e.type})}}({environment:t,stores:o}),U.mark("track_create_blocks"),w.convertExternalObjectInstancesToPlaceholders=E!==f;const F=P&&(0,r().Fe)(P.source)&&P.isListedTemplate;if(1===o.length&&"local_duplication"===x&&!F){const e=(0,b().tryLocalDuplicateWithTransaction)({environment:t,store:o[0],options:w,sourceSpaceId:E,targetSpaceId:f,transaction:m,installationImprint:T,templateInstallationMetadata:P,stopwatch:U,from:C});if(e)return U.mark("try_local_duplication_success"),U.end(),{blockStores:[e],onComplete:Promise.resolve({status:"success"})};U.mark("try_local_duplication_failure")}const z=t.defaultRecordCache.inMemoryRecordCache;if(o.some((e=>e.inMemoryRecordCache!==z)))throw new Error("Can only server duplicate from the environment.defaultRecordCache.inMemoryRecordCache.");let O;if(a().A.state.online||l().f1(u().A.formatMessage(y().V.offlineError)),O=1===o.length&&D?(0,M().serverBackedLocalDuplicate)({environment:t,sourceBlock:{id:o[0].id,spaceId:o[0].getSpaceId()},targetInMemoryRecordCache:z,transaction:m,targetSpaceId:f,installationImprint:T,templateInstallationMetadata:P,stopwatch:U,shouldUseSynchronousDuplicationAPI:L,options:w,from:C}):(0,B().serverDuplicate)({environment:t,sourceBlocks:o.map((e=>({id:e.id,spaceId:e.getSpaceId()}))),targetInMemoryRecordCache:z,transaction:m,targetSpaceId:f,installationImprint:T,templateInstallationMetadata:P,stopwatch:U,shouldUseSynchronousDuplicationAPI:L,options:w,from:C,onRedundantDuplicationError:R}),U.mark("duplicate_block_immediate_return"),c().Q.isFail(O))throw A||(0,S().x)({environment:t,duplicateError:O.error}),O.error;const{blockStores:j,onComplete:Q}=O.value,N=s().yX();return Q.then((e=>{if(U.end(),c().Q.isSuccess(e)){for(const e of j)if("ai_block"===e.getType()){d().EF.setState(e.pointer.id);break}N.resolve({status:"success",recordIdMap:e.value.recordIdMap})}else A||(0,S().x)({environment:t,duplicateError:e.error,blockStores:j}),N.resolve({status:"error",error:e.error,errorMessage:(0,S().eM)(e.error)})})),{blockStores:j,onComplete:N.promise}}},977529:(e,t,o)=>{o.d(t,{DI:()=>d,Yv:()=>l,lq:()=>c});var a=()=>o(615234);const r=2*a().TD,i=8*a().TD,s=new Map;function c(e){return s.get(e)}function n(){return s.values().next().value}function l(){const e=Array.from(s.values());for(const t of e)t.clear()}class d{constructor(e){this.id=void 0,this.sourceBlocks=void 0,this.currentTimeout=null,this.stage=void 0,this.showInitialMessage=void 0,this.showUpdatedMessage=void 0,this.onClear=void 0,this.id=(0,o(498212).Ay)(),this.sourceBlocks=e.sourceBlocks,this.stage="started",this.showInitialMessage=e.showInitialMessage,this.showUpdatedMessage=e.showUpdatedMessage,this.onClear=e.onClear,s.set(this.id,this)}isOldestActive(){return n()===this}startSecondTimeout(){this.currentTimeout&&(clearTimeout(this.currentTimeout),this.currentTimeout=null),this.currentTimeout=setTimeout((()=>{this.stage="updated_message",this.isOldestActive()&&this.showUpdatedMessage(this.sourceBlocks),this.currentTimeout=null}),i)}start(){this.currentTimeout=setTimeout((()=>{this.stage="initial_message",this.isOldestActive()&&this.showInitialMessage(this.sourceBlocks),this.startSecondTimeout()}),r)}showSnackbarForCurrentStage(){"started"===this.stage||("initial_message"===this.stage?this.showInitialMessage(this.sourceBlocks):"updated_message"===this.stage?this.showUpdatedMessage(this.sourceBlocks):(0,o(534177).HB)(this.stage))}clear(){this.currentTimeout&&(clearTimeout(this.currentTimeout),this.currentTimeout=null),s.delete(this.id),this.onClear(),function(){const e=n();e&&e.showSnackbarForCurrentStage()}()}complete(){this.isOldestActive()&&this.stage,this.clear()}}},985284:(e,t,o)=>{o.d(t,{UO:()=>v,MK:()=>k,CU:()=>h});o(296540);var a=()=>o(471995),r=()=>o(69708),i=()=>o(104012),s=o(474848);function c(e){const{item:t,onDismiss:o}=e;a().D6({...t,right:(0,s.jsx)(i().Ag,{onClick:o??a().N2,children:(0,s.jsx)(r().sA,{id:"snackbar.dismiss.title",defaultMessage:"Dismiss"})})})}var n=()=>o(56366),l=()=>o(98126),d=()=>o(534177),u=()=>o(802790);const p=(0,r().YK)({pageDuplicatingMessage:{id:"duplicateProgressSnackbar.pageDuplicating",defaultMessage:"Page is duplicating"},pageStillDuplicatingMessage:{id:"duplicateProgressSnackbar.pageStillDuplicating",defaultMessage:"Page is still duplicating, but this is taking a while. Feel free to leave this page."},contentDuplicatingMessage:{id:"duplicateProgressSnackbar.contentDuplicating",defaultMessage:"Content is duplicating"},contentStillDuplicatingMessage:{id:"duplicateProgressSnackbar.contentStillDuplicating",defaultMessage:"Content is still duplicating, but this is taking a while. Feel free to leave this page."}});function m(e){const{sourceBlocks:t,stage:o}=e,a=(0,n().K8)((()=>!(!t||t.length<1)&&(null==t?void 0:t[0].isType("page"))),[t]);let i;return"initial"===o?i=a?p.pageDuplicatingMessage:p.contentDuplicatingMessage:"update"===o?i=a?p.pageStillDuplicatingMessage:p.contentStillDuplicatingMessage:(0,d().HB)(o),(0,s.jsxs)("div",{style:{display:"flex",alignItems:"center",gap:8},children:[(0,s.jsx)(l().A,{size:"sm",onDarkBackground:!0}),(0,s.jsx)("span",{children:(0,s.jsx)(r().sA,{...i})}),(0,s.jsx)("div",{style:{height:24},children:(0,s.jsx)(u().A,{type:"vertical",colorVariant:"inversePrimary",colorPalette:"gray",size:24})})]})}var g=()=>o(977529);function h(e){const{sourceBlocks:t}=e,o=new(g().DI)({sourceBlocks:t,showInitialMessage:_,showUpdatedMessage:y,onClear:f});return o.start(),o.id}function v(e){const t=(0,g().lq)(e);null==t||t.clear()}function k(e){const t=(0,g().lq)(e);null==t||t.complete()}function _(e){c({item:{label:(0,s.jsx)(m,{sourceBlocks:e,stage:"initial"}),durationMs:"keep"},onDismiss:()=>{(0,g().Yv)()}})}function y(e){c({item:{label:(0,s.jsx)(m,{sourceBlocks:e,stage:"update"}),durationMs:"keep"},onDismiss:()=>{(0,g().Yv)()}})}function f(){a().N2()}}}]);