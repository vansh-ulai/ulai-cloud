"use strict";(globalThis.webpackChunknotion_next=globalThis.webpackChunknotion_next||[]).push([[93199],{316878:(e,t,s)=>{s.r(t),s.d(t,{SqliteSubscriptionManager:()=>h,SqliteSubscriptionQuery:()=>u});s(16280),s(944114),s(517642),s(658004),s(733853),s(845876),s(432475),s(515024),s(731698),s(898992),s(803949);var i=()=>s(947482),r=()=>s(299919),o=()=>s(415123),a=()=>s(288334);class n{constructor(){this.cache=new(r().Y)((e=>this.getKeyUncached(e)))}getKey(e){return this.cache.get(e)}getKeyUncached({sql:e,args:t,queryName:i,userId:r,readTables:o,primaryKey:a,rowType:n}){const c=`${e}:${JSON.stringify(t)}:pk=${null==a?void 0:a.join(",")}`,h=c.length>128?(0,s(498212).gB)(c):c,u=`user=${r}`;return`sqlite:${i}${o?`@change(${o.join(",")})`:"@once"}:${h}:${u}:rt=${null==n?void 0:n.name}`}}const c=60*s(615234).TD;class h{constructor(e){this.queries=new Map,this.userRowTypes=new(s(99895).G)((()=>new(r().Y)((e=>({queries:new Set,optimistic:{byUpdateId:{},count:0},memoizer:new(o().OptimisticUpdateMemoizer)(e.getKey)}))))),this.keyCreator=new n,this.anonymousTypeId=0,this.backend=e}createQuery(e,t){let s=this.getQuery(e);if(s)return s;const i=this.getOrCreateRowType(e,t),r=i?this.getRowTypeState(t.userId,i):void 0;return s=new u(e,t.userId,i,null==r?void 0:r.memoizer,{public:{loading:!0,seq:0,error:void 0,valueSeq:void 0,value:void 0,errorSeq:void 0},optimistic:{input:void 0,output:void 0,optimistic:(null==r?void 0:r.optimistic)??{byUpdateId:{},count:0}}},this.createSubscriptionEffect(e,t)),this.queries.set(e,s),s}parseQuery(e){return this.backend.parser.parse(e)}dispatchRowTypeUpdate(e,t,s){const i=this.getRowTypeState(e,t);i.optimistic=(0,o().reduceOptimisticUpdateState)(i.optimistic,s),i.queries.forEach((e=>{e.dispatch(s)}))}createSubscriptionEffect(e,t){let s;return()=>{var i;const r=null===(i=this.queries.get(e))||void 0===i?void 0:i.dispatch;if(!r)throw new Error(`SqliteSubscriptionKey not found: ${e} (re-using destroyed query instance?)`);return s?(clearTimeout(s),s=void 0):this.backend.create(e,t,r),()=>{s??=setTimeout((()=>this.deleteQuery(e,t.userId)),c)}}}getQuery(e){const t=this.queries.get(e);if(t)return t}deleteQuery(e,t){const s=this.queries.get(e);if(s&&(this.backend.delete(e),this.queries.delete(e),s.rowType)){this.getRowTypeState(t,s.rowType).queries.delete(s)}}getRowTypeState(e,t){return this.userRowTypes.get(e).get(t)}getOrCreateRowType(e,t){return t.rowType?t.rowType:t.singleton?new(a().Y)({name:`singleton_queryRowType_${e}_${this.anonymousTypeId++}`,readTables:[],fromSqlite:e=>e}):t.primaryKey?new(a().L)({name:`pkey_queryRowType_${e}_${this.anonymousTypeId++}`,primaryKey:t.primaryKey,readTables:[],fromSqlite:e=>e}):void 0}}class u{constructor(e,t,i,r,o,a){this.emitter=new(s(592328).A),this.cleanup=void 0,this.resolvers=[],this.getSnapshot=()=>this.state.public,this.subscribe=e=>(0===this.emitter.listenerCount()&&(this.cleanup=this.effect()),this.emitter.addListener(e),()=>{const t=this.emitter.listenerCount();this.emitter.removeListener(e);const s=this.emitter.listenerCount();var i;1===t&&0===s&&(null===(i=this.cleanup)||void 0===i||i.call(this),this.cleanup=void 0,this.resolveRerunPromises())}),this.dispatch=e=>{"rows"!==e.type&&"error"!==e.type&&"unchanged"!==e.type||this.resolveRerunPromises();const t=this.state,s=this.reducer(t,e);this.state=s,t.public!==s.public&&this.emitter.emit(s.public)},this.key=e,this.userId=t,this.rowType=i,this.memoizer=r,this.state=o,this.effect=a}reducer(e,t){return"unchanged"===t.type?e:i().jM(e,(r=>{switch(t.type){case"put":case"del":{if(!this.memoizer)return;const s=(0,o().reduceOptimisticRowsState)(e.optimistic,t,this.memoizer);if(s===e.optimistic)return;const a=++r.public.seq;return r.optimistic=i().h4(s),void(s.output&&(r.public.value=i().h4(s.output),r.public.valueSeq=a))}case"rows":{if(r.public.loading=!1,!this.rowType||!this.memoizer)return r.public.value=i().h4(t.value),void(r.public.valueSeq=++r.public.seq);const s=this.rowType.rowsFromSqlite(t.value),a=(0,o().reduceOptimisticRowsState)(e.optimistic,{type:"rows",rows:s},this.memoizer);if(a===e.optimistic)return;const n=++r.public.seq;return r.optimistic=i().h4(a),r.public.value=i().h4(a.output),void(r.public.valueSeq=n)}case"error":{const e=++r.public.seq;return r.public.loading=!1,r.public.error=t.error,void(r.public.errorSeq=e)}default:(0,s(534177).HB)(t)}}))}waitForRerun(){return 0===this.emitter.listenerCount()?Promise.resolve():new Promise((e=>{this.resolvers.push(e)}))}resolveRerunPromises(){this.resolvers.forEach((e=>e()))}}},384233:(e,t,s)=>{s.r(t),s.d(t,{TabSqliteSubscriptionBackend:()=>d});s(16280),s(944114),s(517642),s(658004),s(733853),s(845876),s(432475),s(515024),s(731698),s(898992),s(354520),s(803949),s(581454),s(737550);var i=()=>s(319625);function r(e,t,s,i){if(0===s.length)return 0===i.length?s:i;if(0===i.length)return i;let r,o=s.length!==i.length;const a=i.map(((i,a)=>{const n=e(i);let c=s[a];var h;return n!==(c?e(c):void 0)&&(o=!0,n&&(h=n,r||(r=new Map,s.forEach((t=>{const s=e(t);s&&t&&(r??=new Map,r.set(s,t))}))),c=r.get(h))),c&&t(c,i)?c:(o=!0,i)}));return o?a:s}var o=()=>s(456895);class a{constructor(e){this.clock=0,this.map=new Map,this.keyArray=[],this.maxSize=void 0,this.choices=void 0,this.maxSize=e.maxSize,this.choices=e.choices}get(e){const t=this.map.get(e);if(t)return t.clock=this.clock++,t.value}set(e,t){const s=this.keyArray.length===this.maxSize?this.evict():this.keyArray.length;this.map.set(e,{value:t,clock:this.clock++,keyIndex:s}),this.keyArray[s]=e}evict(){let e,t=1/0,s=-1;for(let i=0;i<this.choices;i++){const i=Math.floor(Math.random()*this.keyArray.length),r=this.keyArray[i],o=this.map.get(r);o.clock<t&&(e=r,t=o.clock,s=i)}if(-1===s)throw new Error("No entry found");return this.map.delete(e),s}}class n{constructor(){this.lru=new a({maxSize:100,choices:2}),this.debug=!1}parse(e){const t=this.lru.get(e);if(t)return t;let s;try{s=function(e,t){let s=0,i=e.replace(/\s*\?\s*/g,(()=>`$${++s}`));i=i.replace(/\binsert or \w+ into\b/i,"insert into");const r=new Set,a=new Set,n=(0,o().astVisitor)((e=>({insert:t=>(r.add(t.into.name),e.super().insert(t)),update:t=>(r.add(t.table.name),e.super().update(t)),delete:t=>(r.add(t.from.name),e.super().delete(t)),truncateTable:t=>(t.tables.forEach((e=>r.add(e.name))),e.super().truncateTable(t)),tableRef:t=>(a.add(t.name),e.super().tableRef(t))}))),h=(0,o().parseFirst)(i);if(n.statement(h),c(h))return r.forEach((e=>a.delete(e))),{type:"crud",ast:t?h:void 0,readTables:Array.from(a),writeTables:Array.from(r)};return{type:"unknown",ast:t?h:void 0,tables:Array.from(a)}}(e,this.debug)}catch(r){s={type:"error",error:(0,i().A)(r)}}return this.lru.set(e,s),s}}function c(e){switch(e.type){case"select":case"insert":case"update":case"delete":case"truncate table":return!0;case"with":return c(e.in);default:return!1}}const h=!1;function u(...e){h}class d{constructor(e){this.connection=void 0,this.config=void 0,this.observer=void 0,this.broadcastWritesChannel=void 0,this.queries=new Map,this.tableToReaderQuery=new(s(99895).G)((()=>new Set)),this.closed=!1,this.enqueueReactions=void 0,this.changedTables=new Map,this.scheduledQueries=[],this.parser=new n,this.handleThisTabSqliteConnectionEvent=e=>{if(u(),"rebuild"===e.type){for(const e of this.tableToReaderQuery.keys())this.handleTableWrite(e,!0);return}const{batch:t,result:i}=e;i.body.some(s(732524).Ll)?u():t.body.forEach(((e,t)=>{const s=i.body[t];"Ok"!==s.type&&"DataOk"!==s.type||!e.sql.match(/insert|update|create|delete|truncate/i)||this.handleMaybeWriteQuery(e.sql)}))},this.handleOtherTabBroadcastEvent=e=>{e.data.tables.forEach((e=>this.handleTableWrite(e,!1)))},this.config=e.config,this.connection=e.observer.unobservedConnection,this.enqueueReactions=s(496603).sg((()=>this.reactToChanges()),e.debounceMs,{maxWait:e.debounceMs}),this.broadcastWritesChannel=e.broadcastWritesChannel,this.broadcastWritesChannel.addEventListener("message",this.handleOtherTabBroadcastEvent),this.observer=e.observer,this.observer.addListener(this.handleThisTabSqliteConnectionEvent)}create(e,t,s){if(this.queries.has(e))throw new Error(`SqliteSubscriptionBackend.create: subscription already exists: ${e}`);if(this.closed)throw new Error("SqliteSubscriptionBackend.create: closed");const i={id:e,args:t,state:{seq:0,rows:void 0,error:void 0},readTables:this.getSelectedTables(t),callback:s};i.readTables.forEach((e=>this.tableToReaderQuery.get(e).add(i))),this.queries.set(e,i),this.scheduledQueries.push(i),this.enqueueReactions()}delete(e){const t=this.queries.get(e);t&&(this.queries.delete(e),t.readTables.forEach((e=>this.tableToReaderQuery.get(e).delete(t))))}clear(){this.queries.clear(),this.tableToReaderQuery.clear(),this.changedTables.clear(),this.scheduledQueries.length=0}close(){this.clear(),this.broadcastWritesChannel.close(),this.observer.removeListener(this.handleThisTabSqliteConnectionEvent),this.closed=!0}getSeq(e){const t=this.queries.get(e);if(t){var s;return{seq:t.state.seq,changeSeq:(null===(s=t.state.rows)||void 0===s?void 0:s.seq)??0}}}handleTableWrite(e,t){if("string"!=typeof e)throw new Error(`sqliteSubscription.notifyTable: not a string: ${e}`);this.changedTables.set(e,t||Boolean(this.changedTables.get(e))),this.enqueueReactions()}handleMaybeWriteQuery(e){const t=this.parser.parse(e);if(u(),"error"===t.type){if(this.config.isLocalhost)throw t.error;s(449412).O8(new Error("Observed query could not be parsed",{cause:t.error}),{from:"TabSqliteSubscriptionBackend",type:"observedQueryParseError"})}"crud"===t.type&&t.writeTables.forEach((e=>this.handleTableWrite(e,!0))),"unknown"===t.type&&t.tables.forEach((e=>this.handleTableWrite(e,!0)))}getSelectedTables(e){if(e.readTables)return e.readTables;const t=this.parser.parse(e.sql);return"crud"===t.type?t.readTables:[]}async reactToChanges(){const e=Array.from(this.changedTables);this.changedTables.clear(),u();const t=new Set(this.scheduledQueries.filter((e=>this.queries.has(e.id))));this.scheduledQueries.length=0,u(Array.from(t));for(const[s]of e)for(const e of this.tableToReaderQuery.get(s))t.add(e);try{if(0===t.size)return void u();const e=Array.from(t),o=e.map((e=>({getData:!0,sql:e.args.sql,args:e.args.args})));try{const t=await(0,s(430476).G2)({connection:this.connection,statements:o,queryName:`subscriptions:${e.map((e=>e.args.queryName)).join(",")}`});e.forEach(((e,s)=>this.handleSubscriptionQueryResult(e,t[s].data)))}catch(r){const t=(0,i().A)(r);e.forEach((e=>this.handleSubscriptionQueryError(e,t)))}}finally{this.shouldRunQueries()&&(u(),this.enqueueReactions());const t=e.filter((e=>e[1])).map((e=>e[0]));if(t.length){const e={tables:t};u(),this.broadcastWritesChannel.postMessage(e)}h}}handleSubscriptionQueryResult(e,t){const i=++e.state.seq;if(e.args.primaryKey&&e.state.rows){const o=r((t=>e.args.primaryKey.map((e=>t[e])).join(":")),s(821062).A,e.state.rows.value,t);if(o===e.state.rows.value)return u(e.state.rows.value),void e.callback({type:"unchanged",seq:i});t=o}const o={type:"rows",value:t,seq:i};e.state.rows=o,e.state.error=void 0,u(e.state.rows.value),e.callback(o)}handleSubscriptionQueryError(e,t){const s={type:"error",seq:++e.state.seq,error:t};e.state.error=s,u(e.state.error),e.callback(s)}shouldRunQueries(){return this.scheduledQueries.length>0||this.changedTables.size>0}}},415123:(e,t,s)=>{s.r(t),s.d(t,{OptimisticUpdateComposer:()=>u,OptimisticUpdateMemoizer:()=>a,reduceOptimisticRowsState:()=>d,reduceOptimisticUpdateState:()=>o});s(16280),s(944114),s(898992),s(354520),s(581454);var i=()=>s(947482),r=()=>s(534177);function o(e,t){switch(t.type){case"put":return e.byUpdateId[t.update.id]===t.update?e:i().jM(e,(e=>{e.byUpdateId[t.update.id]=i().h4(t.update),e.count++}));case"del":return e.byUpdateId[t.id]?i().jM(e,(e=>{delete e.byUpdateId[t.id],e.count--})):e;default:(0,r().HB)(t)}}class a{constructor(e){this.rowTypeUpdateCache=new WeakMap,this.getKey=e}applyUpdates(e,t,s){if(0===s.count||0===t.length)return e;let i;const o=e.slice();let a=!1;const h=e=>{if(!i){i=new Map;for(let e=0;e<o.length;e++){const t=o[e];t&&i.set(this.getKey(t),e)}}return i.get(e)??-1};for(let r=0;r<t.length;r++){var u,d;const e=t[r],p=s.byUpdateId[e];if(!p)continue;let l,y;const w=e=>{const t=h(e),s=this.applyUpdateToRow(o[t],e,p);return-1!==t&&(o[t]=void 0,a=!0),s};null!==(u=p.addStart)&&void 0!==u&&u.length&&(l=p.addStart.map(w)),null!==(d=p.addEnd)&&void 0!==d&&d.length&&(y=p.addEnd.map((e=>{var t;if(null===(t=p.addStart)||void 0===t||!t.includes(e))return w(e)})));for(let t=0;t<o.length;t++){const e=o[t];if(e){const s=this.getKey(e),r=this.applyUpdateToRow(e,s,p);r!==e&&(o[t]=r,a=!0,r||(i=void 0))}}l&&(n(o,l),i=void 0,a=!0),y&&(c(o,y),i=void 0,a=!0)}return a?o.filter(r().O9):e}applyUpdateToRow(e,t,s){var o;let a=this.rowTypeUpdateCache.get(s);if(e&&"object"==typeof e&&null!==(o=a)&&void 0!==o&&o.has(e))return a.get(e);const n=function(e,t,s){const o=s.byRowKey[t];if(!o)return e;switch(o.type){case"put":return o.row;case"patch":return e&&"object"==typeof e?i().$i(e,o.patch):e;case"delete":return;default:(0,r().HB)(o)}}(e,t,s);return e&&n&&n!==e&&"object"==typeof e&&(a||(a=new WeakMap,this.rowTypeUpdateCache.set(s,a)),a.set(e,n)),n}}function n(e,t){if(t.length<5e3)e.unshift(...t);else for(let s=t.length-1;s>=0;s--)e.unshift(t[s])}function c(e,t){if(t.length<5e3)e.push(...t);else for(let s=0;s<t.length;s++)e.push(t[s])}let h=0;class u{constructor(e,t){this.alive=!0,this.queryUpdate={id:"o:composer:query",byRowKey:{},rowTypeName:this.rowType.name,addStart:void 0,addEnd:void 0,count:0},this.rowTypeUpdate={id:"o:composer:rowType",byRowKey:{},rowTypeName:this.rowType.name,addStart:void 0,addEnd:void 0,count:0},this.finalizedUpdates=void 0,this.getKey=e=>this.rowType.getKey(e),this.rowType=e,this.singleton=t}move(e,t){if(this.isSingleton())throw new Error(`Cannot move rows for singleton row type ${this.rowType.name} (there is max one row)`);this.assertAlive();const s=(Array.isArray(t)?t:[t]).map(this.getKey);this.moveKeys(e,s)}add(e,t){if(this.isSingleton())throw new Error(`Cannot add rows for singleton row type ${this.rowType.name} (there is max one row, use setSingleton instead)`);this.assertAlive();const s=(Array.isArray(t)?t:[t]).map((e=>{const t=this.getKey(e);return this.queryUpdate.byRowKey[t]={type:"put",row:e},t}));this.moveKeys(e,s)}remove(e){this.assertAlive();const t=this.getKey(e);this.queryUpdate.byRowKey[t]={type:"delete"},this.queryUpdate.count++}update(e,t){this.assertAlive();const s=this.getKey(e),r=this.rowTypeUpdate.byRowKey[s];if("delete"===(null==r?void 0:r.type))return e;i().YT();const[o,a]=i().vI(e,t),n=this.getKey(o);if(s!==n)throw new Error(`Optimistic update would change row's primary key: ${s} -> ${n}`);var c,h;return this.rowTypeUpdate.byRowKey[s]=(c=this.rowTypeUpdate.byRowKey[s],h={type:"patch",patch:a},"patch"===(null==c?void 0:c.type)&&"patch"===h.type?{type:"patch",patch:c.patch.concat(h.patch)}:"put"===(null==c?void 0:c.type)&&"patch"===h.type?{type:"put",row:i().$i(c.row,h.patch)}:h),this.rowTypeUpdate.count++,o}delete(e){this.assertAlive(),this.rowTypeUpdate.byRowKey[this.getKey(e)]={type:"delete"},this.rowTypeUpdate.count++}setSingleton(e){if(!this.isSingleton())throw new Error(`Cannot set singleton row for non-singleton query ${this.rowType.name} (use add/remove/delete/update instead)`);let t;if(this.assertAlive(),e)t=this.getKey(e);else{if(!(this.rowType instanceof s(288334).Y))throw new Error(`Cannot set singleton row for non-singleton row type ${this.rowType.name} to undefined`);t=this.rowType.getKey()}return e?(this.moveKeys("start",[t]),this.queryUpdate.byRowKey[t]={type:"put",row:e}):(this.queryUpdate.byRowKey[t]={type:"delete"},this.queryUpdate.count++),e}done(){if(this.alive=!1,this.finalizedUpdates)return this.finalizedUpdates;const e=h++;return this.finalizedUpdates={queryUpdate:this.queryUpdate.count>0?{...this.queryUpdate,id:`o:query:${this.rowType.name}:${e}`}:void 0,rowTypeUpdate:this.rowTypeUpdate.count>0?{...this.rowTypeUpdate,id:`o:rowType:${this.rowType.name}:${e}`}:void 0},this.finalizedUpdates}assertAlive(){if(!this.alive)throw new Error(`Cannot perform optimistic updates to row type ${this.rowType.name} after optimistic transaction closed.`)}isSingleton(){return this.singleton||this.rowType.singleton}moveKeys(e,t){"start"===e?(this.queryUpdate.addStart??=[],n(this.queryUpdate.addStart,t)):(this.queryUpdate.addEnd??=[],c(this.queryUpdate.addEnd,t)),this.queryUpdate.count+=t.length}}function d(e,t,s){return i().jM(e,(a=>{switch(t.type){case"put":{const n=o(e.optimistic,t);if(n===e.optimistic)return;if(a.optimistic=i().h4(n),e.output){const r=s.applyUpdates(e.output,[t.update.id],e.optimistic);a.output=i().h4(r)}else e.input&&(a.output=i().h4(s.applyUpdates(e.input,(0,r().uv)(e.optimistic.byUpdateId),e.optimistic)));return}case"del":const n=o(e.optimistic,t);if(n===e.optimistic)return;return a.optimistic=i().h4(n),void(e.input&&e.optimistic.count>0?a.output=i().h4(s.applyUpdates(e.input,(0,r().uv)(n.byUpdateId),n)):a.output=i().h4(e.input));case"rows":return a.input=i().h4(t.rows),void(e.optimistic.count>0?a.output=i().h4(s.applyUpdates(t.rows,(0,r().uv)(e.optimistic.byUpdateId),e.optimistic)):a.output=i().h4(t.rows));default:(0,r().HB)(t)}}))}}}]);