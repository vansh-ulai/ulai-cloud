"use strict";(globalThis.webpackChunknotion_next=globalThis.webpackChunknotion_next||[]).push([[55776],{66529:(e,t,o)=>{o.r(t),o.d(t,{canAcceptAutocompletionsWithoutDot:()=>F,getFormulaEditorInfoAtPosition:()=>I});o(18107),o(944114),o(517642),o(658004),o(733853),o(845876),o(432475),o(515024),o(731698),o(967357),o(898992),o(354520),o(672577),o(803949),o(581454);var n=()=>o(303151),i=()=>o(778078),r=()=>o(763824),c=()=>o(973647),s=()=>o(534177),l=()=>o(510916),p=()=>o(958970),a=()=>o(247331),d=()=>o(106714),u=()=>o(44907),y=()=>o(871202),f=()=>o(93152),m=()=>o(349835),h=()=>o(239381),v=()=>o(628048);async function P(e,t,o){const n=[],i=new Set;if(void 0!==e){const c=t.handleDataRequest({recordPointers:[e]}),l=((0,r().yL)(c)?await c:c).getRecordModel(e),p=null==l?void 0:l.getNormalizedSchema();if(p)for(const[r,d]of Object.entries(p))if(void 0!==(null==d?void 0:d.type)&&(0,s().Xk)(a().FormulaTokenSupportedBlockSystemPropertyList,null==d?void 0:d.type)&&i.add(d.type),r!==t.sourceProperty&&null!=d&&d.name&&a().FORMULAS_SUPPORTED_COLLECTION_PROPERTY_TYPES.includes(null==d?void 0:d.type)&&x(o,d.name)){let o;"cross_space_only"===t.restrictUnaccessibleProperties?o=y().hasSameSpaceAccess:"read_permissions_only"===t.restrictUnaccessibleProperties?o=y().hasReadPermissionsAccess:"cross_space_and_read_permissions"===t.restrictUnaccessibleProperties&&(o=y().hasAccessDefaultFn);(!t.restrictUnaccessibleProperties||!o||await(0,y().hasAccessToProperty)({collectionPointer:e,collectionSchema:p,context:t,propertyId:r,hasAccessFn:o}))&&n.push({kind:a().FormulaEditorInfoCompletionKind.Token,name:d.name,token:{type:a().FormulaTokenType.BlockProperty,property:(0,h().XH)(r),collection:e}})}}for(const r of Object.values(a().FormulaTokenSupportedBlockSystemProperty)){if(i.has(r))continue;const e=(0,l().i)(r);(""===o||x(o,e))&&n.push({kind:a().FormulaEditorInfoCompletionKind.Token,token:{type:a().FormulaTokenType.BlockProperty,property:r,collection:void 0},name:e})}return n}function x(e,t){return""===e||(0,i().It)(e,t)}async function k(e){const{prefix:t,context:o,receiverType:n,includeDeprecatedCompletions:r,dotMemberExpression:c,allowCountFunction:s}=e,l=[],p=[],d=[],u=new Set;if(void 0===n){var y;o.valueTypes.forEach((e=>{if(e.kind===a().FormulaContextValueKind.Binding){const o=e.id;!u.has(o)&&t!==e.id&&x(t,e.id)&&(l.push({kind:a().FormulaEditorInfoCompletionKind.Binding,text:o,type:e.type}),u.add(o))}}));const e=null===(y=o.valueTypes.find((e=>e.kind===a().FormulaContextValueKind.ThisRow)))||void 0===y?void 0:y.type;"block"===(null==e?void 0:e.type)&&void 0!==e.collection&&p.push(...await P(e.collection,o,t)),o.valueTypes.forEach((e=>{if(e.kind===a().FormulaContextValueKind.ContextValue&&x(t,e.name)){const t=(0,h().Bk)(e.id);p.push({kind:a().FormulaEditorInfoCompletionKind.Token,name:e.name,token:{type:a().FormulaTokenType.ContextValue,valueId:t}})}}))}else"block"===n.type&&p.push(...await P(n.collection,o,t));const f=new Map;for(const i in v().LP){var m;if(!u.has(i)&&x(t,i)&&(r||!i.startsWith("_"))&&("count"!==i||s)&&("toNumber"!==i||null==n||!n.type||!v().Qi.includes(n.type))&&(!c||!v().bq.includes(i))&&(null===(m=o.featureGates.formulas_disabled_functions)||void 0===m||!m.includes(i))){const e=v().LP[i];if(void 0!==n){var k,T;const t=(null===(k=e.parameters)||void 0===k||null===(k=k.expected)||void 0===k||null===(k=k[0])||void 0===k?void 0:k.type)??(null===(T=e.parameters)||void 0===T||null===(T=T.varargs)||void 0===T||null===(T=T[0])||void 0===T?void 0:T.type);if(void 0===t||!(0,h().s7)(n,t))continue}const t={kind:a().FormulaEditorInfoCompletionKind.LibraryFunction,libraryFunction:e},o=v().u_[i]||"generic";if("internal"===o)continue;f.has(o)||f.set(o,[]),f.get(o).push(t),u.add(i)}}const A=Array.from(f.keys()).sort(((e,t)=>"generic"===e?-1:"generic"===t?1:e.localeCompare(t)));for(const i of A){const e=f.get(i);d.push(...e)}return[...(0,i().Ay)(t,l,(e=>e.text)),...(0,i().Ay)(t,p,(e=>e.name??"")),...(0,i().Ay)(t,[],(e=>e.builtin)),...(0,i().Ay)(t,d,(e=>e.libraryFunction.name))]}function T(e,t){const o=[...e].reverse().find((e=>e.kind===m().NM.Call));if((null==o?void 0:o.kind)===m().NM.Call){let e=-1;if(t>o.lParenOffset&&(void 0===o.rParenOffset||t<=o.rParenOffset))for(e=0;e<o.commaOffsets.length&&!(o.commaOffsets[e]>t);e++);return{expression:o.expression,parameterIndex:e}}}const A={[a().FormulaEditorInfoCompletionKind.Binding]:0,[a().FormulaEditorInfoCompletionKind.Token]:1,[a().FormulaEditorInfoCompletionKind.Builtin]:2,[a().FormulaEditorInfoCompletionKind.LibraryFunction]:3};function F(e){const{nodeAtPosition:t,dotMemberExpression:o}=e;return!(!o||!t)&&(t.kind===m().NM.NotionToken||t.kind===m().NM.MemberBlockProperty||t.kind===m().NM.Call||t.kind===m().NM.Boolean||t.kind===m().NM.Number||t.kind===m().NM.String||t.kind===m().NM.Array)}async function I(e){var t,o;const{formula:i,inputPosition:r,context:s,includeDeprecatedCompletions:l}=e,[y,P]=(0,d().kb)(i),I=(0,d().NZ)(P,r);let b=y.substring(0,I);const g=b[b.length-1],M=/[\s.]/.test(g);M&&(b=`${b}_`);const _=(0,u().p8)(),C=(0,u().TM)(_).tokenize(b).tokens,N=(0,u()._M)(_);N.input=C;const E=N.expression(),R=(0,p().f)(E);if(c().Q.isFail(R))return{value:void 0};const O=await(0,f()._)(R.value,s,P),{node:w}=O,U=C[C.length-1];let B=!1,D=C;void 0!==U&&(0,n().G)(U,_.IdentifierName)&&(D=[...D],D.pop(),B=!0);const L=N.computeContentAssist("expression",D),K=B?U.image.substring(0,U.image.length-(M?1:0)):void 0,G=(0,h().Kp)(w,I),V=G.at(-1),q={inputPosition:r,mappedPosition:I,nodePath:G,callParameter:T(G,I)};if(C.find((e=>e.tokenType===_.UnclosedStringLiteral)))return q.completions=[],{value:q};const X=[],z=T(G,I),H={handleDataRequest:s.handleDataRequest,restrictUnaccessibleProperties:s.restrictUnaccessibleProperties,sourceProperty:s.sourceProperty,spaceId:s.spaceId,valueTypes:w.valueTypes,featureGates:s.featureGates};let Q;for(let n=1;n<=5;n++){const e=(0,h().Kp)(w,I-n);if(Q=e[e.length-1],void 0!==Q)break}(null===(t=Q)||void 0===t?void 0:t.kind)===m().NM.RecoveryNode&&(Q=void 0);const $=void 0!==Q,j=!Q||Q.kind===m().NM.Unary||Q.kind===m().NM.Equality||Q.kind===m().NM.Identifier,W=!Q||Q.kind===m().NM.Equality||Q.kind===m().NM.Identifier;for(const n of L){var Y,Z,J,ee,te,oe,ne,ie,re;if(n.nextTokenType===_.IdentifierName||n.nextTokenType===_.Dot){const e="dotMemberExpression"===n.ruleStack[n.ruleStack.length-1];if(V&&e){if(V.kind===m().NM.UnifiedFunctionProperty){const t=V.expression;q.completionsInfo={type:"member dot receiver",prefix:K,receiverNode:t};const o=await k({prefix:K??"",context:H,receiverType:t.type,includeDeprecatedCompletions:l,dotMemberExpression:e,allowCountFunction:Boolean(s.featureGates.formulas_count_function)});X.push(...o)}else if(F({nodeAtPosition:V,dotMemberExpression:e})){q.completionsInfo={type:"member dot receiver",prefix:K,receiverNode:V};const t=await k({prefix:K??"",context:H,receiverType:V.type,includeDeprecatedCompletions:l,dotMemberExpression:e,allowCountFunction:Boolean(s.featureGates.formulas_count_function)});X.push(...t)}}else{q.completionsInfo={type:"free identifier",prefix:K};const t=await k({prefix:K??"",context:H,includeDeprecatedCompletions:l,dotMemberExpression:e,allowCountFunction:Boolean(s.featureGates.formulas_count_function)});if(X.push(...t),z&&(z.expression.kind===m().NM.UnifiedFunctionProperty&&0===z.parameterIndex||z.expression.kind===m().NM.Identifier&&1===z.parameterIndex)){const e=z.expression.kind===m().NM.UnifiedFunctionProperty?z.expression.name:z.expression.text,t=v().LP[e];if(((null==t?void 0:t.parameters)===v().Ux||(null==t?void 0:t.parameters)===v().MB)&&x(K??"",a().CURRENT_VALUE_NAME)&&K!==a().CURRENT_VALUE_NAME&&K!==`${a().CURRENT_VALUE_NAME}.`){var ce,se;const e=z.expression,t="function"===e.type.type&&"array"===(null===(ce=e.type.boundTargetType)||void 0===ce?void 0:ce.type)&&(null===(se=e.type.boundTargetType)||void 0===se?void 0:se.of)||{type:"unknown"};X.push({kind:a().FormulaEditorInfoCompletionKind.Binding,text:a().CURRENT_VALUE_NAME,type:t}),X.push({kind:a().FormulaEditorInfoCompletionKind.Binding,text:a().CURRENT_INDEX_NAME,type:{type:"number"}})}}}}else if(n.nextTokenType===_.AdditionOperator&&$&&(null==V?void 0:V.type.type)!==m().NM.Array&&"text"===(null===(Y=Q)||void 0===Y?void 0:Y.type.type)){const e=S(["+"],K??"");X.push(...e)}else if(n.nextTokenType===_.AdditionOperator&&$&&(null==V?void 0:V.type.type)!==m().NM.Array&&"number"===(null===(Z=Q)||void 0===Z?void 0:Z.type.type)){const e=S(["+","-"],K??"");X.push(...e)}else if(n.nextTokenType===_.MultiplicationOperator&&$&&(null==V?void 0:V.type.type)!==m().NM.Array&&"number"===(null===(J=Q)||void 0===J?void 0:J.type.type)){const e=S(["*","/"],K??"");X.push(...e)}else if(n.nextTokenType!==_.RelationalOperator||!$||(null==V?void 0:V.type.type)===m().NM.Array||"number"!==(null===(ee=Q)||void 0===ee?void 0:ee.type.type)&&"text"!==(null===(te=Q)||void 0===te?void 0:te.type.type)&&"date"!==(null===(oe=Q)||void 0===oe?void 0:oe.type.type)){if(n.nextTokenType===_.EqualityOperator&&$&&null!==(ne=Q)&&void 0!==ne&&ne.type.type&&"unknown"!==(null===(ie=Q)||void 0===ie?void 0:ie.type.type)){const e=S(["==","!="],K??"");X.push(...e)}else if(n.nextTokenType===_.BooleanLiteral&&j){const e=S(["true","false"],K??"");X.push(...e)}else if(n.nextTokenType===_.And&&$&&"checkbox"===(null===(re=Q)||void 0===re?void 0:re.type.type)){const e=S(["and","or"],K??"");X.push(...e)}else if(n.nextTokenType===_.UnaryOperator&&W){const e=S(["not"],K??"");X.push(...e)}}else{const e=S([">",">=","<","<="],K??"");X.push(...e)}}const le=null===(o=C[C.length-1])||void 0===o?void 0:o.tokenType;if(0===X.length&&le===_.IdentifierName){const e=C.slice(-4).reverse(),t=[];for(let n=0;n<e.length;n++){var pe;if((null===(pe=e[n])||void 0===pe?void 0:pe.tokenType)!==_.IdentifierName)break;const o=B?e[n].image.substring(0,e[n].image.length-(M?1:0)):void 0;void 0!==o&&(0===n?t.push(o):t.push(o+t[n-1]))}let o=[];for(let n=1;n<t.length;n++){const e=t[n],i=await k({prefix:e.trim(),context:H,includeDeprecatedCompletions:l,dotMemberExpression:!1,allowCountFunction:Boolean(s.featureGates.formulas_count_function)});if(i.length>0){o=i.map((t=>({...t,overridePrefixLength:e.length+n})))}}X.push(...o)}return q.completions=X.sort(((e,t)=>{const o=e.kind,n=t.kind;return A[o]-A[n]})),{value:q}}function S(e,t){return e.filter((e=>x(t,e))).map((e=>({kind:a().FormulaEditorInfoCompletionKind.Builtin,builtin:e})))}},871202:(e,t,o)=>{o.r(t),o.d(t,{hasAccessDefaultFn:()=>P,hasAccessToCode:()=>A,hasAccessToProperty:()=>T,hasReadPermissionsAccess:()=>x,hasSameSpaceAccess:()=>k,testOnly:()=>F});o(517642),o(658004),o(733853),o(845876),o(432475),o(515024),o(731698),o(898992),o(354520);var n=()=>o(496603),i=()=>o(763824),r=()=>o(973647),c=()=>o(534177),s=()=>o(898244),l=()=>o(247331),p=()=>o(443881),a=()=>o(239381),d=()=>o(501053),u=()=>o(373907);function*y(e){const{collectionPointer:t,context:o,propertyId:n,propertySchema:i,visitedPointers:r,hasAccessFn:c}=e,s=(0,p().G7)({...t,propertyId:n});if(r.has(s))return!0;r.add(s);const l=c({propertySchema:i,spaceId:o.spaceId});return"boolean"==typeof l?l:yield*l}function*f(e){var t,o;const{collectionPointer:i,depth:d,collectionSchema:y,context:f,propertyId:m,propertySchema:h,visitedPointers:P,hasAccessFn:x}=e;if("v2"!==h.version||d>l().FORMULA_MAX_DEPTH)return!1;const k=(0,p().G7)({...i,propertyId:m});if(P.has(k))return!0;if(P.add(k),!(0,c().O9)(null===(t=h.formula2)||void 0===t?void 0:t.code))return!0;const T=(0,u().$t)(null===(o=h.formula2)||void 0===o?void 0:o.code);if(r().Q.isFail(T))return!0;const{spaceId:A}=f,F=(0,p().zm)({formulaTypecheckContextValues:[{kind:l().FormulaContextValueKind.ThisRow,type:{collection:i,type:"block"}}],node:T.value,spaceId:A}),I=(0,n().hS)(F,(e=>(0,p().G7)(e)));if(0===I.length)return!0;const{getRecordModel:S}=yield{collectionBlockProperties:[{blockPointers:[],collectionPointer:i,property:m,schema:y}],recordPointers:I.filter((e=>(0,a().T3)(e)))};for(const n of I)if((0,s().pq)(n)){const e=S(n);if(!(0,c().O9)(e))return!1;const t=n.propertyId,o=e.getSchema(),i=o[t];if(!i)continue;if((0,s().bT)(i)||(0,s().lb)(i)){if(!(yield*v({collectionPointer:n,collectionSchema:o,context:f,depth:d+1,propertyId:t,propertySchema:i,visitedPointers:P,hasAccessFn:x})))return!1}else if((0,s().nC)(i)){if(!(yield*v({collectionPointer:n,collectionSchema:o,context:f,depth:d,propertyId:t,propertySchema:i,visitedPointers:P,hasAccessFn:x})))return!1}}else if(!(0,c().O9)(S(n)))return!1;return!0}function*m(e){const{collectionPointer:t,depth:o,collectionSchema:n,context:i,propertyId:r,propertySchema:c,visitedPointers:a,hasAccessFn:u}=e;if("v2"===c.version||o>l().FORMULA_MAX_DEPTH)return!1;const y=(0,p().G7)({...t,propertyId:r});if(a.has(y))return!0;a.add(y);const f=(0,d().kh)(c.formula);if(0===f.length)return!0;for(const l of f){const e=n[l];if(e)if((0,s().bT)(e)||(0,s().lb)(e)){if(!(yield*v({collectionPointer:t,depth:o+1,collectionSchema:n,context:i,propertyId:l,propertySchema:e,visitedPointers:a,hasAccessFn:u})))return!1}else if((0,s().nC)(e)){if(!(yield*v({collectionPointer:t,collectionSchema:n,context:i,depth:o,propertyId:l,propertySchema:e,visitedPointers:a,hasAccessFn:u})))return!1}}return!0}function*h(e){const{collectionPointer:t,depth:o,collectionSchema:n,context:i,propertyId:r,propertySchema:c,visitedPointers:a,hasAccessFn:d}=e;if(o>l().FORMULA_MAX_DEPTH)return!1;const u=(0,p().G7)({...t,propertyId:r});if(a.has(u))return!0;if(a.add(u),!c.relation_property||!c.target_property)return!0;const y=n[c.relation_property];if(!y||"relation"!==y.type)return!0;const f=d({propertySchema:y,spaceId:i.spaceId});if(!("boolean"==typeof f?f:yield*f))return!1;const m=(0,s().Nv)(y);if(!m)return!0;const{getRecordModel:h}=yield{recordPointers:[m]},P=h(m),x=null==P?void 0:P.getNormalizedSchema();if(c.target_property_type&&x){const e=x[c.target_property];if(e&&c.target_property_type===e.type){if((0,s().lb)(e))return yield*v({collectionPointer:m,collectionSchema:x,context:i,depth:o+1,propertyId:c.target_property,propertySchema:e,visitedPointers:a,hasAccessFn:d});if((0,s().nC)(e))return yield*v({collectionPointer:m,collectionSchema:x,context:i,depth:o,propertyId:c.target_property,propertySchema:e,visitedPointers:a,hasAccessFn:d})}}return!0}function*v(e){const{collectionPointer:t,depth:o,collectionSchema:n,context:i,propertyId:r,propertySchema:c,visitedPointers:l,hasAccessFn:p}=e;return(0,s().nC)(c)?yield*y({collectionPointer:t,context:i,propertyId:r,propertySchema:c,visitedPointers:l,hasAccessFn:p}):(0,s().lb)(c)?"v2"===c.version?yield*f({collectionPointer:t,depth:o,collectionSchema:n,context:i,propertyId:r,propertySchema:c,visitedPointers:l,hasAccessFn:p}):yield*m({collectionPointer:t,depth:o,collectionSchema:n,context:i,propertyId:r,propertySchema:c,visitedPointers:l,hasAccessFn:p}):!(0,s().bT)(c)||(yield*h({collectionPointer:t,depth:o,collectionSchema:n,context:i,propertyId:r,propertySchema:c,visitedPointers:l,hasAccessFn:p}))}function*P(e){const{propertySchema:t,spaceId:o}=e,n=(0,s().Nv)(t);if(!(0,c().O9)(n))return!0;const{getRecordModel:i}=yield{recordPointers:[n]},r=i(n);return(0,c().O9)(r)&&k({spaceId:o,propertySchema:t})}function*x(e){const{propertySchema:t}=e,o=(0,s().Nv)(t);if(!(0,c().O9)(o))return!0;const{getRecordModel:n}=yield{recordPointers:[o]},i=n(o);return(0,c().O9)(i)}function k(e){const{propertySchema:t,spaceId:o}=e;return!(0,s().o2)(o,t)}async function T(e){const{collectionPointer:t,collectionSchema:o,context:n,propertyId:r,hasAccessFn:c}=e,s=o[r];return!s||await async function(e){const{context:t}=e;try{const o=v(e);let n=o.next();for(;!n.done;){const e=t.handleDataRequest(n.value);n=o.next((0,i().yL)(e)?await e:e)}return n.value}catch(o){return!0}}({collectionPointer:t,depth:0,collectionSchema:o,context:n,propertyId:r,propertySchema:s,visitedPointers:new Set,hasAccessFn:c})}function A(e){const{context:t}=e;try{const o=function*(e){const{collectionPointer:t,depth:o,context:i,code:d,visitedPointers:y,hasAccessFn:f}=e,m=(0,u().$t)(d);if(r().Q.isFail(m))return!0;const{spaceId:h}=i,P=i.valueTypes.filter((e=>e.kind!==l().FormulaContextValueKind.ThisRow)),x=(0,p().zm)({formulaTypecheckContextValues:t?[...P,{kind:l().FormulaContextValueKind.ThisRow,type:{collection:t,type:"block"}}]:[],node:m.value,spaceId:h}),k=(0,n().hS)(x,(e=>(0,p().G7)(e)));if(0===k.length)return!0;const{getRecordModel:T}=yield{collectionBlockProperties:[],recordPointers:k.filter((e=>(0,a().T3)(e)))};for(const n of k)if((0,s().pq)(n)){const e=T(n);if(!(0,c().O9)(e))return!1;const t=n.propertyId,r=e.getSchema(),l=r[t];if(!l)continue;if((0,s().bT)(l)||(0,s().lb)(l)){if(!(yield*v({collectionPointer:n,collectionSchema:r,context:i,depth:o+1,propertyId:t,propertySchema:l,visitedPointers:y,hasAccessFn:f})))return!1}else if((0,s().nC)(l)&&!(yield*v({collectionPointer:n,collectionSchema:r,context:i,depth:o,propertyId:t,propertySchema:l,visitedPointers:y,hasAccessFn:f})))return!1}else if(!(0,c().O9)(T(n)))return!1;return!0}(e);let i=o.next();for(;!i.done;){const e=t.handleDataRequest(i.value);i=o.next(e)}return i.value}catch(o){return!0}}const F={hasAccessDefaultFn:P,hasAccessToProperty:T,hasAccessToFormula1Property:m,hasAccessToFormula2Property:f,hasAccessToRelationProperty:y,hasAccessToRollupProperty:h}}}]);