"use strict";(globalThis.webpackChunknotion_next=globalThis.webpackChunknotion_next||[]).push([[45147],{383559:(e,t,o)=>{o.d(t,{Ls:()=>Y,Or:()=>Q,Pu:()=>J,cA:()=>ee,ww:()=>K,Io:()=>$,$K:()=>L});o(16280),o(944114),o(898992),o(354520),o(672577),o(803949),o(581454);var r=()=>o(726637),i=()=>o(66689),n=()=>o(901610),a=()=>o(581793),l=()=>o(564787),c=()=>o(62371),p=()=>o(898244),s=()=>o(713998),d=()=>o(617871),u=()=>o(651124),f=()=>o(443881),v=()=>o(388693),m=()=>o(179034),g=()=>o(519831),_=()=>o(869558),y=()=>o(332393),S=()=>o(96689),b=()=>o(854150),w=()=>o(798880),h=()=>o(201980),C=()=>o(496603),k=()=>o(534177),B=()=>o(803074),V=()=>o(896628),P=()=>o(722101),U=()=>o(44729),I=()=>o(384944),M=()=>o(185544),F=()=>o(955930),E=()=>o(272600),T=()=>o(496592),z=()=>o(254497),A=()=>o(312296),R=()=>o(177618),O=()=>o(586481),N=()=>o(852353),x=()=>o(53137),D=()=>o(148832),W=()=>o(543665),q=()=>o(913530),X=()=>o(524757),H=()=>o(214388);function j(e,t){if((0,H().yX)(e))return null!=t&&t[e.property]?{...e,property:t[e.property]}:e;if((0,H().LB)(e))return e;if((0,H().dU)(e)){if(e.filters){const o=[];for(const r of e.filters){const e=j(r,t);if(!e)throw new Error("Invalid filter");o.push(e)}return{operator:e.operator,filters:o}}}else(0,k().HB)(e)}function K(e){var t,o,r,a,p,s,d,f,v,m,g,y,S,b,w;const{environment:h,collectionStore:B,collectionViewBlockStore:V,dependency:U,blockUriMap:M,transaction:F}=e,E=M[U.uri];if(E){const e=q().p.createChildStore(V,{table:_().Gy,id:E,spaceId:V.getSpaceId()});return I().zv({store:e,data:{alive:!0,parent_id:V.id,parent_table:V.table},transaction:F}),P().BC({parentStore:V.getCollectionViewsStore(),appendStore:e,transaction:F}),M}const T=B.getPropertyMapping(),z=te(null===(t=U.value.format)||void 0===t?void 0:t.collection_group_by,B),A=te(null===(o=U.value.format)||void 0===o?void 0:o.board_columns_by,B),R=oe(null===(r=U.value.format)||void 0===r?void 0:r.board_columns,B),O=function(e,t){if(!e||"placeholder"===e.type)return;const o=C().mg(e);if("groups_reducer"===o.dataConfig.type){var r;const e=o.dataConfig.groupBy.property;o.dataConfig.groupBy.property=t.getMappedProperty(e);const i=o.dataConfig.aggregationConfig.aggregation.property;i&&(o.dataConfig.aggregationConfig.aggregation.property=t.getMappedProperty(i));const a=(0,n().m)(o)?null===(r=o.dataConfig.aggregationConfig.stackOptions)||void 0===r?void 0:r.groupBy.property:void 0;(0,n().m)(o)&&a&&o.dataConfig.aggregationConfig.stackOptions&&(o.dataConfig.aggregationConfig.stackOptions.groupBy.property=t.getMappedProperty(a))}else{const e=o.dataConfig.nameProperty;o.dataConfig.nameProperty=t.getMappedProperty(e);const r=o.dataConfig.valueProperty;o.dataConfig.valueProperty=t.getMappedProperty(r)}return o}(null===(a=U.value.format)||void 0===a?void 0:a.chart_config,B),N=null==T?void 0:T[i().yx.SubTaskRelation],x=null==T?void 0:T[i().yx.BlockingRelation],D=U.value.type,W=D?(0,u().u9)(D):void 0,X=W?null===(p=U.value.format)||void 0===p?void 0:p[W]:void 0,H=W?{[W]:oe(X,B)}:{},K=oe(null===(s=U.value.format)||void 0===s?void 0:s.board_properties,B),$=oe(null===(d=U.value.format)||void 0===d?void 0:d.table_properties,B);if(N&&!(0,l().qS)(D)&&W){var L;const e=null===(L=H[W])||void 0===L?void 0:L.findIndex((e=>e.property===N)),t=H[W];t&&(!e||e<0?t.push({property:N,visible:!0}):t[e].visible=!0)}const G={...U.value.format,collection_group_by:z,board_columns_by:A,board_columns:R,board_properties:K,table_properties:$,chart_config:O,property_filters:null===(f=U.value.format)||void 0===f||null===(f=f.property_filters)||void 0===f?void 0:f.map((({id:e,filter:t})=>{const{filter:o}=t;if("relation_contains"===o.operator){const r=(Array.isArray(o.value)?o.value:[o.value]).map((e=>{const t=e.type;if("relative"===t)return e;if("exact"===t){const t=e.value,o=t&&M[t];return o?{...e,value:o}:e}(0,k().HB)(t)}));return{id:e,filter:re({property:t.property,filter:{operator:o.operator,value:r}},B)}}return{id:e,filter:re(t,B)}})),collection_groups:null===(v=U.value.format)||void 0===v||null===(v=v.collection_groups)||void 0===v?void 0:v.map((e=>"relation"===e.value.type&&e.value.value&&!(0,c().zx)(e.value.value)&&M[e.value.value.id]?{...e,value:{type:"relation",value:{id:M[e.value.value.id],table:"block",spaceId:B.getSpaceId()}}}:e)),...H,table_subitem_toggle_column:"title",...x?{timeline_arrows_by:{property:x}}:{}},J=C().oE(null===(m=U.value.page_sort)||void 0===m?void 0:m.map((e=>M[e]))),Y=null===(g=U.value.query2)||void 0===g||null===(g=g.aggregations)||void 0===g?void 0:g.map((e=>e.property?{...e,property:(null==T?void 0:T[e.property])??e.property}:e)),Q=oe(null===(y=U.value.query2)||void 0===y?void 0:y.sort,B),Z=null===(S=U.value.query2)||void 0===S?void 0:S.timeline_by,ee=Z?B.getMappedProperty(Z):void 0,ie=null===(b=U.value.query2)||void 0===b?void 0:b.calendar_by,ne=ie?B.getMappedProperty(ie):void 0,ae=null===(w=U.value.query2)||void 0===w?void 0:w.filter,le=ae?function(e,t){const o=[];if(e.filters)for(const r of e.filters){const e=j(r,t);if(!e)throw new Error("Invalid filter");o.push(e)}return{...e,filters:o}}(ae,T):void 0,ce=I().eC({environment:h,table:_().Gy,inMemoryRecordCache:V.inMemoryRecordCache,value:{...U.value,parent_id:V.id,parent_table:V.table,space_id:V.getSpaceId(),format:{...G,app_config_uri:U.uri,collection_pointer:B.pointer},query2:{...U.value.query2,filter:le,aggregations:Y,sort:Q,timeline_by:ee,calendar_by:ne},page_sort:J,alive:!0},transaction:F});M[U.uri]=ce.id;const pe=q().p.createChildStore(V,ce.pointer);return P().BC({parentStore:V.getCollectionViewsStore(),appendStore:pe,transaction:F}),M}function $(e){var t;const{environment:o,collectionStore:i,dependency:n,allFeatures:a,blockUriMap:l,transaction:c,customPropertyName:s}=e;let u=n.propertySchema;if("relation"===u.type){const e=(0,p().Nv)(u);if(!e)throw new Error("Invalid relation schema.");const t=l[e.id];if(!t)throw new Error("Relation target collection not found");const r=i.getDeletedSchema(),a=r[n.uri],s=a&&(0,p().UU)(a)?(0,p().Nv)(a):void 0;if(n.isConnectedRelation&&n.integrationId===d().ob&&s){const e=R().KA({deletedSchema:r,property:n.uri});if(!e)throw new Error("Deleted property schema was not found");(0,A().F)({environment:o,collectionStore:i,update:e.updateSchema,transaction:c}),(0,z().E)({collectionStore:i,update:e.updateDeletedSchema,transaction:c}),u={...u,collection_pointer:s,collection_id:s.id}}else u={...u,collection_pointer:{id:t,table:g().Vl,spaceId:i.getSpaceId()},collection_id:t}}else if("select"===u.type){const e=i.getSchema()[n.uri];if(e&&"select"===e.type){var v;const t=(0,X().r)([n.uri],a),o=C().Bq(C().oE(t.map((e=>{var t;if("property"===e.type&&"select"===e.propertySchema.type)return null===(t=e.propertySchema.options)||void 0===t?void 0:t.map((e=>e.id))})))),r=(null===(v=e.options)||void 0===v?void 0:v.filter((e=>!o.includes(e.id))))||[];u={...u,options:[...u.options||[],...r]}}}else if("auto_increment_id"===u.type){const e=i.getSchema(),t=(0,k().WP)(e).find((e=>{var t;const o=e[0],r=null===(t=e[1])||void 0===t?void 0:t.type;return o&&r&&"auto_increment_id"===r}));if(t){var m;const e=t[0];return V().zA({stores:[i],update:{app_uri_map:{...null===(m=i.getFormat())||void 0===m?void 0:m.app_uri_map,[n.uri]:e}},transaction:c}),n.uri}}else if("text"===u.type)u.ai_inference&&u.ai_inference.auto_update_on_edit&&(u.ai_inference.auto_update_on_edit=(0,N().hn)({environment:o,userId:o.currentUser.id,spaceId:i.getSpaceId()}));else if("rollup"===u.type){if(!u.relation_property||!u.target_property)throw new Error("Invalid rollup schema.");const e=i.getSchema()[u.relation_property];if(!e||"relation"!==e.type)throw new Error("Invalid rollup schema.");const t=(0,p().Nv)(e);if(!t)throw new Error("Invalid rollup schema. Missing target collection pointer.");const o=i.getParentStore();if(!o)throw new Error("Undefined parent store.");const r=W().m.createChildStore(o,t);if(!r)throw new Error("Relation target collection not found");const n=r.getMappedProperty(u.target_property);n&&(u.target_property=n)}else if("formula"===u.type&&"v2"===u.version&&u.formula2){const{value:e}=(0,f().RI)({baseUrl:r().A.domainBaseUrl,formula:u.formula2.code,publicDomainName:r().A.publicDomainName,spaceId:i.getSpaceId(),visitors:{visitFormulaContextValue:void 0,visitFormulaPageProperty:e=>{var t;return"collection"in e&&(null===(t=e.collection)||void 0===t?void 0:t.id)===n.collectionUri?{type:"replace",value:{...e,collection:i.pointer}}:{type:"keep"}},visitRecordPointer:void 0}});u.formula2.code=e}s&&s.length>0&&(u={...u,name:s}),(0,A().F)({environment:o,collectionStore:i,update:{[n.uri]:u},transaction:c}),V().zA({stores:[i],update:{app_uri_map:{...null===(t=i.getFormat())||void 0===t?void 0:t.app_uri_map,[n.uri]:n.uri}},transaction:c})}function L(e,t,o,r,i,n,l,c){const d=[...r.filter((({type:e})=>"collection_view_block"===e)),...r.filter((({type:e})=>"collection"===e)),...r.filter((({type:e})=>"sub_external_collection"===e)),...r.filter((({type:e})=>"property"===e)),...r.filter((({type:e})=>"database_template"===e)),...r.filter((({type:e})=>"block"===e)),...r.filter((({type:e})=>"collection_view"===e))],u=o.table===S().NX?o.id:o.getSpaceId(),f=o.table===S().NX?o:o.getSpaceStore();if(u&&f){for(const r of d)if("collection_view_block"===r.type){const n=i[r.uri];if(n){var _;const r=D().B.createChildStore(o,{table:m().ev,id:n,spaceId:u});null!==(_=ee(t,o,r))&&void 0!==_&&null!==(_=_.getValue())&&void 0!==_&&_.includes(r.id)||Y(e,t,o,r,l,"append"),I().zv({store:r,data:{parent_id:o.id,parent_table:o.table,alive:!0},transaction:l})}else{const n=I().Wv({environment:e,inMemoryRecordCache:o.inMemoryRecordCache,type:o.table===m().ev&&"app_container"===o.getFormat().collection_view_sub_type?"collection_view":"collection_view_page",spaceId:u,format:{app_config_uri:r.uri,page_icon:r.icon,page_cover:r.cover},properties:{title:(0,h().x9d)(r.name)},transaction:l});I().zv({store:n,data:{parent_id:o.id,parent_table:o.table,alive:!0},transaction:l}),i[r.uri]=n.id;Y(e,t,o,D().B.createChildStore(o,n.pointer),l,"append")}}else if("collection"===r.type){const t=Q(o,r.collectionViewBlockUri,i);if(!t)throw new Error("SubViewBlockStore not found");const n=t.getOwnedCollectionStores();for(const e of n)(0,T().removeCollectionFromCollectionViewBlock)({collectionViewBlockStore:t,collectionStore:e,transaction:l});const a=i[r.uri];if(a){const e=W().m.createChildStore(o,{table:g().Vl,id:a,spaceId:u});(0,E().p)({collectionViewBlockStore:t,collectionPointer:e.pointer,transaction:l}),I().zv({store:e,data:{alive:!0,parent_id:t.id,parent_table:t.table},transaction:l})}else{const o=I().eC({environment:e,table:g().Vl,inMemoryRecordCache:t.inMemoryRecordCache,value:{...r.value,parent_id:t.id,parent_table:t.table,space_id:t.getSpaceId(),format:{app_config_uri:r.uri,app_uri_map:Object.fromEntries(Object.keys(r.value.schema??{}).filter((e=>e.startsWith("notion://"))).map((e=>[e,e]))),...r.value.format},alive:!0},transaction:l});i[r.uri]=o.id;const n=W().m.createChildStore(t,o.pointer);(0,E().p)({collectionViewBlockStore:t,collectionPointer:n.pointer,transaction:l})}}else if("sub_external_collection"===r.type){const t=x().A.getIntegrationsAsRecordMap().getModel({table:y().Li,id:r.integrationId});if(!t||!(0,v().v_)(t))throw new Error("Invalid integration");const n=J(o,r.parentCollectionUri,i);if(!n)throw new Error("Unable to find parent collection store");const a=n.getDeletedSchema()[r.relationUri],c=a&&(0,p().UU)(a)?(0,p().zO)(a):void 0;if(a&&(0,p().UU)(a)&&c){i[r.uri]=c;continue}const s=B().qM({environment:e,pattern:r.pattern,integration:t,parentCollectionStore:n,transaction:l});i[r.uri]=s.id}else if("property"===r.type)G({environment:e,appConfig:n,appParentStore:o,dependency:r,uriMap:i,transaction:l,customPropertyName:c});else if("collection_view"===r.type){const t="block"===o.table&&o.getFormat().app_config_uri===r.collectionViewBlockUri?o:Q(o,r.collectionViewBlockUri,i);if(!t)throw new Error("View's home block not found");const n=J(o,r.collectionUri,i);if(!n)throw new Error("View source collection not found");i=K({environment:e,collectionStore:n,collectionViewBlockStore:t,dependency:r,blockUriMap:i,transaction:l})}else if("database_template"===r.type){const t=J(o,r.collectionUri,i);if(!t)throw new Error("Collection not found");const n=t.getTemplatePagesStore(),a=i[r.uri];if(a){const e=D().B.createChildStore(t,{table:m().ev,id:a,spaceId:t.getSpaceId()});I().zv({store:e,data:{alive:!0,parent_id:t.id,parent_table:t.table,is_template:!0},transaction:l}),P().BC({parentStore:n,appendStore:e,transaction:l}),r.isDefault&&V().zA({stores:[t],update:{collection_default_template:{template_page_id:e.id}},transaction:l})}else{const a=I().Wv({environment:e,inMemoryRecordCache:o.inMemoryRecordCache,type:r.blockValue.type,spaceId:t.getSpaceId(),properties:r.blockValue.properties,format:{...r.blockValue.format,app_config_uri:r.uri},transaction:l});I().zv({store:a,data:{parent_id:t.id,parent_table:t.table,alive:!0,is_template:!0},transaction:l}),i[r.uri]=a.id,P().BC({parentStore:n,appendStore:a,transaction:l}),r.isDefault&&V().zA({stores:[t],update:{collection_default_template:{template_page_id:a.id}},transaction:l})}}else"block"===r.type?Z(e,o,r,i,l):"page_template"===r.type||(0,k().HB)(r);!function(e,t,o,r,i){for(const n of o){const o=Q(t,n.uri,r),l=null==o?void 0:o.getParentStore();if(!o||!l||"collection"!==l.table||!n.blockValue.properties)continue;const c={};Object.entries(n.blockValue.properties).forEach((([o,i])=>{var n,p;if("relation"===(null===(n=l.getSchema()[o])||void 0===n?void 0:n.type)){const e=(0,s().n)(i),n=C().oE(e.map((e=>{const o=r[e.id];if(o)return{table:m().ev,id:o,spaceId:t.table===S().NX?t.id:t.getSpaceId()}}))),a=(0,s().Ap)(n);c[o]=a}else"person"===(null===(p=l.getSchema()[o])||void 0===p?void 0:p.type)&&e.currentUser.id?c[o]=(0,a().h)([{table:w().oo,id:e.currentUser.id}]):c[o]=i})),O().L({environment:e,store:o,properties:c,transaction:i})}}(e,o,r.filter((({type:e})=>"block"===e)),i,l)}}function G(e){const{environment:t,transaction:o,appParentStore:r,dependency:i,uriMap:n,appConfig:a,customPropertyName:l}=e,c=J(r,i.collectionUri,n);if(!c)throw new Error("Collection not found");$({environment:t,collectionStore:c,dependency:i,blockUriMap:n,allFeatures:a.allFeatures,transaction:o,customPropertyName:l})}function J(e,t,o){return o[t]?W().m.createChildStore(e,{table:g().Vl,id:o[t],spaceId:e.table===S().NX?e.id:e.getSpaceId()}):void 0}function Y(e,t,o,r,i,n){if(o.table===m().ev);else if(o.table===S().NX){if((null==t?void 0:t.getSpaceId())!==o.id)return;M().yM({environment:e,spaceStore:o,spaceViewStore:t,pageStore:r,isPrivate:!0,transaction:i})}else o.table===b().yK?F().sP({teamStore:o,store:r,transaction:i,location:{type:n}}):(0,k().HB)(o)}function Q(e,t,o){return o[t]?D().B.createChildStore(e,{table:m().ev,id:o[t],spaceId:e.table===S().NX?e.id:e.getSpaceId()}):void 0}function Z(e,t,o,r,i){let n=Q(t,o.uri,r);const a="collection"===o.parentType?J(t,o.parentUri,r):Q(t,o.parentUri,r);if(!a)return{blockStore:n,parentStore:void 0};if(n)I().zv({store:n,data:{parent_id:a.id,parent_table:a.table,alive:!0},transaction:i});else{const l=t.table===S().NX?t.id:t.getSpaceId(),c=t.table===S().NX?t:t.getSpaceStore();if(!l||!c)return;const p=I().Wv({environment:e,type:o.blockValue.type,spaceId:l,format:{...o.blockValue.format,app_config_uri:o.uri},properties:o.blockValue.properties,inMemoryRecordCache:t.inMemoryRecordCache,transaction:i});I().zv({store:p,data:{parent_id:a.id,parent_table:a.table,alive:!0},transaction:i}),n=D().B.createChildStore(a,p.pointer),r[o.uri]=p.pointer.id}return"block"===a.table?U().NI({parentStore:a,childStore:n,transaction:i}):"collection"===a.table?U().X$({parentStore:a,childStore:n,transaction:i}):(0,k().HB)(a),{blockStore:n,parentStore:a}}function ee(e,t,o){if(t.table===b().yK)return t.getTeamPagesStore();if(t.table===S().NX){var r,i;if(null!==(r=e.getPrivatePagesStore().getValue())&&void 0!==r&&r.includes(o.id))return e.getPrivatePagesStore();if(null!==(i=e.getSharedPagesStore().getValue())&&void 0!==i&&i.includes(o.id))return e.getSharedPagesStore()}else{if(t.table===m().ev)return t.getContentStore();(0,k().HB)(t)}}function te(e,t){if(e)return re(e,t)}function oe(e,t){if(e)return e.map((e=>re(e,t)))}function re(e,t){const o=t.getMappedProperty(e.property);return o?{...e,property:o}:e}},845147:(e,t,o)=>{o.r(t),o.d(t,{applyPresetFeatures:()=>j,applyTypedFeatures:()=>$,initializeApp:()=>X,installAppsInTeam:()=>Q,markTasksDatabaseTemplateIfNeeded:()=>q,removeTypedDependencies:()=>Y});o(16280),o(944114),o(517642),o(658004),o(733853),o(845876),o(432475),o(515024),o(731698),o(898992),o(354520),o(672577),o(430670),o(803949),o(581454),o(737550);var r=()=>o(564884),i=()=>o(584262),n=()=>o(66689),a=()=>o(700500),l=()=>o(716016),c=()=>o(898244),p=()=>o(165358),s=()=>o(206267),d=()=>o(869558),u=()=>o(201980),f=()=>o(496603),v=()=>o(229833),m=()=>o(534177),g=()=>o(160568),_=()=>o(175213),y=()=>o(559506),S=()=>o(84448),b=()=>o(873039),w=()=>o(901389),h=()=>o(896628),C=()=>o(722101),k=()=>o(384944),B=()=>o(857783),V=()=>o(319975),P=()=>o(231297),U=()=>o(39758),I=()=>o(414360),M=()=>o(496592),F=()=>o(972435),E=()=>o(148832),T=()=>o(913530),z=()=>o(413955),A=()=>o(553003);function R(e,t){const o=[];for(const i of t)"property"===i.type||"database_template"===i.type?e.has(i.collectionUri)&&o.push(i):"block"===i.type?e.has(i.parentUri)&&o.push(i):"collection"!==i.type&&"collection_view"!==i.type||e.has(i.collectionViewBlockUri)&&o.push(i);let r=[];return o.length>0&&(r=R(new Set(o.map((e=>e.uri))),t)),[...o,...r]}var O=()=>o(599513);function N(e,t){const o=(0,A().B)(e,t.uri);if(!o)return[];return[...t.requiredFeatures,...t.defaultOnFeatures].filter((e=>{const t=o.allFeatures.find((t=>t.uri===e.featureUri));if(!t)return!1;const{type:r}=e;return"simple"===r?"dependencies"in t:"with_variant"===r?"variants"in t:void(0,m().HB)(r)}))}var x=()=>o(652079);var D=()=>o(383559);const W=(0,o(69708).YK)({initializeAppTemplateError:{id:"appTemplateActions.initializeAppTemplateError.message",defaultMessage:"Duplicate template failed."}});function q(e){e&&e.some((e=>e.getFormat().app_config_uri===n().d0))&&(U().e.locallyMutatedTasksDatabase=!0)}function X(e){const{environment:t,temporaryContainerBlockStore:o,transaction:r,skipNavigation:n}=e,a=j({...e,initializeStore:o,createOrModify:"create"}),c=!["jira_import"].includes(e.from)&&!n;return a&&a.length>0&&c&&B().uK({environment:t,store:a[0],redirect:!0,pageVisitSource:i().y8.Onboarding}),r.postSubmitCallbacks.push((async e=>{e?w().f1(F().A.formatMessage(W.initializeAppTemplateError)):a&&await async function(e){const{environment:t,appCollectionViewBlockStores:o}=e,r=o.flatMap((e=>e.getCollectionStores()??[])).filter((e=>{const t=e.getSchema();return(0,l().yP)(t).length>0}));for(const i of r)await S().c({environment:t,collectionStore:i})}({environment:t,appCollectionViewBlockStores:a})})),a}function H(e){const{appUri:t,parentStore:o,presetUri:r}=e,i=(0,z().appConfigs)().find((e=>e.uri===t));if(!o.isDefined()||!i)return;if(0===i.presets.length)throw new Error(`No presets configuration for specified app: ${t}`);const l=i.presets.find((e=>e.uri===r));if(r&&!l)throw new Error("Couldn't find specified preset");const c=l||i.presets[0],p=N((0,z().appConfigs)(),c),s=i.presets.filter((e=>!function(e){return e.endsWith(n().W)}(e.uri))),d=function(e){const{environment:t,spaceViewStore:o,appUri:r,parentStore:i,spaceId:n,transaction:l,startingFeatures:c,defaultPreset:p,nonTypedDBPresets:s,foundConfiguration:d}=e;if(!r.startsWith("notion://wiki")&&1===s.length)return $({environment:t,spaceViewStore:o,appParentStore:i,appUri:r,features:c,createOrModify:"create",transaction:l});const f=k().Wv({environment:t,type:a().xd.collectionViewPage,spaceId:n,format:{app_config_uri:r,collection_view_sub_type:"app_container",page_icon:d.logo,app_template_preset:p.uri,app_template_features:c},properties:{title:(0,u().x9d)(r.startsWith("notion://wiki")?d.name:p.shortName)},inMemoryRecordCache:i.inMemoryRecordCache,transaction:l});k().zv({store:f,data:{parent_id:i.id,parent_table:i.table,alive:!0,view_ids:[]},transaction:l});const v=E().B.createChildStore(i,f.pointer);return(0,D().Ls)(t,o,i,v,l,"prepend"),[v]}({...e,startingFeatures:p,defaultPreset:c,nonTypedDBPresets:s,foundConfiguration:i});return d}function j(e){const{environment:t,appUri:o,presetUri:r,transaction:i,createOrModify:n,from:a}=e,l=(0,z().appConfigs)().find((e=>e.uri===o)),c=null==l?void 0:l.presets.find((e=>e.uri===r));if(c)return i.postSubmitCallbacks.push((e=>{g()._I(t,{preset_uri:K(r),status:Boolean(e)?"fail":"success",from:a}),e&&p().log({level:"error",from:"appTemplateActions.applyPresetFeatures",type:"transactionFailed",error:(0,v().convertErrorToLog)(e),data:{miscDataToConvertToString:{appUri:o,presetUri:r,createOrModify:n,from:a}}})})),$({...e,features:N((0,z().appConfigs)(),c)});p().log({level:"error",from:"appTemplateActions.applyPresetFeatures",type:"presetNotFound",error:{name:`Preset not found for appUri ${o} and presetUri ${r}. From: ${a}`}})}function K(e){return(0,n().TS)(e)?e:"other"}function $(e){const{environment:t,spaceViewStore:o,appParentStore:i,appUri:n,features:l,transaction:c,createOrModify:d,customPropertyName:v}=e,g=(0,z().appConfigs)().find((e=>e.uri===n));if(!g||!i.isDefined())return;let _;if("modify"===d){const{appCollectionViewBlockStores:t}=e,o=f().sb(f().oE(t.map((e=>e.getFormat().app_id))));if(o.length>1)throw new Error("App collection view block stores must have the same app id");0===o.length?_=function({transaction:e,collectionViewBlockStores:t}){const o=s().JW();for(const r of t){const t=J(r);if(!t)continue;const i=r.getFormat(),n={app_id:i.app_id??o,...t};k().zv({store:r.getFormatStore(),data:n,transaction:e}),p().log({level:"info",from:"appTemplateActions.backfillAppMetadataOnCollectionViewBlocks",type:"backfillAppMetadata",data:{miscDataToConvertToString:{databaseType:L(r),collectionViewBlockId:r.id,originalFormat:i}}})}return o}({transaction:c,collectionViewBlockStores:t}):(G({transaction:c,collectionViewBlockStores:t}),_=o[0])}const y=function({featurePointers:e,appConfig:t}){const o=f().oE(e.map((e=>{const{type:t}=e;return"simple"===t?e.featureUri:"with_variant"===t?e.defaultVariantUri:void(0,m().HB)(t)}))),r={};for(const a of t.allFeatures)r[a.uri]=a;const i=o.map((e=>r[e])).filter((e=>(0,x().l)(e))),n={};for(const a of i)for(const e of a.dependencies)n[e.uri]=e;return Object.values(n)}({featurePointers:l,appConfig:g});if(0===y.length)return;let S={};if("create"===e.createOrModify&&e.initializeStore){const o=y.filter((e=>"collection_view_block"===e.type)),r=o[0];r&&(k().zv({store:e.initializeStore,data:{type:e.initializeStore.isType(a().xd.collectionViewPage)||e.initializeStore.isType(a().xd.collectionView)?e.initializeStore.getType():a().xd.collectionViewPage},transaction:c}),k().zv({store:e.initializeStore.getFormatStore(),data:{app_config_uri:r.uri,page_icon:r.icon,page_cover:r.cover,collection_view_sub_type:null,app_template_features:null},transaction:c}),V().R9({environment:t,store:e.initializeStore.getBlockTitleStore(),value:(0,u().x9d)(r.name),transaction:c}),S[r.uri]=e.initializeStore.id)}else"modify"===e.createOrModify&&(S=Object.assign({},...f().oE(e.appCollectionViewBlockStores.map((e=>{var t;return null===(t=e.getFormat())||void 0===t?void 0:t.app_uri_map})))));const b={...S};(0,D().$K)(t,o,i,y,b,g,c,v),y.map((e=>{if("collection_view_block"===e.type){const t=(0,D().Or)(i,e.uri,b);t&&function(e,t,o){const r=e.getCollectionViewStores().map((e=>{const o=e.getFormat().app_config_uri;let r=o?null==t?void 0:t.indexOf(o):null==t?void 0:t.length;return void 0!==r&&-1!==r||(r=null==t?void 0:t.length),{viewStore:e,order:r}})),i=f().Ul(r,(e=>e.order)).map((e=>e.viewStore.id));k().zv({store:e,data:{view_ids:i},transaction:o})}(t,e.defaultViewsOrder||[],c)}}));const w=f().oE(f().sb(f().oE(y.map((e=>{if("collection_view_block"===e.type)return e.uri;if("collection"===e.type||"collection_view"===e.type){const t=(0,O().T)([e.collectionViewBlockUri],g);if(t&&t.length&&"collection_view_block"===t[0].type)return e.collectionViewBlockUri}}))))),B=f().oE(w.map((e=>(0,D().Or)(i,e,b))));if("create"===d&&e.initializeStore){const t=e.initializeStore.getPermissionItemsStore().getValue();t&&B.forEach((e=>{k().zv({store:e,data:{permissions:t},transaction:c})}))}const P="create"===d?f().oE([e.initializeStore]):e.appCollectionViewBlockStores,U=B.filter((e=>void 0===P.find((t=>t.id===e.id))));if(P.length>0&&U.length>0){const e=P[P.length-1],t=(0,D().cA)(o,i,e);t&&U.forEach(((o,r)=>{C().Yb({parentStore:t,currentStore:o,afterStore:0===r?e:U[r-1],transaction:c})}))}const I=B.flatMap((e=>{var t;return(null===(t=e.getCollectionPointers())||void 0===t?void 0:t.map((e=>e.id)))??[]})).filter(m().O9);(0,r().u)({environment:t,event:{eventName:"create_app_templates",eventProperties:{target_page_ids:B.map((e=>e.id)),template_label:g.name,collection_ids:I}}});const M=_||s().JW();return function(e,t,o,r,i){e.forEach((e=>{const n=e.getFormat().app_config_uri;if(n){var a;const l=R(new Set([n]),t),c={};l.forEach((e=>{o[e.uri]&&(c[e.uri]=o[e.uri])})),c[n]=o[n],h().zA({stores:[e],update:{app_uri_map:{...(null===(a=e.getFormat())||void 0===a?void 0:a.app_uri_map)||{},...c},app_id:r},transaction:i})}}))}(B,y,b,M,c),B}function L(e){var t;const o=null===(t=e.getCollectionStores())||void 0===t?void 0:t.map((e=>e.getDatabaseType()));if(o&&0!==o.length)return 1===o.length?o[0]:o.join(", ")}function G({transaction:e,collectionViewBlockStores:t}){for(const o of t){const t=J(o);if(!t)continue;const r=o.getFormat(),i={app_config_uri:r.app_config_uri,app_uri_map:r.app_uri_map};f().n4(i,t)||(k().zv({store:o.getFormatStore(),data:t,transaction:e}),p().log({level:"info",from:"appTemplateActions.maybeUpsertAppUriMetadataOnCollectionViewBlocks",type:"fixAppMetadata",data:{miscDataToConvertToString:{databaseType:L(o),collectionViewBlockId:o.id,originalFormat:r}}}))}}function J(e){const t=e.getCollectionStoreIfSingleSource();if(!t)return;const o=t.getDatabaseType();if(!o)return;const r=n().Fh[o].blockUri,i={[o]:t.id};r&&(i[r]=e.id);return{app_config_uri:r,app_uri_map:{...e.getFormat().app_uri_map,...i}}}function Y(e){const{environment:t,dependencies:o,appCollectionViewBlockStores:r,from:i}=e,n=function(e){return e.filter((t=>{if("collection"===t.type){return Boolean(e.find((e=>"collection_view_block"===e.type&&e.uri===t.collectionViewBlockUri)))}if("property"===t.type||"collection_view"===t.type||"collection_view_block"===t.type||"page_template"===t.type||"block"===t.type||"database_template"===t.type||"sub_external_collection"===t.type)return!0;(0,m().HB)(t)}))}(o);P().createAndCommit({userAction:"appTemplateActions.removeTypedDependencies",environment:t,canUndo:!0,perform:e=>{G({transaction:e,collectionViewBlockStores:r});const o=Object.assign({},...f().oE(r.map((e=>{var t;return null===(t=e.getFormat())||void 0===t?void 0:t.app_uri_map}))));!function(e){const{environment:t,appCollectionViewBlockStores:o,dependenciesToRemove:r,completeUriMap:i,transaction:n}=e,a=[...r.filter((({type:e})=>"collection_view"===e)),...r.filter((({type:e})=>"block"===e)),...r.filter((({type:e})=>"database_template"===e)),...r.filter((({type:e})=>"page_template"===e)),...r.filter((({type:e})=>"property"===e)),...r.filter((({type:e})=>"sub_external_collection"===e)),...r.filter((({type:e})=>"collection"===e)),...r.filter((({type:e})=>"collection_view_block"===e))];for(const l of a)if("collection_view_block"===l.type){const e=o.find((e=>{var t;return(null===(t=e.getFormat())||void 0===t?void 0:t.app_config_uri)===l.uri}));e&&n.postSubmitCallbacks.push((o=>{o||y().callApi({eventName:"deleteContentRecords",environment:t,data:{records:[e.getSpaceShardedPointer()],permanentlyDelete:!0}})}))}else if("collection"===l.type){const e=o.find((e=>{var t;return(null===(t=e.getFormat())||void 0===t?void 0:t.app_config_uri)===l.collectionViewBlockUri}));if(e){const t=(0,D().Pu)(e,l.uri,i);t&&(0,M().removeCollectionFromCollectionViewBlock)({collectionViewBlockStore:e,collectionStore:t,transaction:n})}}else if("property"===l.type){const r=o.find((e=>{var t;return null===(t=e.getCollectionStores()??[])||void 0===t?void 0:t.some((e=>{var t;return(null==e||null===(t=e.getFormat())||void 0===t?void 0:t.app_config_uri)===l.collectionUri}))}))??o[0],a=(0,D().Pu)(r,l.collectionUri,i);if(a){let o;const p=(0,c().nC)(l.propertySchema)?(0,c().zO)(l.propertySchema):void 0;p&&(o=(0,D().Pu)(r,p,i)),(0,b().B)({environment:t,collectionStore:a,schema:a.getSchema(),property:l.uri,transaction:n,targetCollectionStore:o}),(0,_().G)(t,{property_type:l.propertySchema.type,from:e.from,property:l.uri,collection_id:a.id})}}else if("collection_view"===l.type){const e=i[l.uri];if(!e)throw new Error("Cannot delete view: id not found in map.");const t=o.find((e=>{var t;return(null===(t=e.getFormat())||void 0===t?void 0:t.app_config_uri)===l.collectionViewBlockUri}));if(t){const o=T().p.createChildStore(t,{table:d().Gy,id:e,spaceId:t.getSpaceId()});(0,I().T)({collectionViewBlockStore:t,collectionViewStore:o,transaction:n})}}else"page_template"===l.type||"block"===l.type||"database_template"===l.type||"sub_external_collection"===l.type||(0,m().HB)(l)}({environment:t,appCollectionViewBlockStores:r,dependenciesToRemove:n,completeUriMap:o,transaction:e,from:i})}})}async function Q(e){const{environment:t,presets:o,spaceStore:r,spaceViewStore:i,teamStore:n}=e,a=o.slice().reverse().map((e=>{const{serverCommitResult:o,performResult:a}=P().createAndCommit({environment:t,userAction:"AppsSetup.onContinueWithAppsMultiTransaction",canUndo:!0,skipUpdatingEditedMetadata:!0,perform:o=>{var a;const l=null===(a=(0,A().B)((0,z().appConfigs)(),e))||void 0===a?void 0:a.uri;if(!l)return;return H({environment:t,spaceViewStore:i,appUri:l,parentStore:n,spaceId:r.id,transaction:o,presetUri:e})}});return{serverCommitResult:o,performResult:a}}));await Promise.all(a.map((e=>e.serverCommitResult)));return f().oE(f().Bq(a.map((e=>e.performResult)).reverse()))}}}]);