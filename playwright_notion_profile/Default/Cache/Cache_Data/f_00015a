"use strict";(globalThis.webpackChunknotion_next=globalThis.webpackChunknotion_next||[]).push([[94995],{343168:(e,o,t)=>{t.d(o,{A:()=>n});class r extends(()=>t(757695))().Store{getInitialState(){return{openTooltip:void 0}}}const n=new r},894995:(e,o,t)=>{t.r(o),t.d(o,{FORMS_SHARE_CALLOUT_KEY:()=>oe,changeFormClosedState:()=>me,changeFormSubmissionPermissions:()=>pe,changeFormSubmissionTemplate:()=>fe,createAndFocusCollectionFormEditorView:()=>ie,createCollectionFormEditorView:()=>ae,createDummyFormPage:()=>Ie,createFormInPrivate:()=>se,createFormQuestion:()=>le,createFormQuestionAndUpdateOrCreateModule:()=>ce,createModuleForNewlyDuplicatedProperty:()=>ue,createResponsesCollectionView:()=>de,incrementAndTrackUserFormsCreated:()=>te,maybeAlertAboutUnsupportedPublicQuestions:()=>be,maybeSyncQuestionNameToPropertyName:()=>re,remapQuestionToNewProperty:()=>ge,toggleAnonymousFormSubmissionState:()=>ve,toggleNotionBrandingState:()=>ye});t(16280),t(944114),t(898992),t(354520),t(672577),t(803949),t(581454),t(296540);var r=()=>t(564884),n=()=>t(242422),i=()=>t(401497),a=()=>t(584262),s=()=>t(700500),d=()=>t(31503),l=()=>t(898244),u=()=>t(713998),c=()=>t(110192),m=()=>t(416504),p=()=>t(123423),f=()=>t(626922),v=()=>t(421559),y=()=>t(688728),g=()=>t(235692),I=()=>t(388821),b=()=>t(450648),h=()=>t(179034),_=()=>t(519831),w=()=>t(869558),A=()=>t(37165),S=()=>t(144081),M=()=>t(201980),C=()=>t(69708),x=()=>t(496603),T=()=>t(183558),B=()=>t(284371),P=()=>t(389114),F=()=>t(901389),N=()=>t(896628),O=()=>t(384944),Q=()=>t(857783),E=()=>t(185544),D=()=>t(231297),U=()=>t(755199),k=()=>t(478251),V=()=>t(180762),R=()=>t(824438),z=()=>t(389658),G=()=>t(852353),L=()=>t(594794),j=()=>t(972435),q=()=>t(300789),H=()=>t(978846),X=()=>t(33218),Z=()=>t(765957),W=()=>t(343168),$=()=>t(50764),K=()=>t(541056),J=()=>t(465741),Y=t(474848);const ee=(0,C().YK)({responsesViewName:{id:"formEditorActions.responsesViewName",defaultMessage:"Responses"},newFormViewName:{id:"formEditorActions.newFormViewName",defaultMessage:"Form builder"},formDatabaseTitle:{id:"newBlock.databaseInline.formDatabaseTitle",defaultMessage:"New form"}}),oe="forms_share_form_tooltip";function te(e,o){const{currentUserSettingsStore:t}=Z().default.state;if(!t)return;const i=function(){const{currentUserSettingsStore:e}=Z().default.state;if(!e)return;return e.getSettingsStore().getKeyStore("user_forms_created_count").getValue()??0}();void 0!==i&&(U().mJ({userSettingsStore:t,transaction:o,data:{user_forms_created_count:i+1}}),function(e,o){(0,r().u)({environment:e,event:{eventName:"form_created",eventProperties:{user_total_form_count:o.userFormsCreatedCount}}})}(e,{userFormsCreatedCount:i+1})),n().default.logEvent("form_created")}function re(e){var o;const{questionStore:t,environment:r,collectionStore:n,collectionContextStore:i}=e,a=null===(o=t.getConfig())||void 0===o?void 0:o.propertyId;if(!a)throw new Error("No property ID found for question");D().createAndCommit({userAction:"formQuestion.changeName",environment:r,canUndo:!0,perform:e=>{if(!t.shouldSyncQuestionNameToPropertyName())return;const o=t.getNameStore().getValue();if(!o)return;const r=(0,b().r4)({textValue:o,getRecordModel:t.getRecordModel,deterministic:!0,userTimeZone:(0,m().P)(),intl:j().A.getIntl()}),s=(0,G().fE)({property:a,collectionContextStore:i,newValue:r})?(0,c().Q)(r):r;(0,P().Y)({collectionStore:n,property:a,name:s,transaction:e})}})}function ne(){const e=(0,i().IS)((e=>({container:{display:"flex",flexDirection:"column"},iconGroup:{display:"flex",flexDirection:"row",justifyContent:"center",color:e.icon.secondary,alignItems:"center"},dialogTitle:{fontSize:16,fontWeight:B().Wy.semibold,lineHeight:"22px",marginTop:12,marginBottom:12},dialogDescription:{color:e.text.secondary,fontSize:14,lineHeight:"20px"}})),[]);return(0,Y.jsxs)("div",{style:e.container,children:[(0,Y.jsxs)("div",{style:e.iconGroup,children:[(0,v().T)({width:36}),(0,p().arrowStraightRightFillIcon)({width:24,marginInlineStart:12,marginInlineEnd:12}),(0,f().e)({width:36})]}),(0,Y.jsx)("span",{style:e.dialogTitle,children:(0,Y.jsx)(C().sA,{defaultMessage:"Auto-create form questions based on existing properties?",id:"NewFormOnExistingCollectionDialogTitle.message"})}),(0,Y.jsx)("span",{style:e.dialogDescription,children:(0,Y.jsx)(C().sA,{defaultMessage:"Only supported property types will create new questions.",id:"NewFormOnExistingCollectionDialogTitle.description"})})]})}function ie(e){const{environment:o,collectionContextStore:t,collectionStore:r,transaction:n}=e,i=t.collectionViewBlockStore();if(!i)return;const a=r.getSchema(),s=ae({environment:o,collectionViewBlockStore:i,collectionId:r.id,schema:a,transaction:n,initializeWithAllDefaultQuestions:!1});if(!s)return;(0,V().t)({environment:o,collectionContextStore:t,collectionViewId:s.newViewId,isFullScreen:t.isFullScreenStore.state,isRootChild:t.isRootChildStore.state,isInPeekRenderer:t.isInPeekRendererStore.state});const l=s.layoutStore,u=Object.keys(a).filter((e=>{const o=a[e];return"title"!==e&&o&&(0,d().Sg)(o)}));u.length>0&&u.length<=J().eb&&F().ui({showCancel:!1,keepFocus:!1,message:(0,Y.jsx)(ne,{}),mode:"wide",items:[{label:(0,Y.jsx)(C().sA,{defaultMessage:"Create {numQuestions, plural, one {1 question} other {{numQuestions} questions}}",id:"formEditorActions.createQuestions.primaryAction",values:{numQuestions:u.length}}),color:"blue",buttonType:"solid",onAccept(){D().createAndCommit({environment:o,userAction:"formActions.autoCreateFormQuestionsForExistingDatabase",canUndo:!0,perform:e=>{for(const n of u)ue({type:"formQuestion",environment:o,module:void 0,transaction:e,layoutStore:l,collectionStore:r,propertyId:n,position:{type:"area_relative",area:"form_layout_schema",location:"end_moveable"},collectionContextStore:t,shouldLogEvent:!0,autoCreatedFromExistingDatabase:!0,duplicateModuleMapping:new Map,propertyIdMapping:new Map,sessionId:(0,T().Ay)()})}})}},{label:(0,Y.jsx)(C().sA,{defaultMessage:"Start from scratch",id:"formEditorActions.createQuestions.secondary"}),color:"gray",buttonType:"plain",onAccept(){}}]})}function ae(e){const{environment:o,collectionViewBlockStore:t,collectionId:r,transaction:n,schema:i,initializeWithAllDefaultQuestions:a}=e;if(!t)return;const s=t.getSpaceId(),{formBlockStore:u,layoutStore:c}=function(e){var o;const{environment:t,spaceId:r,inMemoryRecordCache:n,transaction:i,schema:a,initializeWithAllDefaultQuestions:s}=e,u=Object.keys(a).find((e=>{var o;return"multi_select"===(null===(o=a[e])||void 0===o?void 0:o.type)})),c=Boolean(s&&void 0!==u),m=(0,L().Z1)({environment:t,table:h().ev,spaceId:r}),p=(0,L().Z1)({environment:t,table:A().lo,spaceId:r}),f=c?(0,L().Z1)({environment:t,table:A().lo,spaceId:r}):void 0,v=O().Wv({id:m,environment:t,type:"form",permissions:(0,d().eb)(),inMemoryRecordCache:n,transaction:i}),y=O().eC({environment:t,table:S().zx,value:{space_id:r,parent_table:h().ev,parent_id:v.id,modules:(0,g().oP)(p,f)},inMemoryRecordCache:n,transaction:i});var I,b;N().zA({stores:[v],update:{form_layout_pointer:{id:y.id,spaceId:r,table:S().zx}},transaction:i}),le({environment:t,questionId:p,spaceId:r,layoutId:y.id,propertyId:l().rn,initialQuestionTitle:(null===(o=a[l().rn])||void 0===o?void 0:o.name)??"",inMemoryRecordCache:n,transaction:i,shouldSyncQuestionNameToPropertyName:!0,shouldLogEvent:!1,logData:{area:"form_layout_schema",layoutStore:y}}),c&&f&&u&&le({environment:t,questionId:f,spaceId:r,layoutId:y.id,propertyId:u,initialQuestionTitle:(null===(I=a[u])||void 0===I?void 0:I.name)??"",existingFormQuestionConfig:{propertyId:u,name:[[(null===(b=a[u])||void 0===b?void 0:b.name)??""]],propertyTypeSpecificConfig:{multi_select:{maxSelectionCount:1}}},inMemoryRecordCache:n,transaction:i,shouldSyncQuestionNameToPropertyName:!0,shouldLogEvent:!1,logData:{area:"form_layout_schema",layoutStore:y}});return{formBlockStore:v,layoutStore:y}}({environment:o,spaceId:s,inMemoryRecordCache:t.inMemoryRecordCache,transaction:n,schema:i,initializeWithAllDefaultQuestions:a}),m=(0,k().i)({environment:o,collectionViewBlockStore:t,collectionView:{type:"form_editor",parent_id:t.id,parent_table:h().ev,alive:!0,space_id:s,name:j().A.formatMessage(ee.newFormViewName),format:{form_block_pointer:{id:u.id,spaceId:s,table:h().ev},collection_pointer:{id:r,spaceId:s,table:_().Vl}}},transaction:n});return O().zv({store:u,data:{parent_id:m.id,parent_table:w().Gy,alive:!0},transaction:n}),W().A.setState({openTooltip:m.id}),q().HH(o,oe),te(o,n),{newViewId:m.id,layoutStore:c,formId:u.id}}function se(e){const{environment:o,navigateToFormBuilder:t}=e,{sidebarSpaceStore:r,sidebarSpaceViewStore:n}=Z().default.state;if(!r||!n)return;if(!(0,$().E)(o))return void(0,K().Q)(o);if(!(r&&r.canEdit()&&n))return;const i=r.id,s=o.idCreator.getSpaceIdCreatorSync(i);D().createAndCommit({environment:o,userAction:"formActions.createAndNavigateToFormInPrivate",canUndo:!0,perform:e=>{var d;const{targetBlockStore:l}=(0,R().j)({environment:o,sourceBlockId:"root",targetBlockPointer:(0,L().zP)({environment:o,table:h().ev,spaceId:i}),sourceBlockSubtree:(0,I().partialRecordMapToRecordMap)(z().mT({isInline:!0,name:(0,M().x9d)(j().A.formatMessage(ee.formDatabaseTitle))})),targetRecordCache:r.inMemoryRecordCache,transaction:e,deepCopyTransclusionContainers:!0,resolveTemplateVariables:!1,spaceIdCreator:s}),u=l.getCollectionStoreIfSingleSource();if(!u)throw new Error("Collection store not found");const c=null==u||null===(d=u.getModel())||void 0===d?void 0:d.getNormalizedSchema(),m=l;if(!c)throw new Error("Schema not found");ae({environment:o,transaction:e,collectionViewBlockStore:m,collectionId:u.id,schema:c,initializeWithAllDefaultQuestions:!0}),de({environment:o,transaction:e,collectionViewBlockStore:m,collectionStore:u,schema:c}),E().yM({environment:o,spaceStore:r,spaceViewStore:n,pageStore:l,isPrivate:!0,transaction:e,location:{type:"prepend"}}),t&&Q().uK({environment:o,store:l,pageVisitSource:a().y8.CreateFormDeepLink})}})}function de(e){const{environment:o,collectionViewBlockStore:t,collectionStore:r,transaction:n}=e,i=t.getSpaceId(),a=Object.keys(e.schema).find((o=>{var t;return"created_by"===(null===(t=e.schema[o])||void 0===t?void 0:t.type)}));(0,k().i)({environment:o,collectionViewBlockStore:t,collectionView:{type:"table",parent_id:t.id,parent_table:h().ev,alive:!0,name:j().A.formatMessage(ee.responsesViewName),space_id:i,format:{table_properties:[{property:"title",visible:!0},...a?[{property:a,visible:!0}]:[]],table_wrap:!0,collection_pointer:r.pointer}},transaction:n})}function le(e){const{environment:o,questionId:t,spaceId:n,layoutId:i,propertyId:a,initialQuestionTitle:s,inMemoryRecordCache:d,transaction:l,shouldSyncQuestionNameToPropertyName:u,collectionContextStore:c,shouldLogEvent:m=!0,autofocusTitle:p,existingFormQuestionConfig:f,autoCreatedFromExistingDatabase:v}=e;O().vt({environment:o,table:A().lo,args:{id:t,space_id:n,parentPointer:{id:i,table:S().zx,spaceId:n},config:{...f,propertyId:a,name:[[s]],shouldSyncQuestionNameToPropertyName:u}},inMemoryRecordCache:d,transaction:l}),m&&(0,r().u)({environment:o,event:{eventName:"add_form_question",eventProperties:{...(0,J().YA)({collectionContextStore:c,propertyId:a,questionId:t,area:e.logData.area,parentModuleId:e.logData.parentModuleId,layoutStore:e.logData.layoutStore}),auto_created_from_existing_database:Boolean(v)}}}),p&&p.autofocusedQuestionTextStore.autofocusQuestionTitle({questionId:t})}function ue(e){const{type:o,module:t,environment:r,transaction:n,layoutStore:i,position:a,duplicateModuleMapping:s,shouldLogEvent:d=!0,collectionContextStore:l,sessionId:u}=e;let c;const m=t&&s.get(t.id)||(0,T().Ay)();if("formQuestion"===o){var p;const{collectionStore:o,propertyId:u,autofocusTitle:f,existingFormQuestionConfig:v,autoCreatedFromExistingDatabase:g,propertyIdMapping:I}=e,b=o.getSchema()[u];if(!b)throw new Error(`No schema found for property ${u}`);const h=v?(0,M().q4_)(null==v?void 0:v.name):b.name,_=i.getSpaceId(),w=(0,L().Z1)({environment:r,table:A().lo,spaceId:_});if(!(0,y().uW)(a.area))throw new Error("Module is not allowed in this area");le({environment:r,questionId:w,spaceId:_,layoutId:i.id,propertyId:u,initialQuestionTitle:h,inMemoryRecordCache:i.inMemoryRecordCache,transaction:n,shouldSyncQuestionNameToPropertyName:!0,shouldLogEvent:d,logData:{area:a.area,parentModuleId:null==t?void 0:t.parentModuleId,layoutStore:i},collectionContextStore:l,autofocusTitle:f,existingFormQuestionConfig:v,autoCreatedFromExistingDatabase:g}),c={type:"formQuestion",id:m,formQuestionId:w,...t?{parentModuleId:s.get(t.parentModuleId??"")??t.parentModuleId,parentConditionalGroupId:t.parentConditionalGroupId,conditionalGroups:null===(p=t.conditionalGroups)||void 0===p?void 0:p.map((e=>({...e,trigger:{...e.trigger,property:I.get(e.trigger.property)??e.trigger.property},children:[]})))}:{}}}else c={type:"placeholder",id:m,parentModuleId:s.get(t.parentModuleId??""),parentConditionalGroupId:t.parentConditionalGroupId};return(0,H().UQ)({environment:r,transaction:n,layoutStore:i,position:a,module:c,sessionId:u,isPropertyCreation:!1}),{moduleId:m}}function ce(e){const{environment:o,transaction:t,layoutStore:r,propertyId:n,initialQuestionTitle:i,moduleId:a,shouldSyncQuestionNameToPropertyName:s,collectionContextStore:d,autofocusTitle:l,area:u,sessionId:c}=e,m=r.getModel();if(!m)throw new Error("Layout model cannot be undefined");const p=r.getSpaceId(),f=(0,L().Z1)({environment:o,table:A().lo,spaceId:p});le({environment:o,questionId:f,spaceId:p,layoutId:m.id,propertyId:n,initialQuestionTitle:i,inMemoryRecordCache:r.inMemoryRecordCache,transaction:t,shouldSyncQuestionNameToPropertyName:s,collectionContextStore:d,autofocusTitle:l,logData:{area:u,parentModuleId:"form_conditional_modules"===u?e.parentModuleId:void 0,layoutStore:r}});const v={type:"formQuestion",id:a??(0,T().Ay)(),formQuestionId:f,..."form_conditional_modules"===u?{parentModuleId:e.parentModuleId,parentConditionalGroupId:e.parentConditionalGroupId}:{}};return a?(0,X().UQ)({environment:o,transaction:t,layoutStore:r,position:{area:u,moduleId:a},updatedModule:v}):"form_conditional_modules"===u&&(0,H().UQ)({environment:o,transaction:t,layoutStore:r,position:{type:"absolute",area:"form_conditional_modules",parentConditionalGroupId:e.parentConditionalGroupId,parentModuleId:e.parentModuleId},module:v,sessionId:c,isPropertyCreation:!1}),{updatedModuleId:v.id,formQuestionId:f}}function me({environment:e,formBlockStore:o,isClosed:t}){o.getIsFormClosed()!==t&&D().createAndCommit({userAction:"formActions.changeFormClosedState",environment:e,canUndo:!0,perform:e=>{N().zA({stores:[o],update:{form_config:{...o.getFormConfig(),is_form_closed:t}},transaction:e})}})}function pe({environment:e,formBlockStore:o,permissions:t}){o.getFormSubmissionPermissions()!==t&&D().createAndCommit({userAction:"formActions.changeFormSubmissionPermissions",environment:e,canUndo:!0,perform:e=>{N().zA({stores:[o],update:{form_config:{...o.getFormConfig(),submission_permissions:t}},transaction:e})}})}function fe({environment:e,formBlockStore:o,template:t}){const r=o.getFormSubmissionTemplate();(0,x().n4)(r,t)||D().createAndCommit({userAction:"formActions.changeFormSubmissionTemplate",environment:e,canUndo:!0,perform:e=>{O().KY({store:o.getFormatStore().getKeyStore("form_config").getKeyStore("form_submission_template"),transaction:e,value:t})}})}function ve({environment:e,formBlockStore:o}){const t=o.getIsFormAnonymousSubmissionEnabled();D().createAndCommit({userAction:"formActions.changeAnonymousFormSubmissionState",environment:e,canUndo:!0,perform:e=>{N().zA({stores:[o],update:{form_config:{...o.getFormConfig(),anonymous_submissions:!t}},transaction:e})}})}function ye({environment:e,formBlockStore:o}){var t;const r=o.getSiteStore();if(!r)return;const n=(null===(t=r.getHeader())||void 0===t?void 0:t.hideWatermark)??!1;D().createAndCommit({userAction:"formBlockStore.publicForm.toggleNotionBranding",environment:e,canUndo:!0,perform:e=>{D().applyOperation({store:r,operation:{pointer:r.pointer,path:["header","hideWatermark"],command:"set",args:!n},transaction:e})}})}function ge({environment:e,newPropertyId:o,formQuestionStore:t}){D().createAndCommit({userAction:"formQuestion.remapQuestionToNewProperty",environment:e,canUndo:!0,perform:e=>{D().applyOperation({store:t,operation:{pointer:t.pointer,path:["config","propertyId"],command:"set",args:o},transaction:e})}})}function Ie(e){const{environment:o,collectionSchemaPropertyIds:t,temporaryRecordCache:r,spaceId:n,collectionId:i,formMode:a}=e,d={};t.forEach((e=>{d[e]=(0,M().x9d)("")}));const{performResult:l}=D().createAndCommit({environment:o,userAction:"formActions.createDummyFormPage",perform:e=>{const t=O().Wv({environment:o,type:s().xd.page,inMemoryRecordCache:r,transaction:e,spaceId:n,properties:{...d}});return O().zv({store:t,data:{alive:"viewer"===a,parent_id:i,parent_table:"collection"},transaction:e}),t},canUndo:!1});return l}async function be(e){const{environment:o,formBlockStore:t,collectionSchema:r,theme:n,onAccept:i}=e;if(!r)return;const a=(0,J().Dx)(t),s=(null==a?void 0:a.getNormalizedFormQuestionStoresForFormLayout({collectionSchema:r}))??[],d=[];if(s.forEach((e=>{const t=e.getPropertyId();if(!t)return;const n=(0,u()._g)({schema:r,property:t}),i=null==n?void 0:n.type;if(!i)return;(0,J().CK)({environment:o,propertyType:i,propertySchema:n,isPublicForm:!0})&&d.push(e)})),0===d.length)return void i();const l=d.map(((e,o)=>{const t=(0,b().r4)({textValue:e.getNameStore().getValue(),getRecordModel:e.getRecordModel,deterministic:!0,userTimeZone:(0,m().P)(),intl:j().A.getIntl()}),r=o===d.length-1;return(0,Y.jsx)("div",{style:{fontSize:14,textAlign:"start",padding:"8px 12px",borderBottom:r?void 0:`1px solid ${n.lightDividerColor}`},children:t},e.id)})),{accept:c}=await F().Gh({message:(0,Y.jsx)(C().sA,{id:"formEditorActions.maybeAlertAboutUnsupportedPublicQuestions.message",defaultMessage:"These questions are not supported in public forms and will not be shown to respondents:"}),description:(0,Y.jsx)("div",{style:{borderRadius:6,border:`1px solid ${n.lightDividerColor}`,width:"calc(100% + 24px)",marginInlineStart:-12,marginTop:12,maxHeight:210,overflow:"auto"},children:l}),acceptLabel:(0,Y.jsx)(C().sA,{id:"formEditorActions.maybeAlertAboutUnsupportedPublicQuestions.acceptLabel",defaultMessage:"Got it"}),acceptColor:"blue",cancelButtonType:"plain",mode:"wide"});c&&i()}},978846:(e,o,t)=>{t.d(o,{E:()=>I,UQ:()=>b});t(16280),t(18107),t(944114),t(967357);var r=()=>t(242422),n=()=>t(31503),i=()=>t(792071),a=()=>t(688728),s=()=>t(500993),d=()=>t(369186),l=()=>t(475140),u=()=>t(120997),c=()=>t(251822),m=()=>t(778781),p=()=>t(496603),f=()=>t(534177),v=()=>t(231297),y=()=>t(447934),g=()=>t(479062);function I(e){const{moduleId:o,layoutStore:t,sessionId:r,environment:i,position:s}=e,d=t.getModuleById(o);if(!d)throw new Error(`Cannot move module with id ${o} because a module with that id is not in the layout`);const l=(0,g().TR)({modulesByArea:t.getModules(),moduleId:o,newPosition:s});h({...e,module:d,userAction:"BuilderLayoutModules.moveModuleToPosition",afterUpsertTransaction:()=>{var e;const o=(0,n().Cg)({moduleId:d.id,modulesByArea:t.getModules()}).length;(0,g().Ib)({environment:i,sessionId:r,collectionId:null===(e=t.getCollectionModel())||void 0===e?void 0:e.id,layoutId:t.id,context:(0,a().We)(s.area),action:l,moduleType:d.type,area:s.area,depth:o})}})}function b(e){const{position:o,module:t,layoutStore:r,sessionId:i,environment:s}=e;if(r.getModuleById(t.id))throw new Error(`Cannot add module with id ${t.id} because a module with that id is already in the layout`);h({...e,userAction:"BuilderLayoutModules.addModuleAtPosition",performBeforeApplyUpsertOperations:e=>{const{transaction:n}=e;"page_main"!==o.area&&"page_details"!==o.area||(0,m().gx)(t)&&(0,y().HD)({environment:s,transaction:n,layoutStore:r,property:t.propertyId})},afterUpsertTransaction:()=>{var d;const l=(0,n().Cg)({moduleId:t.id,modulesByArea:r.getModules()}).length;(0,g().zb)({environment:s,module:t,sessionId:i,collectionId:null===(d=r.getCollectionModel())||void 0===d?void 0:d.id,layoutId:r.id,context:(0,a().We)(o.area),isPropertyCreation:e.isPropertyCreation,area:o.area,depth:l})}})}function h(e){const{environment:o,position:t,layoutStore:r,module:n,transaction:c,userAction:m,performBeforeApplyUpsertOperations:p,afterUpsertTransaction:y}=e,g=r.pointer,I=r.getModules(),b=r.getRawModules(),h=b&&(0,l().c7)(b,(e=>e.id===n.id))||(0,d().Lv)(n),S="page_main"===t.area||"page_details"===t.area?function(e){const{layoutPointer:o,modulesByArea:t,rawModulesByArea:r}=e,n=(0,l().EX)(t,(e=>"relationsGroup"===e.type));if("form_conditional_modules"===(null==n?void 0:n.position.area))return;const s=r&&(0,l().LC)(r,(e=>"relationsGroup"===e.type));if(!n)return;if(n&&s)return;const u=n.module;if(!u||"relationsGroup"!==u.type)throw new Error("relations group module location in normalized was incorrect, cannot backfill relations group module");return function(e){var o;const{module:t,modulesByArea:r,layoutPointer:n}=e,s=(0,l().JO)(r,(e=>e.id===t.id));if(!s)throw new Error("cannot upsert module at current position because module does not have a current position");if("form_conditional_modules"===s.area)throw new Error("[Forms Conditional Logic Not Implemented] form_conditional_modules area is not supported for adding and moving modules");const u="views_main_tab_modules"===s.area?null===(o=r.views_main_tab_modules)||void 0===o?void 0:o[s.viewId]:r[s.area];if(!u||0===u.length)throw new Error("cannot upsert module at current position in area because that area is empty");const c={module:(0,d().Lv)(t),pointer:n,..."views_main_tab_modules"===s.area?{area:a().Zm[s.area],viewId:s.viewId}:{area:a().Zm[s.area]}};if(0===s.index)return i().N4X.putModuleAfter({...c,afterId:void 0});const m=u.at(s.index+1);if(!m)return i().N4X.putModuleAfter({...c,afterId:void 0});return i().N4X.putModuleBefore({...c,beforeId:m.id})}({module:u,layoutPointer:o,modulesByArea:t})}({layoutPointer:g,modulesByArea:I,rawModulesByArea:b}):null;S&&v().createAndCommitOrAppend({environment:o,perform:e=>{v().applyOperation({transaction:e,store:r,operation:S})},canUndo:!0,transaction:c,userAction:`${m||"BuilderLayoutModules.upsert"}.preOpBackfill`});const M=[],C=function(e){const{layoutStore:o,module:t,upsertPosition:r}=e,n=o.getModules(),s=(0,l().JO)(n,(e=>t.id===e.id));if(!s)return;if("form_conditional_modules"===s.area)return i().N4X.deleteModuleInArea({pointer:o.pointer,area:s.area,moduleId:t.id});if("views_main_tab_modules"===s.area){const e="absolute"===r.type&&"views_main_tab_modules"===r.area?r.viewId:void 0,n=s.viewId;if(e===n)return;return i().N4X.deleteModuleInArea({pointer:o.pointer,area:s.area,moduleId:t.id,viewId:n})}if("page_main"===s.area||"page_details"===s.area||"form_layout_schema"===s.area||"person_profile_page_main"===s.area||"person_profile_page_details"===s.area||"dashboard_layout_schema"===s.area){if(s.area===r.area)return;return i().N4X.deleteModuleInArea({pointer:o.pointer,area:a().Zm[s.area],moduleId:t.id})}(0,f().HB)(s.area)}({upsertPosition:t,module:n,layoutStore:r});C&&M.push(C);const x=function(e){const{upsertPosition:o,layoutPointer:t,modulesByArea:r,rawModuleToUpsert:n}=e;if("absolute"===o.type)return function(e){const{upsertPosition:o,rawModuleToUpsert:t,layoutPointer:r,modulesByArea:n}=e,d=(0,l().JO)(n,(e=>t.id===e.id)),{area:c}=o;if("form_conditional_modules"===c){const{parentConditionalGroupId:e,parentModuleId:a}=o;if(!(0,u().V)(t,"form_conditional_modules"))throw new Error("Can only add form question or placeholder modules to form_conditional_modules area.");const d=(0,l().Ib)({modulesByArea:n,find:e=>e.id===t.parentModuleId}),c=(0,s().A)(a,n);return i().N4X.upsertChildModule({pointer:r,module:t,previousParentModuleAndArea:d,newParentModule:{area:c.area,module:c.module,conditionalGroupId:e,index:o.index},modulesByArea:n})}const m=o.index;if(m<0)throw new Error(`Cannot upsert module with id ${t.id} to a negative position`);if("views_main_tab_modules"===c){const e=o.viewId;if(!n[c]||!n[c][e])throw new Error("Cannot upsert module into views_main_tab_modules area that does not have views");const s="views_main_tab_modules"===(null==d?void 0:d.area)&&(null==d?void 0:d.viewId)===e?d.index:void 0,l=_({modulesInArea:n[c][e],indexOfModuleToUpsertInArea:s,indexToUpsertTo:m});if(!l)return;return[i().N4X.putModuleBeforeOrAfter({pointer:r,area:a().Zm[c],viewId:e,module:t,direction:l.insertDirection,beforeOrAfterId:l.beforeOrAfterId})]}const p=n[c]??[],f=(null==d?void 0:d.area)===c?d.index:void 0,v=_({modulesInArea:p,indexOfModuleToUpsertInArea:f,indexToUpsertTo:m});if(!v)return;return[i().N4X.putModuleBeforeOrAfter({pointer:r,area:a().Zm[c],module:t,direction:v.insertDirection,beforeOrAfterId:v.beforeOrAfterId})]}({upsertPosition:o,rawModuleToUpsert:n,layoutPointer:t,modulesByArea:r});if("module_relative"===o.type)return[w({upsertPosition:o,rawModuleToUpsert:n,layoutPointer:t,modulesByArea:r})];if("area_relative"===o.type)return[A({upsertPosition:o,rawModuleToUpsert:n,layoutPointer:t,modulesByArea:r})];(0,f().HB)(o)}({module:n,upsertPosition:t,modulesByArea:I,layoutPointer:g,rawModuleToUpsert:h});x&&M.push(...x);const T="placeholder"===n.type&&"form_layout_schema"===t.area?`form_layout_new_question_${n.id}`:void 0;v().createAndCommitOrAppend({environment:o,undoCheckpoint:T,canUndo:!0,perform:e=>{p&&p({transaction:e});for(const o of M)v().applyOperation({transaction:e,store:r,operation:o})},transaction:c,userAction:m||"BuilderLayoutModules.upsert"}),y&&y()}function _(e){const{modulesInArea:o,indexOfModuleToUpsertInArea:t,indexToUpsertTo:r}=e;if(0===r||0===o.length)return{insertDirection:"before",beforeOrAfterId:void 0};const n=o.at(r);return n?void 0===t?{insertDirection:"before",beforeOrAfterId:n.id}:t!==r?t<r?{insertDirection:"after",beforeOrAfterId:n.id}:{insertDirection:"before",beforeOrAfterId:n.id}:void 0:{insertDirection:"after",beforeOrAfterId:void 0}}function w(e){const{upsertPosition:o,rawModuleToUpsert:t,layoutPointer:r,modulesByArea:n}=e,{area:s,direction:d,relativeToModuleId:u}=o,c=a().Zm[s],m=(0,l().JO)(n,(e=>e.id===u));if(!m||m.area!==s)throw new Error(`Cannot find module with id: ${u} to add upsert relative to in ${s}`);if("views_main_tab_modules"===c){const e="views_main_tab_modules"===m.area?m.viewId:void 0;if(!e)throw new Error("Cannot upsert module into views_main_tab_modules area that does not have views");return i().N4X.putModuleBeforeOrAfter({pointer:r,area:"views_main_tab_modules",viewId:e,module:t,direction:"above"===d?"before":"after",beforeOrAfterId:u})}return i().N4X.putModuleBeforeOrAfter({pointer:r,area:c,module:t,direction:"above"===d?"before":"after",beforeOrAfterId:u})}function A(e){const{upsertPosition:o,rawModuleToUpsert:t,layoutPointer:r,modulesByArea:n}=e,{location:s}=o;if("views_main_tab_modules"===o.area){const e=o.viewId,l={pointer:r,area:a().Zm[o.area],viewId:e,module:t};if("start"===s||"end"===s)return i().N4X.putModuleBeforeOrAfter({...l,direction:"start"===s?"before":"after",beforeOrAfterId:void 0});if("end_moveable"===s){var d;const e=S({area:o.area,modulesInArea:(null===(d=n.views_main_tab_modules)||void 0===d?void 0:d[o.viewId])??[]});return i().N4X.putModuleBeforeOrAfter({...l,direction:e.insertDirection,beforeOrAfterId:e.beforeOrAfterId})}(0,f().HB)(s)}const l={pointer:r,area:a().Zm[o.area],module:t};if("start"===s||"end"===s)return i().N4X.putModuleBeforeOrAfter({...l,direction:"start"===s?"before":"after",beforeOrAfterId:void 0});if("end_moveable"===s){const e=n[o.area]??[],t=S({area:o.area,modulesInArea:e});return i().N4X.putModuleBeforeOrAfter({...l,direction:t.insertDirection,beforeOrAfterId:t.beforeOrAfterId})}(0,f().HB)(s)}function S(e){const{area:o,modulesInArea:t}=e,n=r().default.checkGate({gateName:"bottom_page_discussions_enabled"}),i=(0,c().jS)(o,t,n),a=i.nonMoveableHeaderModules,s=i.nonMoveableFooterModules,d=i.moveableModules,l="moveableCenterModules"in i?i.moveableCenterModules:[],u="moveableFooterModules"in i?i.moveableFooterModules:[];if(!n&&d.length){const e=(0,p().HV)(d);if(!e)throw new Error("cannot find last moveable module to add below for end moveable");return{insertDirection:"after",beforeOrAfterId:e.id}}if(n&&l.length){const e=(0,p().HV)(l);if(!e)throw new Error("cannot find last moveable center module to add below for end moveable");return{insertDirection:"after",beforeOrAfterId:e.id}}if(a.length){const e=(0,p().HV)(a);if(!e)throw new Error("cannot find last header module to add below for end moveable");return{insertDirection:"after",beforeOrAfterId:e.id}}if(n&&u.length){const e=u.at(0);if(!e)throw new Error("cannot find first moveable footer module to add above for end moveable");return{insertDirection:"before",beforeOrAfterId:e.id}}if(!n&&s.length){const e=s.at(0);if(!e)throw new Error("cannot find first non-moveable footer module to add above for end moveable");return{insertDirection:"before",beforeOrAfterId:e.id}}return{insertDirection:"after",beforeOrAfterId:void 0}}}}]);