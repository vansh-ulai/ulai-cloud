"use strict";(globalThis.webpackChunknotion_next=globalThis.webpackChunknotion_next||[]).push([[8836,53141,60718],{81986:(e,t,o)=>{o.d(t,{MI:()=>r,QT:()=>n,VD:()=>i});o(16280),o(898992),o(737550);const n=[{featureGates:["agent_model_picker"],id:"agent_model_picker",label:"Model picker",group:"default"},{featureGates:["agent_transcription"],id:"agent_transcription",label:"Transcription",group:"default"},{featureGates:["agent_multidb_creation"],id:"agent_multidb_creation",label:"Multi-source databases",group:"default"},{featureGates:["agent_support_linked_databases"],id:"agent_support_linked_databases",label:"Linked Database Support",group:"default"},{featureGates:["custom_agents"],id:"custom_agents",label:"Custom agents",group:"default"},{featureGates:["agent_automations"],id:"agent_automations",label:"Automations",group:"default"},{featureGates:["agent_comments"],id:"agent_comments",label:"Comments",group:"default"},{featureGates:["agent_create_form"],id:"agent_create_form",label:"Forms",group:"default"},{featureGates:["agent_integrations","workflows_mail_module_available","workflows_zendesk_module_available"],id:"agent_integrations",label:"Integrations",group:"default"},{featureGates:["agent_makes_formulas"],id:"agent_makes_formulas",label:"Formulas",group:"default"},{featureGates:["agent_user_session_context"],id:"agent_user_session_context",label:"User session context",group:"default"},{featureGates:["workflows_github_module_available","workflows_mcp_server_module_available","workflows_pipedream_module_available"],id:"experimental_integrations",label:"Experimental integrations",group:"advanced"},{featureGates:["background_agents"],id:"background_agents",label:"Background agents",group:"advanced"},{featureGates:["database_agents"],id:"database_agents",label:"Database agents",group:"advanced"},{featureGates:["ai_data_enrichment"],id:"ai_data_enrichment",label:"AI Data Enrichment",group:"advanced"},{featureGates:["mention_agents_in_notion"],id:"mention_agents_in_notion",label:"Mention Agents in Notion",group:"advanced"},{featureGates:["future_ai_interfaces"],id:"future_ai_interfaces",label:"Future AI Interfaces",group:"advanced"}];n.filter((e=>"agent_model_picker"===e.id||"agent_transcription"===e.id||"custom_agents"===e.id||"agent_automations"===e.id||"agent_integrations"===e.id||"agent_create_form"===e.id||"agent_multidb_creation"===e.id||"mention_agents_in_notion"===e.id));function r(e,t){return e.featureGates.some((e=>t(e)))}function i(e){const t=n.find((t=>t.id===e));if(!t)throw new Error(`Feature gate group with id ${e} not found`);return t}},101926:(e,t,o)=>{o.d(t,{ai:()=>oe,xN:()=>ae,e_:()=>ne,Ix:()=>ie,Z5:()=>se});o(898992),o(672577);var n=()=>o(663077),r=()=>o(792071),i=()=>o(869558),a=()=>o(144081),s=()=>o(496603),c=()=>o(534177),l=()=>o(873039),d=()=>o(231297),p=()=>o(414360),u=()=>o(586481),m=()=>o(913530),f=()=>o(808655),v=(o(354520),()=>o(913454)),h=()=>o(204067);function g({environment:e,collectionStore:t,collectionViewValue:o,dependencyMap:r,logger:i}){var a;if((0,v().remapPropertyIds)({collectionStore:t,object:o,dependencyMap:r}),function({environment:e,spaceId:t,collectionViewValue:o,logger:n}){for(const a of(null===(r=o.format)||void 0===r?void 0:r.collection_groups)??[]){var r,i;const{value:o}=a;if(("created_by"===o.type||"last_edited_by"===o.type)&&"notion_user"===(null===(i=o.value)||void 0===i?void 0:i.table)){const r=e.currentUser.id;if(!r){n.warn("No current user ID, unable to remap collection group user to current user!");continue}n.log(`Remapping user ID ${o.value.id} to ${r} in collection view group.`),o.value.id=r,o.value.spaceId=t}}}({environment:e,spaceId:t.getSpaceId(),collectionViewValue:o,logger:i}),o.query2&&function({collectionStore:e,query2:t,dependencyMap:o}){for(const r of n().Nf){const n=t[r];n&&(t[r]=(0,h().CB)({collectionStore:e,sourceTemplateType:"property",dependencyMap:o,sourcePrimitiveId:n}))}}({collectionStore:t,query2:o.query2,dependencyMap:r}),"object"==typeof(null===(a=o.format)||void 0===a?void 0:a.collection_view_default_template)){const e=(0,h().fI)({collectionStore:t,sourceTemplateType:"block",dependencyMap:r,sourcePrimitiveId:o.format.collection_view_default_template.template_page_id});e?o.format.collection_view_default_template={template_page_id:e}:(i.warn("Unable to resolve collection_view default template, omitting it."),delete o.format.collection_view_default_template)}}function S({collectionViewFormat:e}){const t=null==e?void 0:e.table_properties;t&&(e.table_properties=t.filter((e=>!(0,h().TE)(e.property))))}var _=()=>o(731638),y=(o(581454),o.n(o(794148))),w=()=>o(726637),I=()=>o(192845),b=()=>o(239381),T=()=>o(206267),k=()=>o(884173),C=()=>o(696706),A=()=>o(912720),M=()=>o(199378),P=()=>o(179034),x=()=>o(519831),R=()=>o(798880),N=()=>o(324587),E=()=>o(594794),V=()=>o(972435);function O({collectionStore:e,environment:t,logger:o,template:n,transaction:i}){const a=function({environment:e,logger:t,parentStore:o,template:n,transaction:i}){const a=(0,E().zP)({environment:e,spaceId:o.getSpaceId(),table:A().yB}),s=e.currentUser.id,c=r().Bj6.fromAutomation({alive:!0,created_by_id:s??"",created_by_table:R().oo,created_time:Date.now(),id:a.id,parent_id:o.pointer.id,parent_table:o.pointer.table,space_id:o.getSpaceId(),trigger:{...n.value.trigger,id:T().JW()},version:0,last_edited_by_id:s??"",last_edited_by_table:R().oo,last_edited_time:Date.now(),status:"active"}),l=F({actionPlaceholderIdToActionId:new Map,collectionStore:o,dependencyMap:n.dependencyMap,logger:t}),{value:d}=(0,I().n)({automationModel:c,visitors:l}),p=d.getTrigger(),u=N().createAutomation({actionIds:[],environment:e,automationId:a.id,automationName:n.value.name,parentPointer:o.getSpaceShardedPointer(),transaction:i,trigger:p});return u}({environment:t,logger:o,parentStore:e,template:n,transaction:i}),s=new Map;return n.value.actions.map((r=>function({actionPlaceholderIdToActionId:e,actionTemplate:t,collectionStore:o,environment:n,logger:r,parentStore:i,parentTemplate:a,transaction:s}){const c=(0,E().zP)({environment:n,spaceId:i.getSpaceId(),table:M().SC}),{config:l,placeholderId:d,type:p}=t,{model:u}=k().RU.create({alive:!0,config:l,id:c.id,parent_id:i.pointer.id,parent_table:i.pointer.table,space_id:o.getSpaceId(),type:p,version:0}),m=F({actionPlaceholderIdToActionId:e,collectionStore:o,dependencyMap:a.dependencyMap,logger:r}),{value:f}=(0,I().G)({automationActionModel:u,baseUrl:w().A.domainBaseUrl,preventClearingConfig:!0,publicDomainName:w().A.publicDomainName,sourceSpaceId:o.getSpaceId(),visitors:m}),v=f.getConfig(),h=N().addAutomationAction({actionId:c.id,actionType:t.type,automationStore:i,config:v,createDuplicateBlocksContainer:!0,environment:n,intl:V().A.getIntl(),transaction:s});return y()(h,"Failed to create automation action"),e.set(d,h.id),h}({actionPlaceholderIdToActionId:s,actionTemplate:r,collectionStore:e,environment:t,logger:o,parentStore:a,parentTemplate:n,transaction:i}))),a.isTriggerType("event")&&d().applyOperation({store:e,operation:{pointer:e.pointer,path:["format","automation_ids"],command:"listAfter",args:{id:a.id}},transaction:i}),{id:a.id,spaceId:e.getSpaceId(),type:"automation"}}function F(e){const{actionPlaceholderIdToActionId:t,collectionStore:o,dependencyMap:n,logger:r}=e;function a(e){const o=(0,b().y5)(e);if("action"===o.source){const e=t.get(o.action_id)??o.action_id;return(0,b().$y)({...o,action_id:e})}if("global"===o.source)return e;(0,c().HB)(o)}function l(e){if(!n)return;if("title"===e)return e;const t=(0,h().fI)({collectionStore:o,sourceTemplateType:"property",sourcePrimitiveId:e,dependencyMap:n});return t||r.warn(`Failed to remap property ID ${e} in automation template`),t}return{visitCollectionProperty:e=>n?{type:"replace",value:l(e)}:{type:"keep"},visitCollectionPropertyPointer:e=>{if(!n)return{type:"keep"};const t=l(e.propertyId);if(!t)return{type:"replace",value:void 0};const i=(0,h().fI)({collectionStore:o,sourceTemplateType:"collection",sourcePrimitiveId:e.id,dependencyMap:n});return i?{type:"replace",value:{id:i,propertyId:t,spaceId:o.getSpaceId(),table:x().Vl}}:(r.warn(`Failed to remap collection ID ${e.id} in automation template`),{type:"replace",value:void 0})},visitFormulaContextValue:e=>({type:"replace",value:a(e)}),visitFormulaPageProperty:e=>{if(!n)return{type:"keep"};const t=(0,s().mg)(e),i=l(e.property);if(!i)return{type:"replace",value:void 0};if(t.property=i,"collection"in t&&t.collection){const e=(0,h().fI)({collectionStore:o,sourceTemplateType:x().Vl,sourcePrimitiveId:t.collection.id,dependencyMap:n});if(!e)return r.warn(`Failed to remap collection ID ${t.collection.id} in automation template`),{type:"replace",value:void 0};t.collection=C().L3.fromSpaceShardRecordId({id:e,spaceId:o.getSpaceId()},x().Vl)}else"contextValueId"in t&&t.contextValueId&&(t.contextValueId=a(t.contextValueId));return{type:"replace",value:t}},visitRecordPointer:e=>{if(!n)return{type:"keep"};if(e.table===P().ev||e.table===x().Vl||e.table===A().yB||e.table===i().Gy){const t=(0,h().fI)({collectionStore:o,sourceTemplateType:e.table,sourcePrimitiveId:e.id,dependencyMap:n});return t?{type:"replace",value:C().L3.fromSpaceShardRecordId({id:t,spaceId:o.getSpaceId()},e.table)}:(r.warn(`Failed to remap record pointer ${C().L3.toKey(e)} in automation template`),{type:"replace",value:void 0})}return{type:"keep"}}}}o(16280);var B=()=>o(388821),D=()=>o(722101),U=()=>o(44729),W=()=>o(949653);var L=()=>o(253141),q=(o(944114),o(803949),()=>o(384944));function G({environment:e,transaction:t,collectionStore:o,template:n,logger:r,preserveCollectionFeatureOrdering:a}){const s=o.getParentBlockStore();if(!s)throw new Error("Collection view block store not found");const{value:c,dependencyMap:l}=n;if(!l)throw new Error("Dependency map not defined on view template");g({environment:e,collectionStore:o,collectionViewValue:c,dependencyMap:l,logger:r}),function({collectionStore:e,collectionViewValue:t}){var o;const n=null===(o=t.format)||void 0===o?void 0:o.table_properties;if(!n)return;const r=n.map((e=>e.property)),i=Object.keys(e.getSchema()).filter((e=>!r.includes(e)));for(const a of i)n.push({property:a,visible:!1})}({collectionStore:o,collectionViewValue:c});const d=q().eC({environment:e,table:i().Gy,inMemoryRecordCache:s.inMemoryRecordCache,value:{...c,parent_id:s.id,parent_table:s.table,space_id:s.getSpaceId(),format:{...c.format,collection_pointer:o.pointer},alive:!0},transaction:t}),p=m().p.createChildStore(s,d.pointer),u=s.getCollectionViewsStore();if(a){const e=function({collectionTemplate:e,collectionViewStores:t,collectionViewTemplate:o}){let n,r=-1;const i=e.value.templateItems.findIndex((e=>e.pointer===o.templateId));return t.forEach((t=>{var o;const a=null===(o=t.getFormat().workflow_template_instance)||void 0===o?void 0:o.template_id;if(!a)return;const s=e.value.templateItems.findIndex((e=>e.pointer===a));s>i||s>r&&(r=s,n=t.id)})),n}({collectionTemplate:a,collectionViewStores:s.getCollectionViewStores(),collectionViewTemplate:n});e?D().BC({parentStore:u,appendStore:p,transaction:t,after:e}):D().Hs({parentStore:u,prependStore:p,transaction:t})}else D().BC({parentStore:u,appendStore:p,transaction:t});return{type:"collection_view",id:p.id}}var z=()=>o(498212);var $=()=>o(220719),Q=()=>o(447934);var H=()=>o(536095),K=()=>o(443881),j=()=>o(931075),Z=()=>o(183558),X=()=>o(312296);function J(e){const{environment:t,logger:o,transaction:r,collectionStore:i,template:a}=e,c=function(e){if("title"===e.value.type)return"title";if(e.templateId===H().RE)return j()._e.Verification;if(e.templateId===H().dr)return j()._e.Owner;return(0,Z().Ay)()}(a);if((0,n().PC)(a,"formula"))Y({...e,template:a});else if((0,n().Ox)(a)){const t=v().globalWorkflowTemplates.featureFromId(a.buttonAutomationId);o.log(`Instantiating dependency "${t.templateId}" of button property template "${a.templateId}".`);const n=ne({...e,template:t});if(!n)throw new Error(`Failed to create instance of automation template "${t.templateId}"`);if("automation"!==n.type)throw new Error(`Unexpected instance pointer. Expected "automation" but got "${n.type}"`);a.value.automation_id=n.id}const l=(0,s().mg)(a.value);return l.workflow_template_instance={template_id:a.templateId},(0,X().F)({environment:t,collectionStore:i,update:{[c]:l},transaction:r}),{type:"property",id:c,collectionId:i.id}}function Y({template:e,collectionStore:t}){const{value:o,dependencyMap:n}=e;if(!n)return;if(!o.formula2)return;const{value:r}=(0,K().RI)({baseUrl:w().A.domainBaseUrl,formula:o.formula2.code,publicDomainName:w().A.publicDomainName,spaceId:t.getSpaceId(),visitors:{visitFormulaContextValue:void 0,visitFormulaPageProperty:e=>{const o={...e};return o.property=(0,h().CB)({dependencyMap:n,collectionStore:t,sourcePrimitiveId:e.property,sourceTemplateType:"property"}),"collection"in o&&o.collection&&(o.collection=t.pointer),{type:"replace",value:o}},visitRecordPointer:void 0}});o.formula2.code=r}var ee=()=>o(290966),te=()=>o(839754);function oe({environment:e,transaction:t,collectionStore:o,template:n,logger:r,origin:i,examplePageStores:a,preserveCollectionFeatureOrdering:s}){const c=ne({transaction:t,environment:e,collectionStore:o,template:n,logger:r,origin:i,preserveCollectionFeatureOrdering:s}),l=(0,v().getPropertyTemplates)([n]);return(0,te().My)({transaction:t,collectionStore:o,propertyTemplates:l}),(0,te().Bi)({transaction:t,collectionStore:o,propertyTemplates:l}),ie({environment:e,transaction:t,collectionStore:o,template:n,logger:r,examplePageStores:a}),c}function ne(e){const{collectionStore:t,template:o,transaction:r}=e;!function(e){const{template:t,logger:o}=e,r=(0,n().Z6)({template:t,logger:o}),{environment:i,collectionStore:a}=e;for(const n of r){(0,h().Zp)({environment:i,scopeStore:a,templateId:n.templateId})||(o.log(`Template "${t.templateId}" has implicit dependency "${n.templateId}" (source: ${n.debugSource}), instantiating it.`),ne({...e,template:v().globalWorkflowTemplates.featureFromId(n.templateId)}))}}(e);const i=function(e){const{logger:t}=e,o=s().mg(e.template),{type:r}=o;switch(t.log(`Instantiating ${r} template "${o.templateId}".`),r){case"property":return J({...e,template:o});case"collection_view":return G({...e,template:o});case"layout":return function({environment:e,transaction:t,collectionStore:o,template:n}){if(!n.dependencyMap)throw new Error("Dependency map not defined on layout template");const r=(0,_().f)({collectionStore:o,modules:{page_layout_schema:void 0,page_info_layout_schema:void 0,form_layout_schema:void 0,person_profile_page_main:void 0,person_profile_page_details:void 0,...n.value},dependencyMap:n.dependencyMap}),{model:i}=(0,Q().$L)({environment:e,transaction:t,collectionStore:o,userId:(0,$().o9)(e.currentUser.id),modules:r});return{type:"layout",id:i.id,spaceId:o.getSpaceId()}}({...e,template:o});case"compound":return function(e){const{environment:t,template:o,collectionStore:r,logger:i}=e,a=[],s=e=>{if(!(0,h().DM)(e)||"compound"===e.type)throw new Error(`Template in compound template generated a non-feature instance pointer of an illegal type: ${e.type}`);a.push(e)};for(const c of o.value.templateItems){const{optionality:a,pointer:l}=c;if("optionalDefaultOff"===a)continue;const d=(0,h().Zp)({environment:t,scopeStore:r,templateId:c.pointer});if(d){s(d);continue}const p=v().globalWorkflowTemplates.fromId(l);if(!(0,n().$K)(p))throw new Error(`${p.templateId} in compound template is of an illegal type: ${p.type}`);i.log(`Instantiating dependency "${p.templateId}" of compound template "${o.templateId}".`);const u=oe({...e,template:p});u&&s(u)}return{type:"compound",id:(0,z().Ay)(),instancePointers:a,collectionId:r.id}}({...e,template:o});case"block":return function({environment:e,transaction:t,collectionStore:o,template:n}){const r=(0,E().zP)({environment:e,spaceId:o.getSpaceId(),table:P().ev});if("block"!==n.type)throw new Error(`Expected block template, got ${n.type} template: ${n.templateId}`);if(!n.dependencyMap)throw new Error(`Dependency map not defined on block template: ${n.templateId}`);const{dependencyMap:i}=n,a=B().RecordMap.create(n.value.recordMap),s=a.getModel(n.value.blockPointer);if(s){const e=s.getProperties();for(const[t,n]of Object.entries(e)){const r=(0,h().CB)({collectionStore:o,sourceTemplateType:"property",sourcePrimitiveId:t,dependencyMap:i});r&&(delete e[t],e[r]=n)}}const{targetBlockStore:c}=(0,W().localDuplicate)({environment:e,sourceBlockId:n.value.blockPointer.id,targetBlockPointer:r,sourceBlockSubtree:a,transaction:t,targetInMemoryRecordCache:o.inMemoryRecordCache,from:"create_block_template",options:{allowRedundancy:!0,deepCopyTransclusionContainers:!1,resolveTemplateVariables:!1}});return U().X$({childStore:c,parentStore:o,transaction:t}),c.isTemplate()&&D().BC({parentStore:o.getTemplatePagesStore(),appendStore:c,transaction:t}),{type:"block",id:c.id,spaceId:o.getSpaceId()}}({...e,template:o});case"automation":return O({...e,template:o});default:(0,c().HB)(r)}}(e);return i&&(0,ee().ZQ)({transaction:r,collectionStore:t,templateId:o.templateId,instance:i,logger:e.logger}),i}function re({environment:e,transaction:t,collectionStore:o,template:n,instancePointer:r,examplePageStores:i}){if(i&&"property"===r.type)for(const a of i){const r=(0,L().gv)({collectionStore:o,dependencyMap:n.dependencyMap??{},exampleRow:{properties:a.getProperties()}});(0,u().L)({environment:e,store:a,properties:r.properties,transaction:t})}}function ie({environment:e,transaction:t,collectionStore:o,template:n,logger:s,examplePageStores:c}){const l=(0,h().Sl)({environment:e,collectionStore:o});for(const{instancePointer:p,templateId:u}of l){if("collection"===p.type)continue;const l=v().globalWorkflowTemplates.fromId(u),h=l.dependencyMap&&Object.values(l.dependencyMap).includes(n.templateId);if(!("dependencyMap"in l)||!l.dependencyMap||!h){re({environment:e,transaction:t,collectionStore:o,template:n,examplePageStores:c,instancePointer:p});continue}s.log(`Remapping dependency "${n.templateId}" in "${u}".`);const S={};if("layout"===p.type){const e=f().K.createChildStore(o,{table:a().zx,id:p.id,spaceId:p.spaceId}),n=e.getRawModules();if(n){const i=(0,_().f)({collectionStore:o,modules:n,dependencyMap:S});d().applyOperation({transaction:t,store:e,operation:r().N4X.updateModules(e.pointer,i)})}}else if("collection_view"===p.type){const t=m().p.createChildStore(o,{table:i().Gy,id:p.id}),n=t.getType();if(!n)continue;g({environment:e,collectionStore:o,collectionViewValue:{type:n,name:t.getName(),format:t.getFormat(),query2:t.getRawQuery()},dependencyMap:S,logger:s})}else s.warn(`Don't know how to remap instance type "${p.type}"!`)}}function ae({environment:e,collectionStore:t}){const o=(0,h().Sl)({environment:e,collectionStore:t});for(const{instancePointer:n}of o)if("collection_view"===n.type){const e=m().p.createChildStore(t,{table:i().Gy,id:n.id});if(!e.getType())continue;S({collectionViewFormat:e.getFormat()})}}function se({environment:e,transaction:t,collectionViewBlockStore:o,collectionStore:n,instancePointer:r}){const i=r.type;switch(i){case"property":(0,l().B)({environment:e,collectionStore:n,schema:n.getSchema(),property:r.id,transaction:t,permanentlyDelete:!1});break;case"collection_view":if(!o)return;const a=o.getCollectionViewStores().find((e=>e.id===r.id));a&&(0,p().T)({collectionViewBlockStore:o,collectionViewStore:a,transaction:t});break;case"layout":case"block":case"automation":break;default:(0,c().HB)(i)}}},107527:(e,t,o)=>{o.d(t,{Hp:()=>rt,VG:()=>Je,Vn:()=>We,aP:()=>Oe,vy:()=>Be,fI:()=>tt,WF:()=>Ye,zf:()=>He,Wq:()=>Ve,Pz:()=>Le,WE:()=>$e,kh:()=>et,D5:()=>De,GS:()=>Ue,g6:()=>Fe,ki:()=>Ge,D7:()=>qe,Cx:()=>nt,zS:()=>ot});o(16280),o(410838),o(813451),o(944114),o(898992),o(354520),o(672577),o(430670),o(803949),o(581454),o(964979);var n=o(296540),r=()=>o(242422),i=()=>o(726637),a=()=>o(484714),s=()=>o(56366),c=()=>o(496506),l=()=>o(365646),d=()=>o(592933),p=()=>o(241178),u=()=>o(362750),m=()=>o(878456),f=()=>o(165358),v=()=>o(386164),h=()=>o(134025),g=()=>o(388821),S=()=>o(728272),_=()=>o(179034),y=()=>o(234459),w=()=>o(155792),I=()=>o(201980),b=()=>o(439180),T=()=>o(724639),k=()=>o(532659);class C extends Error{constructor(e,t,o){super(e),this.operation=t,this.path=o,this.name="JsonPatchError"}static isJSONPatchError(e){return e instanceof C}}class A extends C{constructor(e){super(`Invalid operation: ${e.op}`,e),this.name="InvalidOperationError"}}class M extends C{constructor(e,t){super(`Invalid path: ${e}`,t,e),this.name="InvalidPathError"}}class P extends C{constructor(e,t){super(`Path not found: ${e} for operation ${null==t?void 0:t.op}`,t,e),this.name="PathNotFoundError"}}class x extends C{constructor(e,t,o,n){super(`Test operation failed at ${e}: expected ${JSON.stringify(o)}, got ${JSON.stringify(t)}`,n,e),this.actual=t,this.expected=o,this.name="TestFailedError"}}class R extends C{constructor(e,t,o){super(`Invalid move operation: cannot move ${e} into its child ${t}`,o,e),this.name="InvalidMoveError"}}class N extends C{constructor(e){super(`Unknown compressed operation type: ${e}`),this.name="InvalidCompressionError"}}class E extends C{constructor(e,t,o){super(`Expected string for ${e} operation 'from' field, got ${t}`,o),this.name="InvalidOperationTypeError"}}o(823215);function V(e){return e.replace(/~1/g,"/").replace(/~0/g,"~")}function O(e){return e.replace(/~/g,"~0").replace(/\//g,"~1")}class F{constructor(e=[""]){this.tokens=void 0,this.tokens=e}static parse(e){if(!e.startsWith("/")&&""!==e)throw new M(e);if(""===e)return new F([""]);const t=e.split("/").map(V);return new F(t)}static fromTokens(e){return new F(["",...e])}toString(){return 1===this.tokens.length&&""===this.tokens[0]?"":this.tokens.map(O).join("/")}getTokens(){return this.tokens.slice(1)}append(e){return new F([...this.tokens,e])}prepend(e){return new F(["",e,...this.tokens.slice(1)])}parent(){if(!(this.tokens.length<=1))return new F(this.tokens.slice(0,-1))}lastToken(){return this.tokens.length>1?this.tokens[this.tokens.length-1]:void 0}isPrefixOf(e){return!(this.tokens.length>=e.tokens.length)&&this.tokens.every(((t,o)=>t===e.tokens[o]))}evaluate(e){if(1===this.tokens.length&&""===this.tokens[0])return{parent:void 0,key:"",value:e,exists:!0};let t,o=e,n="";for(let i=1;i<this.tokens.length&&(n=this.tokens[i],i!==this.tokens.length-1);i++){if(null==o)return{parent:void 0,key:n,value:void 0,exists:!1};if("__proto__"===n||"constructor"===n||"prototype"===n)return{parent:void 0,key:n,value:void 0,exists:!1};if(Array.isArray(o)){if("-"===n)return{parent:void 0,key:n,value:void 0,exists:!1};const e=parseInt(n,10);if(isNaN(e)||e<0||!Number.isInteger(e))return{parent:void 0,key:n,value:void 0,exists:!1};if(e>=o.length)return{parent:void 0,key:n,value:void 0,exists:!1};o=o[e]}else{if("object"!=typeof o||null===o)return{parent:void 0,key:n,value:void 0,exists:!1};if(!(n in o))return{parent:void 0,key:n,value:void 0,exists:!1};o=o[n]}}let r=!1;if(null==o)r=!1;else if("__proto__"===n||"constructor"===n||"prototype"===n)r=!1;else if(Array.isArray(o))if("-"===n)r=!1;else{const e=parseInt(n,10);isNaN(e)||e<0||!Number.isInteger(e)||e>=o.length?r=!1:(t=o[e],r=!0)}else if("object"==typeof o&&null!==o){n in o?(t=o[n],r=!0):r=!1}else r=!1;return{parent:o,key:n,value:t,exists:r}}get(e){return this.evaluate(e).value}exists(e){return this.evaluate(e).exists}}var B=()=>o(496603);function D(e){return(0,B().mg)(e)}function U(e,t){const o=F.parse(t.path).evaluate(e);if(""===t.path)return D(t.value);if(!o.parent||null===o.parent||void 0===o.parent)throw new P(t.path,t);const n=o.parent,r=o.key;if(Array.isArray(n))if("-"===r)n.push(D(t.value));else{const e=parseInt(r,10);if(isNaN(e)||e<0||!Number.isInteger(e))throw new P(t.path,t);if(e>n.length)throw new P(t.path,t);n.splice(e,0,D(t.value))}else{if("object"!=typeof n||null===n)throw new P(t.path,t);n[r]=D(t.value)}return e}function W(e,t){const o=F.parse(t.path).evaluate(e);if(""===t.path)throw new P(t.path,t);if(!o.exists)throw new P(t.path,t);if(!o.parent)throw new P(t.path,t);const n=o.parent,r=o.key;if(Array.isArray(n)){const e=parseInt(r,10);if(isNaN(e)||e<0||e>=n.length)throw new P(t.path,t);n.splice(e,1)}else{if("object"!=typeof n||null===n)throw new P(t.path,t);delete n[r]}return e}function L(e,t){switch(t.op){case"add":return U(e,t);case"remove":return W(e,t);case"replace":return function(e,t){const o=F.parse(t.path).evaluate(e);if(""===t.path)return D(t.value);if(!o.exists)throw new P(t.path,t);if(!o.parent)throw new P(t.path,t);const n=o.parent,r=o.key;if(Array.isArray(n)){const e=parseInt(r,10);if(isNaN(e)||e<0||e>=n.length)throw new P(t.path,t);n[e]=D(t.value)}else{if("object"!=typeof n||null===n)throw new P(t.path,t);n[r]=D(t.value)}return e}(e,t);case"move":return function(e,t){const o=F.parse(t.from),n=F.parse(t.path);if(o.isPrefixOf(n))throw new R(t.from,t.path,t);const r=o.evaluate(e);if(!r.exists)throw new P(t.from,t);const i=r.value;return W(e,{op:"remove",path:t.from}),U(e,{op:"add",path:t.path,value:i}),e}(e,t);case"copy":return function(e,t){const o=F.parse(t.from).evaluate(e);if(!o.exists)throw new P(t.from,t);return U(e,{op:"add",path:t.path,value:D(o.value)}),e}(e,t);case"test":return function(e,t){const o=F.parse(t.path).evaluate(e);if(!o.exists)throw new x(t.path,o.value,t.value,t);if(!(0,B().n4)(o.value,t.value))throw new x(t.path,o.value,t.value,t);return e}(e,t);case"append":return function(e,t){const o=F.parse(t.path),n=o.evaluate(e);if(!n.exists)throw new P(t.path,t);if("string"!=typeof n.value)throw new A(t);if(""===t.path)return n.value+t.value;const r=(0,B().mg)(e),i=o.evaluate(r);if(!i.parent||void 0===i.key)throw new A(t);return i.parent[i.key]=n.value+t.value,r}(e,t);case"replaceSuffix":return function(e,t){const o=F.parse(t.path),n=o.evaluate(e);if(!n.exists)throw new P(t.path,t);if(!Array.isArray(n.value))throw new A(t);const r=n.value,i=t.removeCount;if(i<0||!Number.isInteger(i)||i>r.length)throw new A(t);if(""===t.path){const e=[...r];return e.splice(r.length-i,i,...t.value.map((e=>D(e)))),e}const a=(0,B().mg)(e),s=o.evaluate(a);if(!Array.isArray(s.value))throw new A(t);const c=s.value;return c.splice(c.length-i,i,...t.value.map((e=>D(e)))),a}(e,t);default:throw new A(t)}}function q(e,t,o,n){switch(e){case"add":case"replace":case"test":return{op:e,path:t,value:o};case"append":return{op:"append",path:t,value:o};case"replaceSuffix":if(!Array.isArray(o)||"number"!=typeof n)throw new E(e,`removeCount: ${typeof n}, value: ${typeof o}`);return{op:"replaceSuffix",path:t,value:o,removeCount:n};case"remove":return{op:e,path:t};case"move":case"copy":if("string"!=typeof o)throw new E(e,typeof o);return{op:e,path:t,from:o};default:throw new A({op:"add",path:t,value:void 0})}}const G={apply:function(e,t,o={}){const{mutate:n=!1,ignoreRemoveErrors:r=!1,ignoreReplaceErrors:i=!1}=o;let a=n?e:(0,B().mg)(e);for(const c of t)try{a=L(a,c)}catch(s){if(r&&"remove"===c.op&&s instanceof P)continue;if(i&&"replace"===c.op&&s instanceof P)continue;throw s}return a},applyOperation:L,createOperation:q,add:(e,t)=>q("add",e,t),remove:e=>q("remove",e),replace:(e,t)=>q("replace",e,t),move:(e,t)=>q("move",e,t),copy:(e,t)=>q("copy",e,t),test:(e,t)=>q("test",e,t),append:(e,t)=>q("append",e,t),replaceSuffix:(e,t,o)=>q("replaceSuffix",e,o,t)};o(517642),o(658004),o(733853),o(845876),o(432475),o(515024),o(731698);const z={a:"add",r:"remove",p:"replace",m:"move",c:"copy",t:"test",x:"append",s:"replaceSuffix"};function $(e){const{o:t,p:o,v:n,f:r,r:i}=e,a=z[t];if(!a)throw new N(t);if("add"===a)return{op:a,path:o,value:n};if("remove"===a)return{op:a,path:o};if("replace"===a)return{op:a,path:o,value:n};if("move"===a){if(void 0===r)throw new A({op:"move",path:o,from:""});return{op:a,path:o,from:r}}if("copy"===a){if(void 0===r)throw new A({op:"copy",path:o,from:""});return{op:a,path:o,from:r}}if("test"===a)return{op:a,path:o,value:n};if("append"===a){if("string"!=typeof n)throw new A({op:a,path:o,value:""});return{op:a,path:o,value:n}}if("replaceSuffix"===a){if(void 0===i)throw new A({op:a,path:o,removeCount:0,value:[]});if(!Array.isArray(n))throw new A({op:a,path:o,removeCount:0,value:[]});return{op:a,path:o,removeCount:i,value:n}}throw new A({op:"add",path:o,value:void 0})}var Q=()=>o(229833),H=()=>o(498212),K=()=>o(534177),j=()=>o(559506),Z=()=>o(401176),X=()=>o(884107),J=()=>o(384944),Y=()=>o(666144),ee=()=>o(577142),te=()=>o(231297),oe=()=>o(890754),ne=()=>o(436725),re=()=>o(492414),ie=()=>o(594794),ae=()=>o(254619),se=()=>o(616878),ce=()=>o(765957),le=()=>o(430483),de=()=>o(148832),pe=()=>o(878710),ue=()=>o(796977),me=()=>o(122058),fe=()=>o(865454),ve=()=>o(791256),he=()=>o(717375);class ge extends Error{constructor(e){super(e),this.name="SmootherError"}static isSmootherError(e){return e instanceof ge}}const Se={velocity:100,alpha:.99,gamma:1e-5,deadlineOffset:.3,postCompleteSlack:100};class _e{constructor(e=Se){this.buffer=[],this.position=0,this.velocity=void 0,this.lastFrameTime=0,this.startTime=0,this.isFinishedAddingItems=!1,this.currentlyRunningUpdateLoop=void 0,this.alpha=void 0,this.gamma=void 0,this.deadlineOffset=void 0,this.postCompleteSlack=void 0,this.defaultArgs=Se,this.defaultArgs=e,this.velocity=e.velocity,this.alpha=e.alpha,this.gamma=e.gamma,this.deadlineOffset=e.deadlineOffset,this.postCompleteSlack=e.postCompleteSlack}addItems(e){if(!this.currentlyRunningUpdateLoop)throw new ge("`addItems` was called, but we weren't running the update loop!");const t=performance.now();0===this.startTime&&(this.startTime=t,this.lastFrameTime=t);for(const o of e)this.buffer.push({item:o,timestamp:t})}beginUpdateLoop(e){if(this.currentlyRunningUpdateLoop)throw new ge("`beginUpdateLoop` was called while we were already running the update loop!");this.currentlyRunningUpdateLoop=(async()=>{for(;!this.isFinishedAddingItems||this.hasPendingItems();)await new Promise((t=>{requestAnimationFrame((o=>{e(this.getSmoothedItems(o)),t()}))}));this.currentlyRunningUpdateLoop=void 0})()}markIsFinishedAddingItems(){this.isFinishedAddingItems=!0}async finishUpdateLoop(){if(!this.isFinishedAddingItems)throw new ge("`finishUpdateLoop` was called without a corresponding invocation of `markIsFinishedAddingItems`.");this.currentlyRunningUpdateLoop&&await this.currentlyRunningUpdateLoop}reset(){if(this.currentlyRunningUpdateLoop)throw new ge("Cannot reset while the update loop is running!");this.buffer=[],this.position=0,this.velocity=this.defaultArgs.velocity,this.lastFrameTime=0,this.startTime=0,this.isFinishedAddingItems=!1}async stopAndFinish(){if(!this.isSmoothing())return Promise.resolve();this.markIsFinishedAddingItems(),await this.finishUpdateLoop(),this.reset()}isSmoothing(){return Boolean(this.currentlyRunningUpdateLoop)}getSmoothedItems(e){if(0===this.buffer.length||0===this.startTime)return[];if((e-this.lastFrameTime)/1e3<=0)return[];const t=this.calculateSmoothedPosition(e),o=Math.max(this.position,Math.min(t,this.buffer.length)),n=this.buffer.slice(this.position,o);return this.position=o,this.lastFrameTime=e,n.map((e=>e.item))}calculateSmoothedPosition(e){if(0===this.buffer.length)return 0;const t=(e-this.startTime)/1e3,o=t-(this.lastFrameTime-this.startTime)/1e3;if(o<=0)return this.position;if(this.position>=this.buffer.length)return this.buffer.length;const n=.9*t-this.deadlineOffset;let r=this.position;for(let h=this.position;h<this.buffer.length;h++){(this.buffer[h].timestamp-this.startTime)/1e3<n&&(r=h+1)}const i=this.buffer.length+(this.isFinishedAddingItems?this.postCompleteSlack:0),a=1/o,s=this.isFinishedAddingItems?.01*this.gamma:this.gamma,c=.01,l=e=>{const t=(e-this.position)*a;return 2*s*a*(t-this.velocity)-1/(e-r)+1/(i-e)};let d=r,p=Math.max(i,d+.001),u=l(d),m=l(p);if(!(u<=c&&m>=-.01)){const e=Math.max(1,this.velocity*o),t=Math.min(Math.max(this.position+e,d),p),n=(t-this.position)/o;return this.velocity=this.alpha*this.velocity+(1-this.alpha)*n,t}for(;u<-.01;){const e=(d+p)/2,t=l(e);t<=0?(d=e,u=t):(p=e,m=t)}const f=d,v=(f-this.position)/o;return this.velocity=this.alpha*this.velocity+(1-this.alpha)*v,Math.round(f)}hasPendingItems(){return this.position<this.buffer.length}getDebugInfo(){return{bufferLength:this.buffer.length,position:this.position,velocity:this.velocity,progress:this.buffer.length>0?this.position/this.buffer.length:0}}}const ye=["text","thinking","registered_tool_use"];function we(e){if("agent-inference"===e.type){if("string"==typeof e.value)return e.value;if(Array.isArray(e.value)){const t=e.value[e.value.length-1];if(t&&ye.includes(t.type))return t.content}}return""}function Ie(e,t){return e.length>t.length&&e.startsWith(t)?e.slice(t.length):""}function be(e,t){if("agent-inference"!==e.type)return e;const o={...e};if("string"==typeof o.value)o.value=t;else if(Array.isArray(o.value)){const e=[...o.value],n=e[e.length-1];n&&ye.includes(n.type)&&(e[e.length-1]={...n,content:t}),o.value=e}return o}var Te=()=>o(166442),ke=(o(908872),()=>o(564884)),Ce=()=>o(484127),Ae=()=>o(832443),Me=()=>o(116225),Pe=()=>o(99895),xe=()=>o(944584),Re=()=>o(354785),Ne=()=>o(140022);function Ee(e){var t;const{environment:o,threadId:n,traceId:r,config:i,suggestedPrompt:a,isFollowUp:s,transcript:c}=e,l=(0,ve().o)(c),d=c.findLast((e=>"user"===e.type)),p=function(e){if(!e)return;const t=new(Pe().G)((()=>0));for(const n of e){const e=(0,I().uPN)(n);for(const o of e)(0,I().qsB)(o)?t.set("date",t.get("date")+1):(0,I().rie)(o)?t.set("user",t.get("user")+1):(0,I().jIt)(o)&&t.set("page",t.get("page")+1)}const o={};for(const[n,r]of t.entries())o[n]=r;return o||void 0}(null==d?void 0:d.value);var u;if("markdown-chat"===(null==i?void 0:i.type))(0,ke().u)({environment:o,event:{eventName:"markdown_chat_start_turn",eventProperties:{thread_id:n,trace_id:r,is_follow_up:s,model:i.model,suggested_prompt:a,mentions_used:p,opened_from:null==l||null===(u=l.value)||void 0===u?void 0:u.surface}}});else if("researcher"===(null==i?void 0:i.type)){var m;Re().Bg({threadId:n,traceId:r,environment:o,isFollowUp:s,searchSources:(0,Ne().getAnalyticsSearchSourcesFromAssistantFeatureGateStore)(),searchScopeType:(null===(m=i.searchScope)||void 0===m?void 0:m.type)??"everything"})}else if("search"===(null==i?void 0:i.type))(0,ke().u)({environment:o,event:{eventName:"deep_find_start_turn",eventProperties:{thread_id:n,trace_id:r,is_follow_up:s,from:null==l?void 0:l.value.surface,suggested_prompt:a,search_session_id:null==i?void 0:i.searchSessionId,search_sources:(0,Ne().getAnalyticsSearchSourcesFromAssistantFeatureGateStore)(),search_scope_type:i.scopeForNextSearch.type}}});else if("workflow"===(null==i?void 0:i.type)){var f;xe().trackAgentStartTurn({environment:o,from:(null==l||null===(f=l.value)||void 0===f?void 0:f.surface)??"unknown",searchSources:(0,Ne().getAnalyticsSearchSourcesFromAssistantFeatureGateStore)(),actionCardId:void 0,isCustomAgent:Boolean(null==i?void 0:i.isCustomAgent),suggestedPrompt:e.suggestedPrompt})}(0,ke().u)({environment:e.environment,event:{eventName:"inference_transcript_start_turn",eventProperties:{thread_id:e.threadId,trace_id:e.traceId,config:e.config,suggested_prompt:e.suggestedPrompt,opened_from:null==l||null===(t=l.value)||void 0===t?void 0:t.surface}}})}function Ve(e){const{clientStore:t,environment:o}=e,n=o.RouterStore.state.route,r="chat"===n.name?n.threadId:void 0;r&&t.getOrCreateClientAIChatThreadStore(r).resetState(),t.setState({...t.state,userSelectedConfig:void 0,isAIChatTranscriptSidePanelVisible:!1})}function Oe(e){const{environment:t,userStore:o,spaceStore:n,transcript:r,workflowId:i,transaction:a,threadId:s,inMemoryRecordCache:c,threadType:l}=e,d=J().vt({environment:t,table:y().To,args:{id:s??(0,ie().Z1)({environment:t,table:y().To,spaceId:n.id}),parentPointer:n.pointer,space_id:n.id,messages:[],data:{workflow_id:i},createdByPointer:o.pointer,alive:!0,type:l},transaction:a,inMemoryRecordCache:c??n.inMemoryRecordCache});return r&&We({environment:t,spaceStore:n,threadStore:d,userStore:o,addSteps:r,transaction:a}),d}function Fe(e){var t;const{threadStore:o,transaction:n}=e;De({threadStore:o,transaction:n,sharedWithSpace:!Boolean(null===(t=o.getData())||void 0===t?void 0:t.shared_with_space)})}function Be(e){var t;const{chatTranscriptInfo:o,environment:n,clientStore:r}=e,i=Z().aU();"assistant"!==o.configType&&i&&(null===(t=r.getOrCreateClientAIChatThreadStore(o.id).state.abortController)||void 0===t||t.abort(),te().createAndCommit({userAction:"assistantChatHistoryItem.deleteInferenceChatTranscript",environment:n,canUndo:!0,perform:e=>{J().zv({store:o.store,data:{alive:!1,current_inference_id:null,current_inference_lease_expiration:null},transaction:e})}}),r.removeClientAIChatThreadStore(o.id))}function De({threadStore:e,transaction:t,sharedWithSpace:o}){J().zv({store:e.getDataStore(),data:{shared_with_space:o},transaction:t})}function Ue(e){var t;const{threadStore:o,transaction:n,clientStore:r}=e;null===(t=r.getOrCreateClientAIChatThreadStore(o.id).state.abortController)||void 0===t||t.abort(),J().zv({store:o,data:{current_inference_id:null,current_inference_lease_expiration:null},transaction:n})}function We(e){const{environment:t,spaceStore:o,threadStore:n,userStore:r,addSteps:i,transaction:a}=e,s=i.map((e=>J().vt({environment:t,table:w().mS,args:{id:e.id.toString(),parentPointer:n.pointer,space_id:o.getSpaceId(),step:e,createdByPointer:r.pointer},transaction:a,inMemoryRecordCache:o.inMemoryRecordCache})));return te().applyOperation({operation:{args:{ids:s.map((e=>e.id))},command:"listAfterMulti",path:["messages"],pointer:n.pointer},store:n,transaction:a}),s}function Le(e){const{threadStore:t,stepId:o,transaction:n}=e,r=t.getMessages(),i=r.findIndex((e=>e===o)),a=r.slice(i+1);for(const s of a)te().applyOperation({operation:{args:{id:s},command:"listRemove",path:["messages"],pointer:t.pointer},store:t,transaction:n});se().f.removeStatusesForMessageIds(a)}function qe(e){const{threadStore:t,step:o,transaction:n,newValue:r}=e,i=t.getStepStoreById(o.id);i&&J().zv({store:i,data:{value:r},transaction:n})}function Ge(e){const{threadStore:t,stepId:o,transaction:n,newValue:r}=e,i=t.getStepStoreById(o);i&&J().zv({store:i,data:{value:r,isEdited:!0},transaction:n})}const ze=["config","user-specified-context","context","agent-records-updated"];async function $e(e){var t,o,n;const{clientStore:i,environment:a,threadStore:s,createThreadArgs:p,waitBeforeSending:u,analyticsArgs:h,forceRegenerateTitle:g,confirmToolStepIds:w,stepIdsToInclude:b,queuedUserMessages:T,sendPatchResponse:A}=e,M=ce().default.state.sidebarSpaceStore,P=null==M?void 0:M.id;if(!P)throw new Error("No space id");let x=(null==s?void 0:s.getTranscript())??(null==p?void 0:p.transcript)??[];if(0===x.length)throw new Error("No transcript");const R=function(e,t,o){const n=e.findLast((e=>"agent-turn-full-record-map"===e.type));if(null==n||!n.recordVersions)return;const r=new(S().d);for(const{pointer:i,version:a}of n.recordVersions)if(i.table===_().ev){const e=de().B.createChildStore(o,i);if((e.getVersion()??0)<=a)continue;const t=(0,ae().N)(e);(null!=t&&t.isPageBlock()||null!=t&&t.isCollectionView())&&r.add(t.pointer)}return r.size()>0?{id:it(t,o.id),type:"agent-records-updated",pointers:Array.from(r)}:void 0}(x,a,M);R&&(x=[...x,R]);const N=null===(t=x.findLast((e=>"config"===e.type)))||void 0===t?void 0:t.value.type,E=b?x.filter((e=>b.includes(e.id)||ze.includes(e.type))):x,V=Boolean(b),O=(null==s?void 0:s.id)??(null==p?void 0:p.id);if(!O)throw new Error("No thread id");const{model:F}=i.state,{cachedInferences:B,annotationInferences:D}=(0,ve().Hg)(i,O),U=new AbortController,W={};for(const r of B){if(!r.value.expected)throw new Error("No expected output for cached inference");if((0,m().Mt)(r.value.expected))throw new Error("Merged response not supported");W[r.key]=r.value.expected}const L={};for(const r of D)r.value.input.annotation&&(L[r.key]=r.value.input.annotation);const q=(0,H().Ay)(),G=i.getOrCreateClientAIChatThreadStore(O);G.setState({...G.state,inferences:[],temporarySteps:(null==p?void 0:p.transcript)??(A?[]:G.state.temporarySteps),abortController:U,traceId:q,loading:!0}),G.state.stopInferencePromise&&(await G.state.stopInferencePromise,G.setState({...G.state,stopInferencePromise:void 0}));const z=Boolean(null==s||null===(o=s.getData())||void 0===o?void 0:o.title),$={traceId:q,spaceId:P,transcript:E,threadId:O,threadParentPointer:null==p?void 0:p.parentPointer,threadWorkflowId:null==p?void 0:p.workflowId,createThread:void 0===s,debugOverrides:{...i.state.debugOverrides,cachedInferences:W,annotationInferences:L,model:F,emitInferences:i.state.showDebug},generateTitle:!z||Boolean(g),saveAllThreadOperations:!0,analyticsArgs:h,confirmToolStepIds:w,createdSource:null==p?void 0:p.createdSource,threadType:N,isPartialTranscript:V,queuedUserMessages:T,asPatchResponse:Boolean(A)};i.state.showDebug&&G.setState({...G.state,requestInfo:{request:{...$,transcript:x},response:void 0,memories:[]}});try{u&&await u,await async function(e){const{environment:t,abortController:o,clientStore:n,request:i,fullTranscript:a}=e,{spaceId:s,threadId:p,traceId:u,analyticsArgs:m,createdSource:h}=i;if(!p)throw new Error("Expected a threadId");const g=(0,v().WS)({spaceId:s}),S=await j().callStreamApi({eventName:"runInferenceTranscript",environment:t,data:i,abortSignal:o.signal,headers:g});if("failed"===S.type){var w;if("AbortedError"===(null===(w=S.body)||void 0===w?void 0:w.name))throw new DOMException("Aborted","AbortError");throw S.error}if(!k().hS.is(S.data))throw new Error("Expected stream response and got non-stream response.");let I=[];const b=Qe({environment:t,threadId:p,transcript:a,traceId:u,analyticsArgs:m,createdSource:h});let T=!0,A=!1;b.beginInferenceTranscriptTurn(),b.markStreamStart();const M=n.getOrCreateClientAIChatThreadStore(p),P=r().default.checkGate({gateName:"ai_smooth_streaming"}),x=async function*(e){const{responseStream:t,environment:o,threadStore:n,threadId:r}=e;let i=!1,a=!0,s=[],c={s},l=!1;for await(const u of t){try{"error"===u.type&&(i=!0),"queue-handoff"===u.type&&(a=!1),(0,d().yD)(u)?l||(s=Ze({environment:o,threadId:r,value:u,patchState:c})):s=je({environment:o,threadStore:n,value:u,currentSteps:s}),c={s}}catch(p){if(!C.isJSONPatchError(p))throw p;l=!0}yield{temporarySteps:s,isError:i,inferenceComplete:a}}}({responseStream:S.data,environment:t,threadId:p,threadStore:M});function R(e){M.setState({...M.state,temporarySteps:e}),function(e){const{environment:t,request:o,threadStore:n,updatedSteps:r,isDebugEnabled:i,fullTranscript:a}=e,s=[...a,...r],c=r[r.length-1];c&&function(e){var t,o;const{environment:n,step:r,transcript:i}=e;if("agent-tool-result"!==r.type||!(0,l().gY)(r,"create-database")||null===(t=r.result)||void 0===t||!t.shouldNavigate||!r.result.collectionViewBlockId||(0,ve().d$)({transcript:i}))return!1;const a={id:r.result.collectionViewBlockId,spaceId:(null===(o=ce().default.state.sidebarSpaceStore)||void 0===o?void 0:o.id)||"",table:_().ev},s=(0,fe().L2)(n),c=new(de().B)(n,a,{inMemoryRecordCache:s.getInMemoryRecordCacheIfIsPreviewingRecord(a,n.currentUser.id)});if(!c.isNavigableBlock())return!1;const d=(0,re().Ef)({environment:n,updates:{store:c}});if(!d)return!1;(0,ee().navigate)({environment:n,url:d,redirect:!1})}({environment:t,step:c,transcript:s});if(i){const e={transcript:r};n.setState({...n.state,requestInfo:{...n.state.requestInfo,request:{...o,transcript:a},response:e,memories:[]}})}}({environment:t,request:i,isDebugEnabled:n.state.showDebug,updatedSteps:I,threadStore:M,fullTranscript:a})}try{let e=!1;for await(const t of async function*(e,t,o,n,r){let i=[],a=!1;const s=new _e(r);try{for await(const n of e)try{const{temporarySteps:e,isError:r}=n;if(!o||a||r||!(e.length>0)){yield n,i=e;continue}const c=e[e.length-1],l=we(c),d=i.length>0?we(i[i.length-1]):"",p=l.length>0;let u=!1;if(p){const o=Ie(l,d);if(o.length>0){s.isSmoothing()||s.beginUpdateLoop((e=>{for(const{temporarySteps:o}of e)t(o)}));for(let t=0;t<o.length;t++){const n=be(c,d+o.slice(0,t+1)),r=[...e];r[r.length-1]=n,s.addItems([{temporarySteps:r}])}u=!0,i=e}}if(u)continue;await s.stopAndFinish(),yield n,i=e}catch(c){if(!ge.isSmootherError(c))throw c;f().log({level:"error",from:"inferenceTranscriptActions",type:"SmootherError",team:"ai-ux",error:(0,Q().convertErrorToLog)(c)}),a=!0}}catch(c){throw await s.stopAndFinish(),c}finally{n.markStreamFinished(),await s.stopAndFinish()}}(x,R,P,b))if(I=t.temporarySteps,A=t.isError,T=t.inferenceComplete,I.length>0){R(I);const t=I.length>0?I[I.length-1]:null;t&&(e=Ke({analyticsController:b,value:t,hasReceivedFirstToken:e}))}}catch(N){throw T=!1,N}finally{P||b.markStreamFinished(),b.markCompletion(),T?b.endInferenceTranscriptTurn({isError:A,stepsFromTurn:I}):function(e){const{environment:t,clientStore:o,traceId:n,analyticsArgs:r,createdSource:i,threadId:a}=e,{sidebarSpaceStore:s}=ce().default.state;if(!s)return;const l=ue().E.createChildStore(s,{id:a,spaceId:s.getSpaceId(),table:y().To});if(!l)return;const d=o.getOrCreateClientAIChatThreadStore(l.id),p=new(c().ComputedStore)((()=>void 0===l.getCurrentInferenceId()&&!d.state.loading),{debugName:`inferenceCompleteMonitor:${l.id}`}),u=()=>{if(p.state){const e=l.getTranscript();let o=0;const a=e.findLastIndex((e=>"user"===e.type));-1!==a&&(o=a+1);const s=e.slice(o);Qe({environment:t,threadId:l.id,transcript:e,traceId:n,analyticsArgs:r,createdSource:i}).endInferenceTranscriptTurn({isError:!1,stepsFromTurn:s}),p.removeListener(u)}};p.addListener(u),p.state&&u();setTimeout((()=>{p.removeListener(u)}),6e5)}({environment:t,clientStore:n,threadId:p,traceId:u,analyticsArgs:m,createdSource:h})}}({environment:a,abortController:U,clientStore:i,request:$,fullTranscript:x})}catch(pe){He(U,pe)?await async function(e){const{environment:t,clientStore:o,threadId:n}=e,{currentUserStore:r,sidebarSpaceStore:i}=ce().default.state;if(!r||!i)throw new Error("No current user root store");const a=o.getOrCreateClientAIChatThreadStore(n),s=ue().E.createChildStore(i,{id:n,spaceId:i.getSpaceId(),table:y().To});if(!s)return;const{serverCommitResult:c}=te().createAndCommit({userAction:"inferenceTranscriptActions.handleAbort",environment:t,canUndo:!0,perform:e=>{We({environment:t,spaceStore:i,userStore:r,threadStore:s,addSteps:a.state.temporarySteps,transaction:e})}});return c}({environment:a,clientStore:i,threadId:O}):!function(e){return e instanceof Error&&"TypeError"===e.name&&"network error"===e.message}(pe)?C.isJSONPatchError(pe)||f().log({level:"error",from:"runFromStep",type:"runInferenceTranscriptApiError",error:(0,Q().convertErrorToLog)(pe),data:{miscDataToConvertToString:{spaceId:P,threadId:O}}}):f().log({level:"error",from:"runFromStep",type:"longRunningInferenceTranscriptApiConnectionDrop",data:{miscDataToConvertToString:{spaceId:P,threadId:O}}})}G.setState({...G.state,abortController:void 0,loading:!1,temporarySteps:[]});const K=r().default.checkGate({gateName:"future_ai_interfaces"});if(!s||!K)return;const Z=(null===(n=s.getData())||void 0===n?void 0:n.queued_user_messages)??[],X=Array.isArray(Z)?Z:[],Y=G.state.pendingQueuedMessages||[],oe=new Map;X.forEach((e=>oe.set(e.id,e))),Y.forEach((e=>oe.set(e.id,e)));const ne=Array.from(oe.values());if(!ne.length)return;const ie=[];ne.forEach(((e,t)=>{ie.push(...e.value),t<ne.length-1&&ie.push(...(0,I().x9d)("\n"))})),te().createAndCommit({userAction:"processQueuedMessages",environment:a,canUndo:!1,perform:e=>{J().zv({store:s.getDataStore(),data:{queued_user_messages:[]},transaction:e})}}),G.setState({...G.state,pendingQueuedMessages:[]});const se={id:it(a,P),type:"user",value:ie,userId:a.currentUser.id??"",createdAt:(new Date).toISOString()},{serverCommitResult:le}=te().createAndCommit({userAction:"addQueuedUserStep",environment:a,canUndo:!1,perform:e=>{We({environment:a,spaceStore:ce().default.state.sidebarSpaceStore,threadStore:s,userStore:ce().default.state.currentUserStore,addSteps:[se],transaction:e})}});await $e({environment:a,clientStore:i,threadStore:s,analyticsArgs:h,forceRegenerateTitle:g,sendPatchResponse:A,waitBeforeSending:le,stepIdsToInclude:b?[se.id]:void 0})}function Qe(e){const{environment:t,threadId:o,transcript:n,traceId:r,analyticsArgs:i,createdSource:a}=e,s=(0,ve().JD)(n),c=s&&"search"===s.type?s.searchSessionId:void 0,l=performance.now();let d,p,u,m,f=n.filter((e=>"user"===e.type)).length>1,v=n.filter((e=>"user"===e.type)).length>1,h=!1,g=!1;const S=n.filter((e=>"user"===e.type)).length>1;return{deepFindResultsOnClient:e=>{f||((0,me().hp)({environment:t,assistantSessionId:void 0,searchSessionId:c,traceId:r,threadId:o,showResults:e.showResults,timeSinceTurnStartMs:performance.now()-l,createdSource:a}),f=!0)},deepFindBeginAiAnswer:()=>{v||((0,me().S9)({environment:t,assistantSessionId:void 0,searchSessionId:c,threadId:o,timeSinceTurnStartMs:performance.now()-l,createdSource:a}),v=!0)},beginInferenceTranscriptTurn:()=>{h||(Ee({environment:t,threadId:o,traceId:r,config:s,suggestedPrompt:null==i?void 0:i.suggestedPrompt,isFollowUp:S,transcript:n}),h=!0)},markStreamStart:()=>{void 0===d&&(d=performance.now())},markFirstToken:()=>{void 0===p&&(p=performance.now())},markStreamFinished:()=>{void 0===u&&(u=performance.now())},markCompletion:()=>{void 0===m&&(m=performance.now())},endInferenceTranscriptTurn:({isError:e,stepsFromTurn:i})=>{if(g)return;!function(e){var t;const{config:o,threadId:n,traceId:r,environment:i,isError:a,isFollowUp:s,transcript:c,stepsFromTurn:l,clientTimingMetrics:d}=e,p=(0,ve().o)(c);var u;if("markdown-chat"===(null==o?void 0:o.type))(0,ke().u)({environment:i,event:{eventName:"markdown_chat_end_turn",eventProperties:{thread_id:n,trace_id:r,is_error:a,is_follow_up:s,opened_from:null==p||null===(u=p.value)||void 0===u?void 0:u.surface}}});else if("researcher"===(null==o?void 0:o.type)&&c){var m;const e=l.findLast((e=>"researcher-report"===e.type)),t=e&&e.citationInfo?e.citationInfo:{stepCitations:{}},{resultsBySource:c,numSearchResults:d}=(0,Ce().W6)(t),p=(null==e?void 0:e.value)||"",{citationsBySource:u,numCitationsShown:f}=(0,Ce().ye)(p,t),v=Re().Yh(l),h=Re().ay(l);Re().g$({threadId:n,traceId:r,environment:i,isFollowUp:s,isError:a,numSearchResults:d,numCitationsShown:f,resultsBySource:c,citationsBySource:u,stepsGenerated:v,planningRounds:h,searchSources:(0,Ne().getAnalyticsSearchSourcesFromAssistantFeatureGateStore)(),searchScopeType:(null===(m=o.searchScope)||void 0===m?void 0:m.type)??"everything"}),Me().u4({name:"finished_og_research_mode",args:{ai_session_id:n,thread_id:n}})}else if("search"===(null==o?void 0:o.type)){var f,v,h;const e=l.find((e=>"search"===e.type)),t="search"===(null==e?void 0:e.type)&&"results"in e?e.results:void 0,o=l.find((e=>"search-chat"===e.type)),a=t?(0,K().s8)(t,((e,t)=>(null==e?void 0:e.length)??0)):void 0,c=/\[\]\((.*?)\)/g,d=o?(null===(f=o.value.match(c))||void 0===f?void 0:f.length)??0:0,u=((null===(v=Array.from((null==o?void 0:o.value.matchAll(c))??[]))||void 0===v?void 0:v.map((e=>e[1])))??[]).reduce(((e,t)=>{if((0,H().iv)(t))e.notion=(e.notion??0)+1;else{const o=Ae().tD.parseAssistantHref(t);if(o){const t=o.type;e[t]=(e[t]??0)+1}}return e}),{});(0,ke().u)({environment:i,event:{eventName:"deep_find_end_turn",eventProperties:{thread_id:n,trace_id:r,is_follow_up:s,from:null==p?void 0:p.value.surface,search_results:a?B().cz(Object.values(a)):void 0,results_by_source:a,citations_shown:d,citations_by_source:u,search_scope_type:(null==e||null===(h=e.scope)||void 0===h?void 0:h.type)??"",search_sources:(0,Ne().getAnalyticsSearchSourcesFromAssistantFeatureGateStore)(),did_search:(null==o?void 0:o.didSearch)??void 0,has_search_step:void 0!==e}}})}else if("workflow"===(null==o?void 0:o.type)){var g;const e=(0,Ne().getAnalyticsSearchSourcesFromAssistantFeatureGateStore)(),t=xe().calculateMetricsFromTranscript(l),o=xe().getCitationsAndResultsFromTranscript(l),n=c.filter((e=>"user"===e.type)).length;xe().trackAgentEndTurn({environment:i,from:(null==p||null===(g=p.value)||void 0===g?void 0:g.surface)??"unknown",numUserStepsInTranscript:n,searchSources:e,...t,...o,clientTimeToStartStream:null==d?void 0:d.clientTimeToStartStream,clientTimeToFirstToken:null==d?void 0:d.clientTimeToFirstToken,clientTimeToFlushUiUpdates:null==d?void 0:d.clientTimeToFlushUiUpdates,clientTotalTurnDuration:null==d?void 0:d.clientTotalTurnDuration})}(0,ke().u)({environment:e.environment,event:{eventName:"inference_transcript_end_turn",eventProperties:{thread_id:e.threadId,trace_id:e.traceId,is_error:e.isError,opened_from:null==p||null===(t=p.value)||void 0===t?void 0:t.surface}}})}({environment:t,config:s,threadId:o,traceId:r,isError:e,isFollowUp:S,transcript:n,stepsFromTurn:i,clientTimingMetrics:{clientTimeToStartStream:d?d-l:void 0,clientTimeToFirstToken:p?p-l:void 0,clientTimeToFlushUiUpdates:m&&u?m-u:void 0,clientTotalTurnDuration:m?m-l:void 0}}),g=!0}}}function He(e,t){return t instanceof Error&&"AbortError"===t.name&&e.signal.aborted}function Ke(e){const{analyticsController:t,value:o,hasReceivedFirstToken:n}=e;let r=n;switch(o.type){case"agent-inference":r||(t.markFirstToken(),r=!0);break;case"search":"resultsPartial"===o.status&&t.deepFindResultsOnClient({showResults:o.showResults});break;case"search-chat":t.deepFindBeginAiAnswer()}return r}function je(e){const{threadStore:t,value:o,environment:n,currentSteps:r}=e,i=n.currentUser.id;let a=r;if("queue-handoff"===o.type);else if("record-map"===o.type)Y()._O({environment:n,userId:i,inMemoryRecordCache:n.defaultRecordCache.inMemoryRecordCache,recordMap:g().RecordMapWithRole.create(o.recordMap),debugSource:"runInferenceTranscript",force:!0});else if("inference"===o.type){const e={type:"inference",key:(0,T().$A)(o.value.input),index:o.index,value:o.value},n=B().Ul([...t.state.inferences,e],(e=>e.index));t.setState({...t.state,inferences:n})}else"agent-search-extracted-results"===o.type?t.setAgentSearchResultsForTool(o):"patch"!==o.type&&"patch-start"!==o.type&&(a=(0,m().RM)(a,o));return a}function Ze(e){const{environment:t,threadId:o,value:n,patchState:r}=e;if("patch-start"===n.type){let e=r.s;for(const t of n.data.s)e=(0,m().RM)(e,t);return e}"patch"!==n.type&&(0,K().HB)(n);return function(e){const{environment:t,threadId:o,patches:n,patchState:r}=e;try{return G.apply(r,n,{mutate:!1}).s}catch(i){throw C.isJSONPatchError(i)&&f().log({level:"error",from:"inferenceTranscriptActions",type:"JsonPatchError",team:"ai-ux",error:(0,Q().convertErrorToLog)(i),data:{miscDataToConvertToString:{spaceId:ce().default.state.sidebarSpaceStore.getSpaceId(),userId:t.currentUser.id,threadId:o,message:i.name,operationPath:i.path,operationDetails:i.operation?{op:i.operation.op,path:i.operation.path}:void 0}}}),i}}({patches:n.v.map($),patchState:r,environment:t,threadId:o})}function Xe(e){const t=new Map;let o=1;return e.replace(/\[\^([^\]]+)\]/g,((e,n)=>{if(n.startsWith("user://"))return"";let r=t.get(n);return void 0===r&&(r=o++,t.set(n,r)),`[[${r}]](${n})`}))}async function Je(e){const{environment:t,step:o,textContent:n}=e;let r;if("markdown-chat"===o.type||"fast-researcher-chat"===o.type)r=o.value;else if("search-chat"===o.type){const e=(0,ve().Jz)(o.value);r=(0,p().Gw)({text:e,baseUrl:i().A.domainBaseUrl})}else{if("agent-inference"!==o.type)throw new Error("Unsupported step type");if(n)r=Xe(n);else{r=Xe((0,u().lH)(o.value).flatMap((e=>"text"===e.type?[e.content]:[])).join(""))}}const a=await X().R.clipboardActions.load();await a.copyString({environment:t,stringValue:r,copiedMessage:a.clipboardMessages.copiedQnAMessageToClipboard})}function Ye(e){const{environment:t,threadStore:o,step:n,analyticsArgs:r}=e;te().createAndCommit({userAction:"AIChatTranscript.RunFromStepButton.handleClick",environment:t,canUndo:!0,perform:e=>{Le({threadStore:o,stepId:n.id,transaction:e})}}),$e({environment:t,threadStore:o,clientStore:Te().defaultClientAIChatStore,analyticsArgs:r,sendPatchResponse:!1})}function et(e){const{threadStore:t,config:o,environment:n}=e;if(!t)return;const{sidebarSpaceStore:r,sidebarSpaceViewStore:i}=ce().default.state;if(!r||!i)return;const a=t.getTranscript(),s=t.getMessageStores(),c=a.findIndex(ve().sQ),l=a[c],d=s[c];if(c<0||!d||!l||"config"!==l.type)return;if(l.value.type!==o.type)return;const p={...l,value:o};te().createAndCommit({userAction:"AIChatTranscript.setConfigInThread",environment:n,canUndo:!0,perform:e=>{J().KY({store:d.getStepStore(),value:p,transaction:e})}})}function tt(){return(0,he().xm)({isResearchModeWebSearchEnabled:le().zD.isResearchModeWebSearchEnabled(),showSetupGenerator:le().zD.showSetupGenerator()}).find((e=>"researcher"===e.type))??{type:"researcher"}}function ot(e){const{clientStore:t,initialPerform:o,threadStore:r}=e,i=(0,a().v3)(),c=(0,oe().useThreadStoreFromCurrentRoute)(),l=r??c,d=(0,s().K8)((()=>Boolean(void 0!==(null==l?void 0:l.getCurrentInferenceId())||(null==l?void 0:l.id)&&t.getOrCreateClientAIChatThreadStore(l.id).state.loading)),[l,t]);return(0,n.useCallback)((async e=>{const{userAction:n}=e,{sidebarSpaceStore:r}=ce().default.state;if(l&&r&&d){const{serverCommitResult:e}=te().createAndCommit({userAction:n,environment:i,canUndo:!1,perform:e=>{null==o||o(e),Ue({threadStore:l,transaction:e,clientStore:t})}}),r=t.getOrCreateClientAIChatThreadStore(l.id);r.setState({...r.state,stopInferencePromise:e}),await e}}),[t,i,l,d,o])}function nt(){const e=(0,oe().useThreadStoreFromCurrentRoute)();return(0,s().K8)((()=>Boolean((null==e?void 0:e.id)&&Te().defaultClientAIChatStore.getOrCreateClientAIChatThreadStore(e.id).state.loading||void 0!==(null==e?void 0:e.getCurrentInferenceId()))),[e])}function rt(e){const{environment:t,operation:o,transaction:n,recordCache:r}=e;if((0,b().ph)(o))(0,ne().e)({environment:t,operation:o,transaction:n,inMemoryRecordCache:r});else if(o.pointer.table===_().ev)if("set"===o.command&&0===o.path.length){const e=J().Wv({environment:t,id:o.pointer.id,type:o.args.type,properties:o.args.properties,format:o.args.format,permissions:o.args.permissions,createdById:o.args.created_by_id,createdTime:o.args.created_time,createdByTable:o.args.created_by_table,inMemoryRecordCache:r??t.defaultRecordCache.inMemoryRecordCache,spaceId:o.args.space_id,transaction:n});te().applyOperation({store:e,operation:h().op.update({pointer:e.pointer,path:[],args:{parent_table:o.args.parent_table,parent_id:o.args.parent_id,alive:!0}}),transaction:n})}else(0,ne().e)({environment:t,operation:o,transaction:n,inMemoryRecordCache:r});else if((0,h().$Y)(o)||(0,h().mP)(o)){const e=new(pe().pm)({environment:t,pointer:o.pointer,path:o.path,recordStoreOptions:{inMemoryRecordCache:r}});te().applyOperation({store:e,operation:o,transaction:n})}else(0,K().HB)(o)}function it(e,t){return(0,ie().Z1)({environment:e,table:w().mS,spaceId:t})}},140022:(e,t,o)=>{o.r(t),o.d(t,{getAnalyticsSearchSourcesFromAssistantFeatureGateStore:()=>se,trackAIChatTranscriptHistoryChatDeleted:()=>q,trackAIChatTranscriptHistoryItemRestored:()=>W,trackAIChatTranscriptHistoryNewChatCreated:()=>L,trackAcceptAllPill:()=>X,trackAiChatTranscriptHistoryOpenHistoryButtonSelected:()=>G,trackAiDetectedGetSupportPillClick:()=>U,trackAssistantClosed:()=>I,trackAssistantFollowUpShareButtonClick:()=>me,trackAssistantIntroModalClose:()=>O,trackAssistantIntroModalRead:()=>F,trackAssistantIntroModalTryNow:()=>D,trackAssistantOpened:()=>w,trackAssistantScopeMenuGetAiConnectorsInteraction:()=>ue,trackAssistantShareModalCopyImageFailure:()=>he,trackAssistantShareModalCopyImageSuccess:()=>ve,trackAssistantShareModalDismiss:()=>fe,trackAssistantSlackUnfurlAiActionEvent:()=>ce,trackAtMentionClick:()=>te,trackConnectAppsClick:()=>ge,trackConnectorAuthNeededModalOpened:()=>pe,trackConnectorInProgressModalOpened:()=>de,trackDiscardAllPill:()=>Y,trackFullPageWelcomePromptCardInteraction:()=>le,trackInferenceEnd:()=>C,trackInferenceStart:()=>T,trackInsertPill:()=>Z,trackLeapDismissed:()=>ie,trackLeapLinkClick:()=>ae,trackLeapPreferenceSelect:()=>oe,trackLeapPresented:()=>re,trackLeapSubmit:()=>ne,trackLearnMoreAboutAssistantClicked:()=>B,trackLeavingFullPageChat:()=>ee,trackOpeningHelpFromThreeDotMenu:()=>K,trackOpeningSupportFromThreeDotMenu:()=>j,trackOpeningThreeDotMenu:()=>H,trackQnASilentRetry:()=>P,trackQnaCitationsSeeMoreClick:()=>E,trackQnaCitationsToggle:()=>N,trackQnaFeedbackGiven:()=>x,trackQnaResultClicked:()=>R,trackQnaSessionInitialized:()=>V,trackSavePagePill:()=>J,trackScopeSearchMenuClose:()=>Q,trackScopeSearchMenuOpen:()=>z,trackScopeSearchToggle:()=>$,trackUserClickedAssistantTryAgain:()=>A,trackUserStoppedAssistantOutput:()=>M});o(944114),o(898992),o(354520);var n=()=>o(314529),r=()=>o(564884),i=()=>o(242422),a=()=>o(902006),s=()=>o(239666),c=()=>o(116225),l=()=>o(534177),d=()=>o(631611),p=()=>o(291075),u=()=>o(46657),m=()=>o(765957),f=()=>o(430483),v=()=>o(874753),h=()=>o(525569),g=()=>o(99254),S=()=>o(329304),_=()=>o(604018),y=()=>o(174636);function w(e,t){const{sessionId:o,startTimestamp:r,transcript:a,hasQuery:s,searchSessionId:l,from:d,isReminder:v,reminderType:h}=t,_=f().zD.isXMLAssistantEnabled(),w=f().zD.isLimitedQnaMode(),I=_?"assistant_open":"qna_open";(0,n().DO_NOT_USE_trackLegacy)(e,I,{qna_session_id:o,has_query:s,search_session_id:l,is_limited_qna_session:w,from:d,is_reminder:v,reminder_type:h}),i().default.logEvent(I,d),c().u4({name:I,args:{qna_session_id:o,from:d,duration:Date.now()-r,questions_asked_in_session:a.filter((e=>"human"===e.type)).length??0,is_reminder:v,reminder_type:h,is_limited_qna_session:w}});const b=m().default.state.sidebarSpaceStore,T=null==b?void 0:b.getMemberCountFromPublicSpaceData(),k=(0,S().zD)(e,{spaceId:null==b?void 0:b.id,userId:e.currentUser.id,name:"ai_connectors"})??!1;b&&T&&!v&&f().zD.isAudienceForAiConnectorSprigSurvey({hasAiConnectorFeature:k,isSpaceAdmin:b.canAdmin(),isMultiplayerWorkspace:T>1,qnaConnectionStoreStates:{slackUniversalQnAConnectionStoreState:y().R.state,githubAIConnectorStoreState:p().o.state,jiraAIConnectionStoreState:g().y.state,linearAIConnectorStoreState:u().W.state}})&&c().u4({name:"assistant_open_and_in_ai_connector_sprig_audience",args:{qna_session_id:o,from:d}})}function I(e,t){const{sessionContext:o,from:r}=t,i=null==o?void 0:o.assistantConfigurationState,a=f().zD.isXMLAssistantEnabled(),s=f().zD.isLimitedQnaMode(),l=a?"assistant_close":"qna_close",d=null==i?void 0:i.sessionStartTimestamp;(0,n().DO_NOT_USE_trackLegacy)(e,l,{qna_session_id:null==i?void 0:i.sessionId,qna_session_length:d?Date.now()-d:0,from:r,is_limited_qna_session:s}),c().u4({name:l,args:{qna_session_id:(null==i?void 0:i.sessionId)??"",is_limited_qna_session:s,from:r,duration:d?Date.now()-d:-1,questions_asked_in_session:(null==o?void 0:o.evaluator.getTranscript().filter((e=>"human"===e.type)).length)??0}})}function b(e){if(!(0,d().Ui)(e))return v().P.state.from;switch(h().default.state.type){case"closed":return;case"assistantCompletionPopup":return h().default.state.from;default:(0,l().HB)(h().default.state)}}function T(e){var t;const{environment:o,configurationState:r,inferenceId:i,source:a,mentionsUsed:c,skillType:l,from:d,actionCardIdForLogging:p}=e,u=se(),m=r?r.searchScope:s().Wy,v=k(m),h=f().zD.isXMLAssistantEnabled(),g=f().zD.isLimitedQnaMode(),S=(null==r||null===(t=r.temporaryUserInputData)||void 0===t?void 0:t.isRetrying)??!1,_=h?"assistant_inference_start":"qna_inference_start";(0,n().DO_NOT_USE_trackLegacy)(o,_,{qna_session_id:r?r.sessionId:void 0,qna_inference_id:i,is_limited_qna_session:g,is_retry:S,is_suggested_question:"suggested_question"===a,is_reminder_suggested_question:"reminder_suggested_question"===a,is_abandoned_search_suggested_question:"abandoned_search_suggested_question"===a,search_scope_type:m.type,search_scope_id:v,mentions_used:c,skill_type:l,action_card_id:p,from:d,search_sources:u,assistant_opened_from:b(d)})}function k(e){if("everything"!==e.type&&"workspace"!==e.type&&"notion"!==e.type&&"helpdocs"!==e.type&&"ai-knowledge"!==e.type&&"labeler"!==e.type&&"universal-none"!==e.type&&"notion-none"!==e.type&&"web"!==e.type&&"slackbot"!==e.type&&"universal-workspace"!==e.type&&!(0,a().SC)(e.type))return"teamspace"===e.type?e.teamId:"page"===e.type?e.pageId:"collection"===e.type?e.collectionId:"site"===e.type?e.siteId:(0,l().HB)(e.type)}function C(e,t){const{configurationState:o,inferenceId:i,timeTook:a,numCitationsShown:c,numSearchResults:l,numSlackSearchResults:d,numGoogleDriveSearchResults:p,searchedHelpdocs:u,citationsBySource:m,resultsBySource:v,selectedSkill:h,assistantActions:g,from:S,observationsBeforeFirstHumanStep:_,observationsAfterFirstHumanStep:y,forcefullyStoppedByUser:w,actionCardId:I}=t;if(!o)return;const T=f().zD.isXMLAssistantEnabled(),C=se(),A=o.searchScope.type,M=k(o?o.searchScope:s().Wy);T?(0,r().u)({environment:e,event:{eventName:"assistant_inference_end",eventProperties:{session_id:o.sessionId,inference_id:i,time_took:a,num_citations_shown:c,num_search_results:l,num_slack_search_results:d,num_google_drive_search_results:p,searched_helpdocs:u,citations_by_source:m,results_by_source:v,selected_skill:h,action_card_id:I,assistant_actions:(null==g?void 0:g.length)?g:["none"],search_sources:C,search_scope_type:A,observations_before_first_human_step:_,observations_after_first_human_step:y,search_scope_id:M,from:S,assistant_opened_from:b(S),forcefully_stopped_by_user:w}}}):(0,n().DO_NOT_USE_trackLegacy)(e,"qna_inference_end",{qna_session_id:o.sessionId,qna_inference_id:i,time_took:a,num_citations_shown:c,num_search_results:l,num_slack_search_results:d,citations_by_source:m,search_sources:C,search_scope_type:A,from:S,assistant_opened_from:b(S)})}function A(e,t){(0,r().u)({environment:e,event:{eventName:"assistant_user_clicked_try_again",eventProperties:{session_id:t.sessionId,assistant_surface_type:t.assistantSurfaceType}}})}function M(e,t){(0,r().u)({environment:e,event:{eventName:"assistant_output_stopped_by_user",eventProperties:{session_id:t.sessionId,assistant_surface_type:t.assistantSurfaceType}}})}function P(e,t){(0,n().DO_NOT_USE_trackLegacy)(e,"qna_silent_retry",{qna_session_id:t.sessionId,event:t.event})}function x(e,t,o,n){t&&(0,r().u)({environment:e,event:{eventName:"ai_feedback_given",eventProperties:{feature:"ai_assistant",qna_session_id:t.sessionId,qna_inference_id:o,sentiment:n}}})}function R(e,t){const{configurationState:o,clickedPageId:r,resultType:i,source:a}=t;o&&(0,n().DO_NOT_USE_trackLegacy)(e,"qna_result_clicked",{qna_session_id:o.sessionId,search_session_id:o.searchSessionId,clicked_page_id:r,result_type:i,source:a})}function N(e,t){(0,n().DO_NOT_USE_trackLegacy)(e,"qna_citations_toggle",{qna_session_id:t.sessionId,shown:t.shown})}function E(e,t){(0,n().DO_NOT_USE_trackLegacy)(e,"qna_citations_see_more_click",{qna_session_id:t.sessionId})}function V(e,t){(0,n().DO_NOT_USE_trackLegacy)(e,"qna_session_initialized",{current_initialization_count:t.current_initialization_count})}function O(e,t){(0,n().DO_NOT_USE_trackLegacy)(e,"assistant_intro_modal_close",t)}function F(e,t){(0,n().DO_NOT_USE_trackLegacy)(e,"assistant_intro_modal_read",t)}function B(e,t){(0,n().DO_NOT_USE_trackLegacy)(e,"assistant_learn_more_about_assistant_clicked",t)}function D(e,t){(0,n().DO_NOT_USE_trackLegacy)(e,"assistant_intro_modal_continue",t),w(e,{hasQuery:!1,isReminder:!1,transcript:[],searchSessionId:void 0,sessionId:"",startTimestamp:Date.now(),reminderType:void 0,from:"assistant_intro_modal"})}function U(e,t){(0,n().DO_NOT_USE_trackLegacy)(e,"ai_get_help_click",{sessionId:t.sessionId})}function W(e,t){(0,n().DO_NOT_USE_trackLegacy)(e,"ai_chat_transcript_history.restored",t)}function L(e,t){(0,n().DO_NOT_USE_trackLegacy)(e,"ai_chat_transcript_history.new_chat_created",t)}function q(e,t){(0,n().DO_NOT_USE_trackLegacy)(e,"ai_chat_transcript_history.chat_deleted",t)}function G(e,t){(0,n().DO_NOT_USE_trackLegacy)(e,"ai_chat_transcript_history.open_history_button_selected",t)}function z(e,t){(0,n().DO_NOT_USE_trackLegacy)(e,"ai_scoped_search_menu_open",t)}function $(e,t){const{from:o,scope:r,config_type:i}=t;let s;if("everything"===r.type||"workspace"===r.type||"notion"===r.type||"helpdocs"===r.type||"ai-knowledge"===r.type||"labeler"===r.type||"universal-none"===r.type||"notion-none"===r.type||"web"===r.type||"slackbot"===r.type||"universal-workspace"===r.type||(0,a().SC)(r.type));else if("teamspace"===r.type)s=r.teamId;else if("page"===r.type)s=r.pageId;else if("collection"===r.type)s=r.collectionId;else{if("site"!==r.type)return(0,l().HB)(r.type);s=r.siteId}(0,n().DO_NOT_USE_trackLegacy)(e,"ai_scoped_search_toggle",{from:o,search_scope_type:r.type,search_scope_id:s,config_type:i})}function Q(e,t){(0,n().DO_NOT_USE_trackLegacy)(e,"ai_scoped_search_menu_close",t)}function H(e,t){(0,n().DO_NOT_USE_trackLegacy)(e,"ai_three_dot_menu.open",t)}function K(e,t){(0,n().DO_NOT_USE_trackLegacy)(e,"ai_three_dot_menu.accessing_help",t)}function j(e,t){(0,n().DO_NOT_USE_trackLegacy)(e,"ai_three_dot_menu.opening_support",t)}function Z(e,t){(0,n().DO_NOT_USE_trackLegacy)(e,"ai_action_pill.insert",t)}function X(e,t){(0,n().DO_NOT_USE_trackLegacy)(e,"ai_action_pill.accept_all_edits",t)}function J(e,t){(0,n().DO_NOT_USE_trackLegacy)(e,"ai_action_pill.save_page",t)}function Y(e,t){(0,n().DO_NOT_USE_trackLegacy)(e,"ai_action_pill.discard_all_edits",t)}function ee(e){(0,n().DO_NOT_USE_trackLegacy)(e,"ai_full_page_exit")}function te(e){(0,n().DO_NOT_USE_trackLegacy)(e,"ai_at_mention_click")}function oe(e,t){(0,n().DO_NOT_USE_trackLegacy)(e,"leap_select",t)}function ne(e,t){(0,n().DO_NOT_USE_trackLegacy)(e,"leap_submit",t)}function re(e){(0,n().DO_NOT_USE_trackLegacy)(e,"leap_presented")}function ie(e){(0,n().DO_NOT_USE_trackLegacy)(e,"leap_dismissed")}function ae(e,t){(0,n().DO_NOT_USE_trackLegacy)(e,"leap_open_link",t)}function se(){const e=["notion","helpdocs"];return e.push(...(0,_().wd)()),e}function ce(e){const{environment:t,action:o,interaction:n}=e;(0,r().u)({environment:t,event:{eventName:"assistant_slack_unfurl_ai_action_event",eventProperties:{interaction:n,action:o}}})}function le(e){const{environment:t,promptId:o,interaction:n}=e;(0,r().u)({environment:t,event:{eventName:"assistant_full_page_welcome_prompt_card_event",eventProperties:{promptid:o,interaction:n}}})}function de(e){const{environment:t,connector:o,from:n}=e;(0,r().u)({environment:t,event:{eventName:"ai_connector_in_progress_modal_opened",eventProperties:{from:n,connector:o}}})}function pe(e){const{environment:t,connector:o,from:n}=e;(0,r().u)({environment:t,event:{eventName:"ai_connector_auth_needed_modal_opened",eventProperties:{from:n,connector:o}}})}function ue(e){const{environment:t,sessionId:o,interaction:n}=e;(0,r().u)({environment:t,event:{eventName:"assistant_scope_menu_get_ai_connectors_interaction",eventProperties:{session_id:o,interaction:n}}})}function me(e){const{environment:t,sessionId:o,assistantSurfaceType:n}=e;(0,r().u)({environment:t,event:{eventName:"assistant_follow_up_share_action_user_clicked_button",eventProperties:{session_id:o,assistant_surface_type:n}}})}function fe(e){const{environment:t,sessionId:o,assistantSurfaceType:n}=e;(0,r().u)({environment:t,event:{eventName:"assistant_follow_up_share_action_user_dismissed_share_modal",eventProperties:{session_id:o,assistant_surface_type:n}}})}function ve(e){const{environment:t,sessionId:o,assistantSurfaceType:n}=e;(0,r().u)({environment:t,event:{eventName:"assistant_follow_up_share_action_user_copied_image_success",eventProperties:{session_id:o,assistant_surface_type:n}}})}function he(e){const{environment:t,sessionId:o,assistantSurfaceType:n}=e;(0,r().u)({environment:t,event:{eventName:"assistant_follow_up_share_action_user_copied_image_failure",eventProperties:{session_id:o,assistant_surface_type:n}}})}function ge(e){const{environment:t,sessionId:o,assistantSurfaceType:n,source:i}=e;(0,r().u)({environment:t,event:{eventName:"assistant_click_connect_apps",eventProperties:{source:i,session_id:o,assistant_surface_type:n}}})}},154152:(e,t,o)=>{o.d(t,{z:()=>i});o(16280);var n=()=>o(317053),r=()=>o(458097);async function i({setupGenerator:e,environment:t,parentStore:o,isPhone:i}){(0,n().moveToNextOnboardingStep)(i);const a=r().default.state.open?r().default.state.flowId:void 0,s=await e.submitPrompt({from:"initial-input"}),c=r().default.state.open?r().default.state.flowId:void 0;s&&!(a!==c)&&(0,n().moveToNextOnboardingStep)(i)}},177097:(e,t,o)=>{o.r(t),o.d(t,{addStepsToExistingThreadAndRun:()=>Q,addTranscriptToNewThreadAndRun:()=>q,addTranscriptToNewThreadOnClientAndRun:()=>G,applyWorkflowSetupUpdate:()=>ue,createEmptyWorkflowContainerAndBuild:()=>le,deleteModule:()=>pe,deleteTrigger:()=>X,duplicateWorkflow:()=>se,overrideWorkflowData:()=>de,publishWorkflow:()=>me,reRunWorkflowFromThread:()=>$,removeModule:()=>ae,requestWorkflowLimitIncrease:()=>ge,resetWorkflowToPublished:()=>ve,restoreWorkflowVersion:()=>he,saveConfigVariable:()=>K,saveConversationStarters:()=>re,saveCover:()=>ee,saveCoverPosition:()=>te,saveDescription:()=>oe,saveIcon:()=>Y,saveInstructions:()=>ne,saveModel:()=>ie,saveModule:()=>H,saveName:()=>J,saveTrigger:()=>Z,saveTriggers:()=>j,softDeleteWorkflow:()=>fe,triggerWorkflowAutomation:()=>z});o(16280),o(410838),o(898992),o(354520),o(672577),o(581454);var n=()=>o(242422),r=()=>o(365646),i=()=>o(878456),a=()=>o(158489),s=()=>o(110192),c=()=>o(165358),l=()=>o(388821),d=()=>o(179034),p=()=>o(96689),u=()=>o(234459),m=()=>o(798880),f=()=>o(743246),v=()=>o(439180),h=()=>o(366999),g=()=>o(496703);o(517642),o(658004),o(733853),o(845876),o(432475),o(515024),o(731698);var S=()=>o(188924),_=()=>o(724639),y=()=>o(142918),w=()=>o(498212),I=()=>o(973647),b=()=>o(534177),T=()=>o(559506),k=()=>o(896628),C=()=>o(384944),A=()=>o(666144),M=()=>o(577142),P=()=>o(597527),x=()=>o(231297),R=()=>o(107527),N=()=>o(555102),E=()=>o(166442),V=()=>o(594794),O=()=>o(765957),F=()=>o(148832),B=()=>o(878710),D=()=>o(796977),U=()=>o(253141),W=()=>o(844317);var L=()=>o(22673);function q(e){const{environment:t,spaceStore:o,transcript:n,parentPointer:r,threadId:i,workflowId:a,createdSource:s}=e,c=i??(0,V().Z1)({environment:t,table:u().To,spaceId:o.id});return(0,R().WE)({environment:t,clientStore:E().defaultClientAIChatStore,threadStore:void 0,createThreadArgs:{id:c,transcript:n,workflowId:a,parentPointer:r||{table:p().NX,id:o.id,spaceId:o.id},createdSource:s},sendPatchResponse:!1}),D().E.createChildStore(o,{id:c,spaceId:o.id,table:u().To})}function G(e){const{environment:t,spaceStore:o,clientStore:n,userStore:r,transcript:a,threadId:s,analyticsArgs:c}=e,l=(0,i().f_)(a),{serverCommitResult:d,performResult:p}=x().createAndCommit({userAction:"WorkflowActions.addTranscriptToNewThreadAndRun",environment:t,canUndo:!0,perform:e=>(0,R().aP)({environment:t,spaceStore:o,userStore:r,transaction:e,transcript:a,threadId:s,threadType:(null==l?void 0:l.type)??"workflow"})});return(0,R().WE)({environment:t,clientStore:n,threadStore:p,waitBeforeSending:d,analyticsArgs:c,sendPatchResponse:!1}),p}async function z(e){const{environment:t,spaceStore:o,workflowStore:n,triggerId:r,triggerData:i}=e,a=await T().callApi({eventName:"triggerWorkflowAutomation",environment:t,data:{workflowId:n.id,spaceId:o.id,triggerId:r,triggerData:JSON.stringify(i??{})}});if("failed"===a.type)throw a.error;return a.data}async function $(e){const{environment:t,spaceStore:o,workflowStore:n,threadId:i}=e,a=(D().E.createChildStore(o,{table:u().To,id:i,spaceId:o.id}).getTranscript()||[]).find(r().CK);if(!a)return{newThreadId:void 0};const{threadId:s}=await z({environment:t,spaceStore:o,workflowStore:n,triggerId:a.triggerId,triggerData:a.data??{}});if(s){const e=(0,g().L)({workflowId:n.id,params:{agentChatThreadId:s,workflowViewType:"activity"}});(0,M().navigate)({environment:t,url:e})}return{newThreadId:s}}async function Q(e){const{environment:t,clientStore:o,userStore:n,spaceStore:r,threadStore:i,addSteps:a,waitForServerCommit:s,parentPointer:l,sendPartialTranscript:d,queuedUserMessages:p,sendPatchResponse:u,temporaryAiThreadManager:m,analyticsArgs:f}=e;let v=i,h=!1;if(m&&i.inMemoryRecordCache!==t.defaultRecordCache.inMemoryRecordCache){c().log({type:"just_in_time_creating_thread",from:"addStepsToExistingThreadAndRun",level:"info",data:{miscDataToConvertToString:m.getLogData()}});const e=m.persistTemporaryThreadStoreIfExists();e?(await e.commitResult,v=e.threadStore):(c().log({type:"unabled_to_persist_temporary_thread",from:"addStepsToExistingThreadAndRun",level:"info",data:{miscDataToConvertToString:m.getLogData()}}),h=!0)}const{serverCommitResult:g}=x().createAndCommit({userAction:"WorkflowActions.addStepsToExistingThreadAndRun",environment:t,canUndo:!0,perform:e=>{var o;h&&(v=(0,R().aP)({environment:t,transaction:e,spaceStore:r,userStore:n,threadType:null===(o=a.findLast((e=>"config"===e.type)))||void 0===o?void 0:o.value.type}));(0,R().Vn)({threadStore:v,environment:t,spaceStore:r,userStore:n,addSteps:a,transaction:e}),l&&C().zv({store:v,data:{parent_id:l.id,parent_table:l.table,space_id:l.spaceId},transaction:e})}});(0,R().WE)({environment:t,clientStore:o,threadStore:v,waitBeforeSending:s?g:void 0,stepIdsToInclude:Boolean(d)?a.map((e=>e.id)):void 0,queuedUserMessages:p,sendPatchResponse:u,analyticsArgs:f})}function H(e){const{module:t,workflowStore:o}=e;x().createAndCommit({userAction:"WorkflowActions.saveModule",environment:e.environment,canUndo:!0,perform:e=>{x().applyOperation({store:o,operation:y().xb({pointer:o.pointer,module:t}),transaction:e})}})}function K(e){const{value:t,workflowStore:o}=e;x().createAndCommit({userAction:"WorkflowActions.saveConfigVariable",environment:e.environment,canUndo:!0,perform:e=>{x().applyOperation({store:o,operation:y().bE({pointer:o.pointer,configVariable:t}),transaction:e})}})}function j(e){const{triggers:t,workflowStore:o}=e;x().createAndCommit({userAction:"WorkflowActions.saveTriggers",environment:e.environment,canUndo:!0,perform:e=>{x().applyOperation({store:o,operation:y().IA({pointer:o.pointer,triggers:t}),transaction:e})}})}function Z(e){const{trigger:t,workflowStore:o}=e;x().createAndCommit({userAction:"WorkflowActions.saveTrigger",environment:e.environment,canUndo:!0,perform:e=>{x().applyOperation({store:o,operation:y().NW({pointer:o.pointer,trigger:t}),transaction:e})}})}function X(e){const{trigger:t,workflowStore:o}=e;x().createAndCommit({userAction:"WorkflowActions.deleteTrigger",environment:e.environment,canUndo:!0,perform:e=>{x().applyOperation({store:o,operation:y().LI({pointer:o.pointer,trigger:t}),transaction:e})}})}function J(e){const{name:t,workflowStore:o}=e;x().createAndCommit({userAction:"WorkflowActions.saveName",environment:e.environment,canUndo:!0,perform:e=>{x().applyOperation({store:o,operation:y().i({pointer:o.pointer,name:t}),transaction:e})}})}function Y(e){const{icon:t,workflowStore:o}=e;x().createAndCommit({userAction:"WorkflowActions.saveIcon",environment:e.environment,canUndo:!0,perform:e=>{x().applyOperation({store:o,operation:y().yD({pointer:o.pointer,icon:t}),transaction:e})}})}function ee(e){const{cover:t,workflowStore:o}=e;x().createAndCommit({userAction:"WorkflowActions.saveCover",environment:e.environment,canUndo:!0,perform:e=>{x().applyOperation({store:o,operation:y().KF({pointer:o.pointer,cover:t}),transaction:e})}})}function te(e){const{coverPosition:t,workflowStore:o}=e;x().createAndCommit({userAction:"WorkflowActions.saveCoverPosition",environment:e.environment,canUndo:!0,perform:e=>{x().applyOperation({store:o,operation:y().Bw({pointer:o.pointer,coverPosition:t}),transaction:e})}})}function oe(e){const{description:t,workflowStore:o}=e;x().createAndCommit({userAction:"WorkflowActions.saveDescription",environment:e.environment,canUndo:!0,perform:e=>{x().applyOperation({store:o,operation:y().Xo({pointer:o.pointer,description:t}),transaction:e})}})}function ne(e){const{instructions:t,workflowStore:o}=e;x().createAndCommit({userAction:"WorkflowActions.saveInstructions",environment:e.environment,canUndo:!0,perform:e=>{x().applyOperation({store:o,operation:y().WV({pointer:o.pointer,instructions:t}),transaction:e})}})}function re(e){const{conversationStarters:t,workflowStore:o,environment:n}=e;x().createAndCommit({userAction:"WorkflowActions.saveConversationStarters",environment:n,canUndo:!0,perform:e=>{x().applyOperation({store:o,operation:y().g9({pointer:o.pointer,conversationStarters:t}),transaction:e})}})}function ie(e){const{model:t,workflowStore:o}=e;x().createAndCommit({userAction:"WorkflowActions.saveModel",environment:e.environment,canUndo:!0,perform:e=>{x().applyOperation({store:o,operation:y().iS({pointer:o.pointer,model:t}),transaction:e})}})}function ae(e){const{module:t,workflowStore:o}=e;x().createAndCommit({userAction:"WorkflowActions.removeModule",environment:e.environment,canUndo:!0,perform:e=>{x().applyOperation({store:o,operation:y().$h({pointer:o.pointer,module:t}),transaction:e})}})}function se(e){const{environment:t,workflowStore:o,addToFavorites:n=!0}=e,r=O().default.state.sidebarSpaceStore,i=O().default.state.currentUserStore;if(!r||!i)throw new Error("No current space or user");const a=o.getPublishedArtifactStore(),c=a?a.getData():o.getData();if(!c)throw new Error("No workflow data to duplicate");const l=()=>{},d=(c.modules??[]).map((e=>{const t={...e};if(e.state){const n=(0,S().jK)(e.type);null!=n&&n.stateDuplicator&&(t.state=n.stateDuplicator({original:e.state,mapper:l,requester:o.pointer}))}return t})),p=(c.triggers??[]).map((e=>{var t;const n={...e};if(null!==(t=e.state)&&void 0!==t&&t.type){const t=(0,S().Tc)(e.state.type);null!=t&&t.triggerDuplicator&&(n.state=t.triggerDuplicator({original:e.state,mapper:l,requester:o.pointer}))}return n})),u={name:(0,s().Q)(c.name||"Untitled Agent"),icon:c.icon,description:c.description,instructions:c.instructions,modules:d,triggers:p,model:c.model,runtime_actor_pointer:void 0,published_artifact_pointer:void 0},{performResult:v}=x().createAndCommit({userAction:"WorkflowActions.duplicateWorkflow",environment:t,canUndo:!0,perform:e=>{const o=(0,V().Z1)({environment:t,table:f().C0,spaceId:r.id});return C().vt({environment:t,table:f().C0,args:{id:o,parentPointer:r.pointer,space_id:r.id,data:u,createdByPointer:{table:m().oo,id:i.id},permissions:[{type:"user_permission",role:"editor",user_id:i.id}]},inMemoryRecordCache:r.inMemoryRecordCache,transaction:e})}});return n&&P().addSidebarWorkflow({environment:t,workflowId:v.id}),v}function ce(e){const{environment:t,transaction:o,parentStore:n}=e,{sidebarSpaceStore:r,sidebarSpaceViewStore:i}=O().default.state;if(!r||!i)throw new Error("No current space");const a=C().Wv({environment:t,type:"collection_view_page",transaction:o,inMemoryRecordCache:r.inMemoryRecordCache});(0,U().Ls)({environment:t,parentStore:n??r,collectionViewBlockStore:a,transaction:o,appendOrPrepend:"append",spaceViewStore:i});const s=function(e){const{environment:t,store:o,transaction:n}=e,r={modules:[]};return function(e){const{environment:t,store:o,transaction:n,workflowData:r}=e,i=C().vt({environment:t,table:f().C0,args:{id:(0,V().Z1)({environment:t,table:f().C0,spaceId:o.getSpaceId()}),data:r,parentPointer:{table:d().ev,id:o.id},space_id:o.getSpaceId()},inMemoryRecordCache:o.inMemoryRecordCache,transaction:n});return k().zA({stores:[o],update:{workflow_id:i.id},transaction:n}),i}({environment:t,transaction:n,store:o,workflowData:r})}({environment:t,store:a,transaction:o});return{workflowStore:s,collectionViewBlockStore:a}}async function le(e){const{environment:t,parentStore:o,userStep:n,onThreadChange:r}=e,i=N().bX.state;if(!i)throw new Error("No inference context");const{spaceStore:a}=i,{performResult:s,serverCommitResult:c}=x().createAndCommit({userAction:"SetupGenerator.handlePromptSubmit",environment:t,canUndo:!0,perform:e=>ce({environment:t,transaction:e,parentStore:o})});await c;const{collectionViewBlockStore:l}=s,d=function(e){const{environment:t,inferenceContext:o,addSteps:n=[],config:r}=e;return(0,N().Xd)({environment:t,inferenceContext:o,config:r??(0,W().n)({}),addSteps:n,surface:"workflows"})}({environment:t,inferenceContext:i,store:l,addSteps:[n]}),p=q({environment:t,spaceStore:a,transcript:d});null==r||r(p)}function de(e){const{workflowStore:t,transaction:o,workflow:n}=e;C().KY({store:t.getDataStore(),value:n,transaction:o})}function pe(e){const{workflowStore:t,moduleId:o,environment:n}=e;x().createAndCommit({userAction:"WorkflowActions.deleteModule",environment:n,canUndo:!0,perform:e=>{var n;const r=t.getDraftData();if(!r)return;const i=null===(n=r.modules)||void 0===n?void 0:n.filter((e=>e.id!==o));let a={...r,modules:i};a=function(e){if(!e.triggers||0===e.triggers.length)return e;const t=new Set((e.modules||[]).map((e=>e.id))),o=e.triggers.filter((e=>!e.moduleId||t.has(e.moduleId)));return o.length===e.triggers.length?e:{...e,triggers:o}}(a),de({workflowStore:t,workflow:a,transaction:e})}})}function ue(e){const{environment:t,threadStore:o,operations:n,transaction:r}=e,i=O().default.state.currentUserStore;if(!i)throw new Error("No current user");const s=O().default.state.sidebarSpaceStore;if(!s)throw new Error("No current space");const c=l().RecordMap.create();for(const a of n)if((0,v().ph)(a)){const e=F().B.createChildStore(o,a.pointer);x().applyCrdtTextOperation({store:e,operation:a,transaction:r,invertedOperation:void 0});const t=e.getModel();t&&c.addModel(t)}else{const e=(0,B().v3)(o,a.pointer);x().applyOperation({transaction:r,store:e,operation:a});const t=e.getRecordModel(a.pointer);t&&c.addModel(t)}(0,R().Vn)({threadStore:o,environment:t,spaceStore:s,userStore:i,addSteps:[{id:(0,w().Ay)(),type:"agent-record-map",threadRecordMap:(0,a().he)(c)}],transaction:r})}async function me(e){const{environment:t,workflowStore:o}=e,n=o.getSpaceId();if(!n)throw new Error("Cannot publish workflow without space ID");const r=o.getDraftData();if(!r)throw new Error("Workflow has no data");const i=(0,_().Cu)(r);return I().Q.isFail(i)?i:(await T().callApi({eventName:"publishCustomAgentVersion",environment:t,data:{workflowId:o.id,spaceId:n}}),await A().sy({environment:t,inMemoryRecordCache:o.inMemoryRecordCache,pointer:o.pointer,userId:void 0}),I().Q.success(void 0))}async function fe(e){const{environment:t,workflowStore:o}=e,{serverCommitResult:n}=x().createAndCommit({environment:t,userAction:"workflowActions.softDeleteWorkflow",perform:e=>{x().applyOperation({store:o,transaction:e,operation:{pointer:o.pointer,command:"set",path:["alive"],args:!1}});const t=o.getData(),n=(null==t?void 0:t.triggers)||[];if(n.length>0){const t=n.map((e=>({...e,enabled:!1})));x().applyOperation({store:o,operation:y().IA({pointer:o.pointer,triggers:t}),transaction:e})}},canUndo:!0});P().removeSidebarWorkflow({environment:t,workflowId:o.id}),await n}function ve(e){const{environment:t,workflowStore:o}=e,n=o.getPublishedArtifactStore(),r=null==n?void 0:n.getData(),i=r?(0,h().h)(r):{name:void 0,icon:void 0,instructions:void 0,modules:void 0,triggers:void 0,model:void 0};x().createAndCommit({userAction:"WorkflowActions.resetWorkflowToPublished",environment:t,canUndo:!1,perform:e=>{for(const[t,n]of(0,b().WP)(i)){const r={path:["data",t],command:"set",args:n,pointer:o.pointer};x().applyOperation({store:o,operation:r,transaction:e})}}})}async function he(e){const{environment:t,workflowStore:o,workflowArtifactStore:n}=e,r=n.getData(),i=r?(0,h().h)(r):{},a=x().createAndCommit({userAction:"WorkflowActions.restoreWorkflowVersion",environment:t,canUndo:!0,perform:e=>{for(const[t,n]of Object.entries(i)){const r={path:["data",t],command:"set",args:n,pointer:o.pointer};x().applyOperation({store:o,operation:r,transaction:e})}}});await a.serverCommitResult;const s=await me({environment:t,workflowStore:o});if(I().Q.isFail(s))throw new(_().nc)("Failed to publish restored version",s.error)}async function ge(e){const{environment:t,workflowStore:o,amount:r,reason:i}=e,a=o.getDraftData(),s=null==a?void 0:a.usage_limit,c=null==a?void 0:a.paused_reason,l=n().default.getConfig({configName:"custom_agent_sub_features"}),d=(null==l?void 0:l.default_run_limit)??100,p="runLimit"===(null==s?void 0:s.type)?s.maximum:d,u=p+r;(0,L().rQ)({environment:t,workflowId:o.id,amountRequested:r,reason:i,currentLimit:p,newLimit:u});const m=x().createAndCommit({environment:t,userAction:"WorkflowLimitIncreaseRequest",canUndo:!1,perform:e=>{const t={pointer:o.pointer,command:"set",path:["data","usage_limit"],args:{type:"runLimit",maximum:u}};if(x().applyOperation({store:o,operation:t,transaction:e}),"runLimit"===(null==c?void 0:c.reason)){const t={pointer:o.pointer,command:"set",path:["data","paused_reason"],args:void 0};x().applyOperation({store:o,operation:t,transaction:e});const n={pointer:o.pointer,command:"set",path:["data","status"],args:"runnable"};x().applyOperation({store:o,operation:n,transaction:e})}}});await m.serverCommitResult}},252463:(e,t,o)=>{o.d(t,{zc:()=>p,CM:()=>m,UB:()=>u});o(898992),o(354520),o(581454);var n=()=>o(890409),r=()=>o(973647),i=()=>o(534177),a=()=>o(314529);const s={};var c=()=>o(862292),l=()=>o(909470),d=()=>o(546461);function p(e){const{automationActionStore:t,automationStore:o,formulaAnalyticsModule:a,formulasModule:s,simpleFormulasModule:c}=e,p=t.getModel(),u=o??t.getParentStore();if(!p||!u)return;const m=u.getActionStores().map((e=>e.getModel())).filter(i().O9),f=(0,d().To)(u);let v=[];return f&&r().Q.isSuccess(f)&&(v=f.value.valueTypes),(0,n()._f)({automationActionModel:p,automationActionModels:m,formulaAnalyticsModule:a,formulasModule:s,simpleFormulasModule:c,formulaTypecheckContextValues:v,getRecordModel:t.getRecordModel,featureGates:(0,l().i)()})}function u(e,t){const{automationStore:o,automationActionStore:n}=t;o.isTriggerType("event")||m(((t,r,i)=>{const c=p({automationActionStore:n,automationStore:o,formulaAnalyticsModule:r,formulasModule:t,simpleFormulasModule:i});c&&function(e,t,o,n,r,i){const c=s[o];c&&(clearTimeout(c),delete s[o]),s[o]=setTimeout((()=>{delete s[o],(0,a().DO_NOT_USE_trackLegacy)(e,t,r,i)}),1e3*n)}(e,"automation_action_update",n.id,1,{automation_action:c,automation_action_id:n.id,automation_id:o.id})}))}function m(e){return Promise.all([c().T.formulas.load(),c().T.formulaAnalytics.load(),c().T.simpleFormulas.load()]).then((([t,o,n])=>{e(t,o,n)})).catch((e=>{console.error("Error sending analytics for automations",e)}))}},253141:(e,t,o)=>{o.d(t,{Ls:()=>$,mm:()=>L,my:()=>q,gv:()=>G});o(16280),o(944114),o(517642),o(658004),o(733853),o(845876),o(432475),o(515024),o(731698),o(581454);var n=()=>o(726637),r=()=>o(663077),i=()=>o(651124),a=()=>o(179034),s=()=>o(869558),c=()=>o(96689),l=()=>o(854150),d=()=>o(201980),p=()=>o(534177),u=()=>o(970330),m=()=>o(557281),f=()=>o(896628),v=()=>o(722101),h=()=>o(44729),g=()=>o(384944),S=()=>o(185544),_=()=>o(955930),y=()=>o(231297),w=()=>o(766854),I=()=>o(688742),b=()=>o(58415),T=()=>o(414360),k=()=>o(496592),C=()=>o(586481),A=()=>o(389658),M=()=>o(972435),P=()=>o(493260),x=()=>o(765957),R=()=>o(913530),N=()=>o(317053),E=()=>o(922952),V=()=>o(913454),O=()=>o(204067),F=()=>o(101926),B=(o(898992),o(354520),()=>o(899164)),D=()=>o(290966);function U(e){const{environment:t,transaction:o,collectionStore:n,template:i,targetCollectionStore:a,logger:s}=e,{value:c}=i,l=(0,F().ai)(e);if(!l)throw new Error(`relationPropertyPointer not created for ${i.templateId}`);if("property"!==l.type)throw new Error(`Instance pointer returned is not of property type: ${l.type}`);const d=new(I().B)(t);d.setContext({type:"collectionPage",collectionStore:n});const{inverseRelationPropertyId:p}=B().cT({environment:t,transaction:o,intl:M().A.getIntl(),collectionContextStore:d,collectionStore:n,property:l.id,targetCollectionStore:a,hasInverseRelation:!0,inverseName:void 0,propertyName:c.name,autoRelate:c.autoRelate,propertyLimit:1===c.limit?"1":"no_limit"});if(p){const e=function({environment:e,sourceCollectionStore:t,targetCollectionStore:o}){const n=(0,O().tY)({environment:e,collectionStore:t}),i=(0,O().tY)({environment:e,collectionStore:o});if(!n||!i)return;const a=(0,r().bQ)(i).map((e=>V().globalWorkflowTemplates.fromId(e))).filter((e=>(0,r().Sz)(e)));for(const r of a)if(r.relatedCollectionTemplateId===n.templateId)return r}({environment:t,sourceCollectionStore:n,targetCollectionStore:a});e&&(s.log(`Instantiating relation property template "${e.templateId}" because it is the inverse of "${i.templateId}".`),(0,D().ZQ)({transaction:o,collectionStore:a,templateId:e.templateId,instance:{type:"property",id:p,collectionId:a.id},logger:s}))}return l}var W=()=>o(839754);function L({environment:e,transaction:t,template:o,parentStore:n,existingCollectionInfo:i,inMemoryRecordCache:a,selectedFeatureTemplateIds:c,collectionViewBlockType:l="collection_view_page",relationInfos:p,logger:v}){var h;v.log(`Instantiating collection template "${o.templateId}".`);const{collectionStore:S,collectionViewBlockStore:_}=function({environment:e,transaction:t,template:o,parentStore:n,existingCollectionInfo:r,collectionViewBlockType:i="collection_view_page",inMemoryRecordCache:a,logger:s}){var c;if(!(0,E().u)(n))throw new Error(`Parent store is not a valid  collection template parent store ${n.table}`);let l;if(r){const{collectionStore:e,collectionViewStore:o}=r;l=r.collectionViewBlockStore,o&&(0,T().T)({collectionViewBlockStore:l,collectionViewStore:o,transaction:t}),e&&(0,k().removeCollectionFromCollectionViewBlock)({collectionViewBlockStore:l,collectionStore:e,transaction:t})}else l=z({environment:e,transaction:t,parentStore:n,collectionViewBlockType:i,inMemoryRecordCache:a});const{name:p,icon:u,description:m}=o.value.targetCollection,f=(0,b().E)({environment:e,collectionViewBlockStore:l,transaction:t,collectionValue:{name:(0,d().x9d)(p),icon:u,description:m,format:{item_name_config:o.value.targetCollection.itemName,item_name_config_v2:null===(c=o.value.targetCollection.format)||void 0===c?void 0:c.item_name_config_v2},schema:{title:{name:M().A.formatMessage(A().n4.namePropertyTitle),type:"title"}}}});if(!x().default.state.sidebarSpaceStore)throw new Error("No current space store");return{collectionStore:f,collectionViewBlockStore:l}}({environment:e,transaction:t,template:o,parentStore:n,existingCollectionInfo:i,collectionViewBlockType:l,inMemoryRecordCache:a,logger:v});(0,D().ZQ)({transaction:t,collectionStore:S,templateId:o.templateId,instance:{type:"collection",id:S.id},logger:v});const{allFeatureTemplates:y,nonRelationPropertyTemplates:P}=function({template:e,selectedFeatureTemplateIds:t}){if(t){const o=new Set((0,r().bQ)(e));for(const n of t)if(!o.has(n))throw new Error(`Feature template ID ${n} is not part of collection template ${e.templateId}`)}const{templateItems:o}=e.value,n=(0,r().b2)(o,"required"),i=(0,r().b2)(o,"optionalDefaultOn"),a=new Set([...n,...t??i]),s=Array.from(a).map(V().globalWorkflowTemplates.featureFromId),c=[],l=[];for(const d of s)(0,r().Sz)(d)?c.push(d):l.push(d);return{allFeatureTemplates:s,relationPropertyTemplates:c,nonRelationPropertyTemplates:l}}({template:o,selectedFeatureTemplateIds:c}),B=[];for(const r of P){const o=(0,F().e_)({environment:e,transaction:t,collectionStore:S,template:r,logger:v,origin:"collection_creation"});"collection_view"===(null==o?void 0:o.type)&&B.push(o),(0,F().Ix)({environment:e,transaction:t,collectionStore:S,template:r,logger:v})}if(0===B.length)throw new Error("No collection view templates to create");const L=R().p.createChildStore(_,{table:s().Gy,id:B[0].id});p&&function({environment:e,transaction:t,currentCollectionStore:o,relationInfos:n,logger:r}){for(const i of n){const{sourceCollectionStore:n,targetCollectionStore:a}=Q({currentCollectionStore:o,relationInfo:i});U({environment:e,transaction:t,origin:"collection_creation",collectionStore:n,targetCollectionStore:a,template:i.relationPropertyTemplate,logger:r})}}({environment:e,transaction:t,currentCollectionStore:S,relationInfos:p,logger:v});const q=(0,V().getPropertyTemplates)(y);(0,W().My)({transaction:t,collectionStore:S,propertyTemplates:q}),(0,W().Bi)({transaction:t,collectionStore:S,propertyTemplates:q}),function(e){const{transaction:t,collectionStore:o,template:n,logger:r}=e,{format:i}=n.value.targetCollection;if("object"!=typeof(null==i?void 0:i.collection_default_template))return;const a=(0,O().fI)({collectionStore:o,sourceTemplateType:"block",dependencyMap:n.dependencyMap??{},sourcePrimitiveId:i.collection_default_template.template_page_id});a?f().zA({stores:[o],update:{collection_default_template:{template_page_id:a}},transaction:t}):r.warn("Unable to resolve collection default template, omitting it.")}({transaction:t,template:o,collectionStore:S,logger:v}),"tasks"===o.category&&(0,N().maybeAddAppTemplateMetadataForTasks)({environment:e,collectionStore:S,collectionViewBlockStore:_,transaction:t}),function({transaction:e,collectionViewBlockStore:t}){const o=t.getFormat();("workflow_template_placeholder"===o.collection_view_sub_type||o.placeholder_workflow_template_id)&&f().zA({stores:[t],update:{placeholder_workflow_template_id:void 0,collection_view_sub_type:void 0},transaction:e});"app_container"===o.collection_view_sub_type&&o.app_config_uri&&!o.app_initialized&&f().zA({stores:[t],update:{app_config_uri:void 0,app_template_preset:void 0,app_template_features:void 0,app_initialized:void 0,collection_view_sub_type:void 0},transaction:e})}({transaction:t,collectionViewBlockStore:_});let $=[];return null!==(h=o.value.exampleRows)&&void 0!==h&&h.length&&($=function({environment:e,transaction:t,collectionStore:o,collectionViewStore:n,collectionViewBlockStore:r,exampleRows:i,dependencyMap:a}){const s=new(I().B)(e);s.setContext({type:"collectionView",collectionViewBlockStore:r,collectionStore:o,collectionViewStore:n,pageVisitSourceOverride:void 0});const c=[],l=s.defaultPageTemplateStore.state,{inMemoryRecordCache:d}=r;for(const p of i){const{newStore:n}=(0,w().Q)({environment:e,collectionContextStore:s,groupsPointer:[],insertAtIndex:0,shouldCoerce:!0,transaction:t,from:{createBlock:"workflow_template"},inMemoryRecordCache:d});c.push(n);const r=G({collectionStore:o,dependencyMap:a,exampleRow:p});(0,C().L)({environment:e,store:n,properties:r.properties,transaction:t}),l&&m().n5({title:"template",environment:e,store:n,templateStore:l,isKeyboard:!1,isCreateIn:!1,transaction:t,from:"collection_template_actions"});const i=n.getIconStore();p.icon&&i&&g().KY({store:i,value:p.icon,transaction:t})}return c}({environment:e,transaction:t,collectionStore:S,collectionViewStore:L,collectionViewBlockStore:_,exampleRows:o.value.exampleRows,dependencyMap:o.dependencyMap??{}})),t.postSubmitCallbacks.push((t=>{t||a.isTemporaryData||u().vH(e,{from:"workflow_template",type:_.getType()??"collection_view_page",creating_block_id:_.id,collection_view_block_id:_.id,collection_view_id:L.id,collection_id:S.id,view_type:L.getType()})})),{collectionStore:S,collectionViewStore:L,collectionViewBlockStore:_,examplePageStores:$}}function q(e){const{environment:t,parentStore:o,title:r,onFinish:a}=e,{performResult:{collectionViewBlockStore:c,collectionViewStore:l,collectionStore:p}}=y().createAndCommit({userAction:"workflowTemplatesOnboardingModal.addEmptyDatabase",environment:t,canUndo:!0,perform:a=>{let c=e.collectionViewBlockStore;void 0===c&&(c=z({environment:t,transaction:a,parentStore:o,collectionViewBlockType:"collection_view_page",inMemoryRecordCache:o.inMemoryRecordCache}));const l=(0,b().E)({environment:t,collectionViewBlockStore:c,transaction:a,collectionValue:{name:r?(0,d().x9d)(r):void 0,schema:{title:{name:M().A.formatMessage(A().n4.namePropertyTitle),type:"title"}}}});void 0===e.collectionViewBlockStore&&u().vH(t,{from:"workflow_template",type:"collection_view_page",new_page_id:c.id,creating_block_id:c.id,collection_id:l.id});const p=g().eC({environment:t,table:s().Gy,inMemoryRecordCache:c.inMemoryRecordCache,value:{type:"table",parent_id:c.id,parent_table:c.table,space_id:c.getSpaceId(),format:{collection_pointer:l.pointer,table_properties:[{property:"title",visible:!0,width:n().A.isMobile?i().PI:i().Xv}]},alive:!0},transaction:a}),m=R().p.createChildStore(c,p.pointer);return(0,P().F)(m.id,{viewType:"table",isPlaceholderCollection:!0}),v().BC({parentStore:c.getCollectionViewsStore(),appendStore:m,transaction:a}),{collectionViewBlockStore:c,collectionViewStore:m,collectionStore:l}}});return a&&a(c),{collectionViewBlockStore:c,collectionViewStore:l,collectionStore:p}}function G({exampleRow:e,dependencyMap:t,collectionStore:o}){const n={properties:{}};for(const[r,i]of Object.entries(e.properties))n.properties[(0,O().CB)({collectionStore:o,sourceTemplateType:"property",dependencyMap:t,sourcePrimitiveId:r})]=i;return n}function z({environment:e,transaction:t,parentStore:o,collectionViewBlockType:n,inMemoryRecordCache:r}){var i;const a=g().Wv({environment:e,type:n,inMemoryRecordCache:r,transaction:t});return g().zv({store:a,transaction:t,data:{parent_id:o.id,parent_table:o.table,alive:!0}}),$({environment:e,spaceViewStore:null===(i=x().default.state.sidebarSpaceViewStore)||void 0===i?void 0:i.clone(r),parentStore:o,collectionViewBlockStore:a,transaction:t,appendOrPrepend:"append"}),a}function $({environment:e,parentStore:t,collectionViewBlockStore:o,transaction:n,appendOrPrepend:r,spaceViewStore:i}){if(t.table===a().ev)h().NI({parentStore:t,childStore:o,transaction:n});else if(t.table===c().NX){if((null==i?void 0:i.getSpaceId())!==t.id)throw new Error(`spaceViewStore doesn't match parent with ID ${t.id}`);S().yM({environment:e,spaceStore:t,spaceViewStore:i,pageStore:o,isPrivate:!0,transaction:n})}else t.table===l().yK?_().sP({teamStore:t,store:o,transaction:n,location:{type:r}}):(0,p().HB)(t)}function Q({currentCollectionStore:e,relationInfo:t}){const{type:o,collectionStore:n}=t;return"source"===o?{sourceCollectionStore:n,targetCollectionStore:e}:"target"===o?{sourceCollectionStore:e,targetCollectionStore:n}:void(0,p().HB)(o)}},317053:(e,t,o)=>{o.r(t),o.d(t,{createCollectionTemplateFromModalState:()=>ne,createMinimalCollectionTemplateWithoutModal:()=>te,createPlaceholderWorkflowTemplateBlock:()=>ce,getSetupGeneratorForTemplate:()=>X,getTemplateOnboardingVersion:()=>j,handleSelectTemplateFromOnboardingModal:()=>Y,maybeAddAppTemplateMetadataForTasks:()=>ae,moveToNextOnboardingStep:()=>me,moveToPreviousOnboardingStep:()=>ue,onNavigateToPlaceholderWorkflowTemplateBlock:()=>le,openSelectedTemplateOnboardingModalForInAppFlows:()=>J,openTemplateOnboardingModal:()=>K,retryAiSetup:()=>de,setFollowUpInputFocused:()=>pe,switchModalToTemplate:()=>ee,toggleFeatureSelectionInPreview:()=>se});o(16280),o(898992),o(354520),o(672577),o(581454);var n=()=>o(584262),r=()=>o(66689),i=()=>o(536095),a=()=>o(663077),s=()=>o(700500),c=()=>o(206267),l=()=>o(201980),d=()=>o(496603),p=()=>o(498212),u=()=>o(973647),m=()=>o(534177),f=()=>o(896628),v=()=>o(496414),h=()=>o(384944),g=()=>o(857783),S=()=>o(471995),_=()=>o(231297),y=()=>o(755199),w=()=>o(766854),I=()=>o(688742),b=()=>o(586481),T=()=>o(211716),k=()=>o(972435),C=()=>o(154152),A=(o(18107),o(410838),o(813451),o(967357),o(737550),()=>o(564884)),M=()=>o(155792),P=()=>o(449412),x=()=>o(594794),R=()=>o(349379);o(944114);class N{constructor(){this.root=new E}append(e){if(this.root.isEmpty())this.root.addChild(e);else{const t=this.toNodes().at(-1);if(!t)throw new Error("Last node not found");t.addChild(e)}}toNodes(){return this.root.getSelectedPath()}toValues(){return this.toNodes().map((e=>e.value))}removeLast(){const e=this.toNodes().at(-1);if(!e)return;const t=e.value;return e.remove(),t}removeLastMatching(e){const t=this.toNodes().findLastIndex((t=>e(t.value)));if(-1===t)return[];const o=[];for(;this.toNodes().length>t;){const e=this.removeLast();void 0!==e&&o.push(e)}return o}}class E{constructor(){this.children=[],this.selectedChild=void 0}addChild(e){const t=new V(e,this);return this.children.push(t),this.selectedChild=t,t}getSelectedPath(){var e;return(null===(e=this.selectedChild)||void 0===e?void 0:e.toSelectedPath())??[]}isEmpty(){return 0===this.children.length}getChildren(){return this.children}setSelectedChild(e){if(!this.children.includes(e))throw new Error("Cannot select a node that is not a child");this.selectedChild=e}removeChild(e){const t=this.children.indexOf(e);-1!==t&&(this.children.splice(t,1),this.selectedChild===e&&(this.selectedChild=void 0))}}class V{constructor(e,t){this.value=void 0,this.children=[],this.selectedChild=void 0,this.parent=void 0,this.isRemoved=!1,this.value=e,this.parent=t}addChild(e){const t=new V(e,this);return this.children.push(t),this.selectedChild=t,t}toSelectedPath(){const e=[this];return this.selectedChild&&e.push(...this.selectedChild.toSelectedPath()),e}retry(e){if(this.isRemoved)throw new Error("Cannot retry on a removed node");this.parent.addChild(e)}select(e){if(this.isRemoved)throw new Error("Cannot select on a removed node");const t=this.parent.getChildren(),o=e(t.map((e=>e.value)),this.value);if(void 0===o)return!1;const n=t.find((e=>e.value===o));return n?this.parent.setSelectedChild(n):this.parent.addChild(o),!0}selectOrRetry(e){if(!this.select(e)){const t=e([],void 0);void 0!==t&&this.retry(t)}}remove(){if(this.children.length>0)throw new Error("Cannot remove a node that has children");if(this.isRemoved)throw new Error("Node is already removed");this.parent.removeChild(this),this.isRemoved=!0}getChildren(){return this.children}setSelectedChild(e){if(!this.children.includes(e))throw new Error("Cannot select a node that is not a child");this.selectedChild=e}removeChild(e){const t=this.children.indexOf(e);-1!==t&&(this.children.splice(t,1),this.selectedChild===e&&(this.selectedChild=void 0),e.isRemoved=!0)}}class O extends(()=>o(757695))().Store{constructor(...e){super(...e),this.derivedUiStore=new(o(496506).ComputedStore)((()=>{var e;const t=(null===(e=this.state.transcriptTree)||void 0===e||null===(e=e.toNodes())||void 0===e?void 0:e.filter((e=>"setup"===e.value.type)))??[];return{canFollowUp:t.length<5,canRetry:t.length>=2}}),{debugName:"derivedUiStore",useDeepEqual:!0})}getInitialState(){return{isBusy:!1,transcriptTree:new N}}setPrompt(e){this.setState({...this.state,prompt:e})}}class F{constructor(e){this.environment=void 0,this.generatedSetupCount=0,this.store=void 0,this.error=void 0,this.spaceId=void 0,this.eventBase=void 0,this.abortController=void 0,this.onSetupReady=void 0,this.setPrompt=e=>{this.store.setState({...this.store.state,prompt:e})},this.submitPrompt=async e=>{var t;const{from:n}=e,r="follow-up"===n,{isBusy:i,prompt:a}=this.store.state;if(i||!a)return!1;if(!this.spaceId)return!1;this.store.setState({...this.store.state,isBusy:!0}),null===(t=this.store.state.transcriptTree.toNodes().find((e=>"config"===e.value.type)))||void 0===t||t.selectOrRetry((e=>{const t=e.find((e=>"config"===e.type&&"setup-generator"===e.value.type));return t||{id:(0,x().Z1)({environment:this.environment,table:M().mS,spaceId:this.spaceId}),type:"config",value:{type:"setup-generator"}}}));try{var s;const e=this.store.state.transcriptTree.toNodes().find((e=>"user"===e.value.type));if(e&&!r)e.selectOrRetry((e=>{const t=e.find((e=>"user"===e.type&&(0,l().MTk)(a,e.value)));if(t)return t;{var o;const e=null===(o=this.environment.currentUser)||void 0===o?void 0:o.id;if(!e)throw new Error("Current user not found");return{id:(0,x().Z1)({environment:this.environment,table:M().mS,spaceId:this.spaceId}),type:"user",value:a,userId:e}}}));else{var c;const e=null===(c=this.environment.currentUser)||void 0===c?void 0:c.id;if(!e)throw new Error("Current user not found");this.store.state.transcriptTree.append({id:(0,x().Z1)({environment:this.environment,table:M().mS,spaceId:this.spaceId}),type:"user",value:a,userId:e})}const t=this.store.state.transcriptTree.toValues();if(!t.slice(t.findLastIndex((e=>"user"===e.type))+1).some((e=>"setup"===e.type))){const e=(0,p().Ay)(),n=new AbortController;this.abortController=n;let r=!1;try{const i=await(0,o(348869).g)({environment:this.environment,abortSignal:n.signal,data:{traceId:e,generateTitle:!1,transcript:t,spaceId:this.spaceId},onResponse:e=>{"setup-operations"===e.type&&this.store.setState({...this.store.state,progress:e.progress}),"retry"!==e.type||r||(r=!0,S().D6({label:"This is taking a little longer than usual"}))}});if(this.abortController=void 0,this.store.setState({...this.store.state,progress:void 0,feedbackArgs:this.computeFeedbackArgs()}),!u().Q.isSuccess(i))return P().O8(i.error,{from:"fullPageTranslationActions.generateAndApplyTranslationMapToPage",type:"error"}),this.onSetupReady({error:i.error}),!1;const a=function(e){const t=new Map;for(const o of e){const e="string"==typeof o.id?o.id:String(o.id),n=t.get(e);n&&"setup-operations"===n.type&&"setup-operations"===o.type?t.set(e,{...n,operations:[...n.operations,...o.operations]}):t.set(e,o)}return Array.from(t.values())}(i.value.filter(o(592933).Vf));for(const e of a)this.store.state.transcriptTree.append(e)}finally{this.abortController=void 0}}const n=null===(s=this.store.state.transcriptTree.toValues().findLast((e=>"setup"===e.type)))||void 0===s?void 0:s.setup;if(!n)throw new Error("Missing setup step");return this.generatedSetupCount++,this.store.setState({...this.store.state,setup:n,prompt:void 0}),this.trackGeneratedSetup(n),this.onSetupReady({value:n}),!0}catch(d){return d instanceof Error&&"AbortError"===d.name||(P().O8(d,{from:"setupGenerator.submitPrompt",type:"error"}),this.onSetupReady({error:{code:500,message:"Unknown error"}})),!1}finally{this.store.setState({...this.store.state,isBusy:!1,feedbackArgs:this.computeFeedbackArgs()})}},this.stopGenerating=()=>{var e;null===(e=this.abortController)||void 0===e||e.abort()},this.discardLatestSetup=()=>{var e,t;const o=null===(e=this.store.state.transcriptTree.toValues().findLast((e=>"user"===e.type)))||void 0===e?void 0:e.value;if(!o)return;this.store.state.transcriptTree.removeLastMatching((e=>"user"===e.type));const n=null===(t=this.store.state.transcriptTree.toValues().findLast((e=>"setup"===e.type)))||void 0===t?void 0:t.setup;this.store.setState({...this.store.state,prompt:o,setup:n,feedbackArgs:this.computeFeedbackArgs()}),n&&this.onSetupReady({value:n}),(0,A().u)({environment:this.environment,event:{eventName:"setup_generator_try_again_clicked",eventProperties:this.eventBase}})};const{environment:t,spaceId:n,onSetupReady:r,initialPrompt:i,analyticsArgs:a}=e;if(this.environment=t,this.spaceId=n,this.eventBase={flow_id:a.workflowTemplatesFlowId??(0,p().Ay)(),origin:a.origin,has_selection_modal_search_query:a.hadSelectionModalSearchEntered,data_source_session_id:a.dataSourceSessionId,data_source_from:a.dataSourceFrom},this.store=new O,this.store.state.transcriptTree.append({id:(0,x().Z1)({environment:t,table:M().mS,spaceId:n}),type:"config",value:{type:"setup-generator"}}),i){var s;this.store.setState({...this.store.state,prompt:i});const e=null===(s=this.environment.currentUser)||void 0===s?void 0:s.id;e&&this.store.state.transcriptTree.append({id:(0,x().Z1)({environment:t,table:M().mS,spaceId:n}),type:"user",value:i,userId:e})}this.onSetupReady=r}computeFeedbackArgs(){const{setup:e}=this.store.state,t=null==e?void 0:e.metadata.setupId;if(t&&this.store.state.transcriptTree)return{spaceId:this.spaceId,traceId:t,transcript:this.store.state.transcriptTree.toValues()}}discardAllSetups(){var e;if(!this.store.state.transcriptTree)return;const t=this.store.state.transcriptTree.toNodes().findIndex((e=>"user"===e.value.type));if(-1===t)return;const o=this.store.state.transcriptTree.toValues().at(t);if(!o||"user"!==o.type)return;for(;this.store.state.transcriptTree.toNodes().length>t;)this.store.state.transcriptTree.removeLast();const n=null===(e=this.store.state.transcriptTree.toValues().findLast((e=>"setup"===e.type)))||void 0===e?void 0:e.setup;this.store.setState({...this.store.state,prompt:o.value,setup:n,feedbackArgs:this.computeFeedbackArgs()}),n&&this.onSetupReady({value:n})}trackSessionStarted(){(0,R().Vd)({environment:this.environment,eventProperties:this.eventBase})}trackSessionEnded(e){const{reason:t}=e;(0,A().u)({environment:this.environment,event:{eventName:"setup_generator_session_ended",eventProperties:{...this.eventBase,generated_setup_count:this.generatedSetupCount,reason:t}}})}trackGeneratedSetup(e){const{metadata:t}=e,{setupId:o,promptInfo:n}=t,r=e.allTemplates.filter((e=>(0,a().Xq)(e,"collection"))).length,i=e.allTemplates.filter((e=>(0,a().Xq)(e,"collection_view"))).length,s=e.allTemplates.filter((e=>(0,a().Xq)(e,"property"))).length;(0,R().If)({environment:this.environment,eventProperties:{...this.eventBase,setup_id:o,prompt_type:"custom",collection_count:r,collection_view_count:i,property_count:s,total_duration_ms:e.metadata.timing.total,warning_count:e.metadata.warnings.length,error_count:e.metadata.errors.length,use_case:null==n?void 0:n.useCase,prompt_specificity:null==n?void 0:n.specificity,prompt_language:null==n?void 0:n.language}})}}var B=()=>o(148832),D=()=>o(973891),U=()=>o(253141),W=()=>o(101926),L=()=>o(922952),q=()=>o(913454);function G({environment:e,parentStore:t,collectionTemplate:o}){if(!t.getSpaceId())throw new Error(`Space ID not found for ${t}`);const n=(0,a().bQ)(o).map((e=>q().globalWorkflowTemplates.fromId(e))).filter((e=>(0,a().Sz)(e))),r=[];for(const i of n){const{relatedCollectionTemplateId:o}=i,n=(0,q().getChildCollectionStoreByTemplateId)({environment:e,parentStore:t,collectionTemplateId:o});n&&r.push({type:"target",collectionStore:n,relationPropertyTemplate:i})}return r}var z=()=>o(204067),$=()=>o(605315),Q=()=>o(466934),H=()=>o(458097);function K({template:e,parentStore:t,origin:o,version:n,existingCollectionInfo:r,relationInfos:i,navigateToOnFinish:a="created_collection",setupGenerator:s,flowId:c,dataSourceAnalytics:l,onClose:d}){const p=e?(0,Q().C8)({collectionTemplate:e,origin:o,flowId:c,parentStore:t,dataSourceAnalytics:l,existingCollectionInfo:r}):(0,Q().XM)({origin:o,flowId:c,parentStore:t,dataSourceAnalytics:l});D().T_(),H().default.setState({open:!0,isSaving:!1,currentStepIndex:0,version:n,existingCollectionInfo:r,relationInfos:i??[],navigateToOnFinish:a,setupGenerator:s,onClose:d,...p,parentStore:t})}function j(e){if(!e.template)return"select_and_customize_template";const{includeTemplateSelectionStep:t,hasSetupGenerator:o}=e;return o?t?"select_and_build_with_ai":"build_with_ai":t?"select_and_customize_template":"customize_template"}const Z=(0,o(69708).YK)({setupGenerationError:{id:"setupGenerator.error.failedToGenerateSetup",defaultMessage:"Sorry, something went wrong while completing this request. Please try again."},setupGenerationRateLimitError:{id:"setupGenerator.error.rateLimited",defaultMessage:"Too many requests. Please try again later."}});function X({environment:e,parentStore:t,template:o,initialAiPrompt:n,analyticsArgs:r}){const i=null==t?void 0:t.getSpaceId(),s=(0,a().cB)(o.templateId)?new F({environment:e,analyticsArgs:r,spaceId:i,initialPrompt:n,onSetupReady:e=>{const t=H().default.state;if(!t.open)return;if(u().Q.isFail(e))return void(429===e.error.code?S().D6({label:k().A.formatMessage(Z.setupGenerationRateLimitError)}):S().D6({label:k().A.formatMessage(Z.setupGenerationError)}));const o=e.value;if(t.setupGenerator!==s)return;$().Z.append(o.allTemplates.filter((e=>e.isAiGenerated)));const n=o.allTemplates.find((e=>(0,a().Xq)(e,"collection")));if(!n)throw new Error("No collection template found");ee(n)}}):void 0;return s}function J({template:e,environment:t,aiPrompt:o,autoSubmit:n=!1,version:r,...i}){var a;const{parentStore:s,relationInfos:c,origin:l,flowId:u=(0,p().Ay)(),dataSourceAnalytics:m}=i,f=((null===(a=i.collectionTemplatesSearchQuery)||void 0===a?void 0:a.length)??0)>0,v=t.device.isPhone,h=G({environment:t,parentStore:s,collectionTemplate:e}),g=X({environment:t,template:e,parentStore:s,initialAiPrompt:o,analyticsArgs:{origin:l,hadSelectionModalSearchEntered:f,workflowTemplatesFlowId:u,...m}});K({...i,template:e,flowId:u,version:r??j({template:e,includeTemplateSelectionStep:!1,hasSetupGenerator:Boolean(g)}),relationInfos:d().hS([...c??[],...h],(e=>e.collectionStore.id)),setupGenerator:g}),g&&n&&(0,C().z)({setupGenerator:g,environment:t,parentStore:s,isPhone:v})}function Y({template:e,environment:t,analyticsArgs:o}){var n,r;const a=H().default.state;if(!a.open||!a.parentStore)return;const{parentStore:s,relationInfos:c,origin:p,flowId:u,dataSourceAnalytics:m}=a,f=t.device.isPhone,v=a.collectionTemplatesSearchQuery?(0,l().x9d)(a.collectionTemplatesSearchQuery):void 0,h=G({environment:t,parentStore:s,collectionTemplate:e}),g=d().hS([...c??[],...h],(e=>e.collectionStore.id)),S=X({environment:t,template:e,parentStore:s,analyticsArgs:{origin:p,hadSelectionModalSearchEntered:((null===(n=a.collectionTemplatesSearchQuery)||void 0===n?void 0:n.length)??0)>0,workflowTemplatesFlowId:u,...m},initialAiPrompt:v}),_=j({template:e,includeTemplateSelectionStep:!0,hasSetupGenerator:Boolean(S)}),y={...a,open:!0,isSaving:!1,currentStepIndex:(0,Q().aO)(a,f),version:_,relationInfos:g??[],setupGenerator:a.setupGenerator??X({environment:t,template:q().globalWorkflowTemplates.fromIdOfType({templateId:i().MH,type:"collection"}),parentStore:a.parentStore,initialAiPrompt:[[""]],analyticsArgs:{origin:a.origin,workflowTemplatesFlowId:a.flowId,hadSelectionModalSearchEntered:!1,...a.dataSourceAnalytics}}),isFollowUpInputFocused:!1,...(0,Q().C8)({collectionTemplate:e,origin:p,flowId:u,parentStore:s,dataSourceAnalytics:m,existingCollectionInfo:a.existingCollectionInfo}),parentStore:a.parentStore};null!==(r=e.value.onboarding)&&void 0!==r&&r.isMinimal?ne({environment:t,modalState:y}):("suggested_template"===o.type&&(0,R().os)({environment:t,eventProperties:{from_modal_template_picker:!0,selected_index:o.allOrderedTemplateIds.indexOf(e.templateId),collection_template_ids_shown:o.allOrderedTemplateIds,...(0,Q().gM)({origin:p,parentStore:s,collectionTemplatesSearchQuery:a.collectionTemplatesSearchQuery,flowId:u,collectionTemplate:e,dataSourceAnalytics:a.dataSourceAnalytics})}}),H().default.setState(y))}function ee(e){const t=H().default.state;if(!t.open||!t.collectionTemplate||!t.parentStore)return;let o={...t,...(0,Q().C8)({collectionTemplate:e,origin:t.origin,flowId:t.flowId,parentStore:t.parentStore,dataSourceAnalytics:t.dataSourceAnalytics,existingCollectionInfo:t.existingCollectionInfo}),parentStore:t.parentStore,isSaving:!1};if(t.collectionTemplate.templateId===e.templateId){var n;const e=o.userCustomizations.featureTemplateSelections,r=t.userCustomizations.featureTemplateSelections,i=e.map((e=>{const t=r.find((t=>t.template.templateId===e.template.templateId));return"required"!==e.optionality&&t?{...e,selected:t.selected}:e}));o={...o,userCustomizations:{...o.userCustomizations,featureTemplateSelections:i,prevFeatureTemplateSelections:e},previewCollectionInfo:{collectionViewBlockStore:void 0,collectionContextStore:void 0,examplePageStores:void 0,focusViewTemplateId:null===(n=t.previewCollectionInfo)||void 0===n||null===(n=n.collectionContextStore)||void 0===n||null===(n=n.collectionViewStore())||void 0===n||null===(n=n.getFormat().workflow_template_instance)||void 0===n?void 0:n.template_id}}}H().default.setState(o)}function te({environment:e,template:t,parentStore:o,existingCollectionInfo:n,relationInfos:r}){_().createAndCommit({userAction:"workflowTemplates.createMinimalCollectionTemplate",environment:e,canUndo:!0,perform:i=>{(0,U().mm)({environment:e,transaction:i,template:t,parentStore:o,existingCollectionInfo:n,inMemoryRecordCache:o.inMemoryRecordCache,relationInfos:r,logger:new(q().WorkflowTemplateLogger)})}})}function oe({environment:e,modalState:t,collectionViewBlockStore:o,collectionStore:r,examplePageStores:i}){var a;if(!r)return;(0,W().xN)({environment:e,collectionStore:r});const{existingCollectionInfo:s,userCustomizations:c,navigateToOnFinish:l}=t,d=(0,Q().gM)(t);!function({environment:e,eventProperties:t,collectionViewBlockStore:o,examplePageStores:r,navigateTo:i,result:a}){if("created_collection"===i)g().uK({environment:e,store:o,visitType:T().ig.Link,pageVisitSource:n().y8.WorkflowTemplateOnboarding,redirect:!0,callback:()=>{D().yQ({examplePageStores:r,collectionViewBlockStore:o,eventProperties:t})}});else if("skip"===i){var s;null!==(s=o.getModel())&&void 0!==s&&s.isFullPageCollectionView()&&D().yQ({examplePageStores:r,collectionViewBlockStore:o,eventProperties:t})}else(0,m().HB)(i);const c=o.getSpaceId();c&&y().wN(e,c,o.id);const l=H().default.getState();!l.open&&l.isShowingLoadingState&&v().V();H().default.close(a)}({environment:e,eventProperties:d,collectionViewBlockStore:o,examplePageStores:i,navigateTo:l,result:{type:"accepted_template",blockId:o.id,collectionId:r.id}}),(0,R().g2)({environment:e,modalState:t,eventProperties:{record_titles_is_empty:c.recordTitles.map((e=>0===e.length)),selected_feature_template_ids:c.featureTemplateSelections.filter((e=>"required"!==e.optionality&&e.selected)).map((e=>e.template.templateId)),step:(0,Q().hq)(t),target_page_ids:[o.id],collection_ids:[r.id],example_page_ids:i.map((e=>e.id)),existing_block_id:null==s||null===(a=s.collectionViewBlockStore)||void 0===a?void 0:a.id,...d}})}function ne({environment:e,modalState:t}){if(!t.collectionTemplate||t.isSaving||!t.parentStore)return;const{collectionTemplate:o,parentStore:n,existingCollectionInfo:r,relationInfos:i,userCustomizations:a}=t;H().default.setState({...t,isSaving:!0});const{performResult:s}=_().createAndCommit({userAction:"WorkflowTemplatesOnboardingModal.getStarted",environment:e,canUndo:!0,perform:t=>{const{collectionStore:s,collectionViewStore:c,collectionViewBlockStore:l,examplePageStores:d}=(0,U().mm)({environment:e,transaction:t,template:o,parentStore:n,existingCollectionInfo:r,inMemoryRecordCache:n.inMemoryRecordCache,selectedFeatureTemplateIds:(0,q().getSelectedFeatureTemplateIds)(a),relationInfos:i,logger:new(q().WorkflowTemplateLogger)});return function({environment:e,transaction:t,collectionStore:o,collectionViewStore:n,collectionViewBlockStore:r,recordTitles:i}){const a=new(I().B)(e);a.setContext({type:"collectionView",collectionViewBlockStore:r,collectionStore:o,collectionViewStore:n,pageVisitSourceOverride:void 0});const s=i.filter((e=>e.length>0));for(const c of s)re({environment:e,transaction:t,collectionContextStore:a,title:c})}({environment:e,transaction:t,collectionStore:s,collectionViewStore:c,collectionViewBlockStore:l,recordTitles:a.recordTitles}),{collectionViewBlockStore:l,collectionStore:s,examplePageStores:d}}});return oe({environment:e,modalState:t,collectionViewBlockStore:s.collectionViewBlockStore,collectionStore:s.collectionStore,examplePageStores:s.examplePageStores}),s}function re({environment:e,transaction:t,collectionContextStore:o,title:n}){const{newStore:r}=(0,w().Q)({environment:e,collectionContextStore:o,groupsPointer:[],insertAtIndex:0,shouldCoerce:!0,templateStore:o.defaultPageTemplateStore.state,transaction:t,from:{createBlock:"workflow_template"},inMemoryRecordCache:e.defaultRecordCache.inMemoryRecordCache});return(0,b().L)({environment:e,store:r,properties:{title:(0,l().x9d)(n)},transaction:t}),r}const ie={assigneeProperty:"notion://tasks/assign_property",statusProperty:"notion://tasks/status_property",dueDateProperty:"notion://tasks/due_date_property"};function ae({environment:e,transaction:t,collectionStore:o,collectionViewBlockStore:n}){const i=r().dC,a=r().d0,s=(0,z().Sl)({environment:e,collectionStore:o}),l={};for(const[r,c]of Object.entries(ie)){const e=s.find((e=>e.templateId.includes(r)));if(!e)return;l[c]=e.instancePointer.id}f().zA({stores:[o],update:{app_config_uri:i,app_uri_map:l},transaction:t}),f().zA({stores:[n],update:{app_id:c().JW(),app_config_uri:a,app_uri_map:{[i]:o.id,[a]:n.id}},transaction:t})}function se({template:e,environment:t}){const o=H().default.state;o.open&&o.collectionTemplate&&H().default.setState({...o,userCustomizations:(0,Q().Ll)({userCustomizations:o.userCustomizations,templateId:e.templateId})})}function ce({environment:e,transaction:t,parentStore:o,collectionTemplate:n,spaceViewStore:r}){const i=h().Wv({environment:e,type:s().xd.collectionViewPage,spaceId:o.getSpaceId(),format:{collection_view_sub_type:"workflow_template_placeholder",placeholder_workflow_template_id:n.templateId,page_icon:n.value.targetCollection.icon},properties:{title:(0,l().x9d)(n.value.targetCollection.name)},inMemoryRecordCache:o.inMemoryRecordCache,transaction:t});h().zv({store:i,data:{parent_id:o.id,parent_table:o.table,alive:!0,view_ids:[]},transaction:t});const a=B().B.createChildStore(o,i.pointer);(0,U().Ls)({environment:e,parentStore:o,collectionViewBlockStore:a,transaction:t,appendOrPrepend:"append",spaceViewStore:r});const c=o.getSpaceId();return c&&((0,R().HD)({environment:e,eventProperties:{placeholder_workflow_template_id:n.templateId,collection_view_block_id:a.id}}),y().Fu(e,t,c,a.id)),a}function le({environment:e,collectionTemplate:t,collectionViewBlockStore:o}){const r=o.getParentStore(),i=r&&(0,L().u)(r)?r:o;if(e.device.isMobile)return te({environment:e,template:t,parentStore:i,existingCollectionInfo:{collectionViewBlockStore:o,collectionStore:void 0,collectionViewStore:void 0},relationInfos:[]}),g().uK({environment:e,store:o,visitType:T().ig.Link,pageVisitSource:n().y8.WorkflowTemplateOnboarding}),{didOpenOnboardingModal:!1};const a="placeholder_block",s={collectionViewBlockStore:o,collectionStore:void 0,collectionViewStore:void 0},c=(0,Q().gM)((0,Q().C8)({collectionTemplate:t,origin:a,flowId:void 0,parentStore:i,dataSourceAnalytics:void 0,existingCollectionInfo:s}));return(0,R().os)({environment:e,eventProperties:{...c,from_modal_template_picker:!1,selected_index:0,collection_template_ids_shown:[t.templateId]}}),J({environment:e,template:t,origin:a,parentStore:i,aiPrompt:void 0,flowId:c.flow_id,existingCollectionInfo:s}),{didOpenOnboardingModal:!0}}function de(e){const t=H().default.state;if(!t.open)return;const o=t.setupGenerator;o&&(o.discardLatestSetup(),void 0===o.store.state.setup&&ue(e))}function pe(e){const t=H().default.state;t.open&&H().default.setState({...t,isFollowUpInputFocused:e})}function ue(e){const t=H().default.state;if(!t.open)return;const o=(0,Q().Wm)(t),n=(0,Q().gP)(t,e),r=o[n];if(n>=0){var a,s;if("setupGeneratorInput"===r||"templateSelection"===r)null==t||null===(a=t.setupGenerator)||void 0===a||a.discardAllSetups(),null==t||null===(s=t.setupGenerator)||void 0===s||s.stopGenerating();const e={...t,isFollowUpInputFocused:!1,currentStepIndex:n};"templateSelection"===r&&(e.collectionTemplate=i().XK,"land_on_app_from_new_user_onboarding"===t.origin&&(e.version="new_user_template_onboarding")),H().default.setState(e)}}function me(e){const t=H().default.state;if(!t.open)return;const o=(0,Q().aO)(t,e);o>=0&&H().default.setState({...t,isFollowUpInputFocused:!1,currentStepIndex:o})}},324587:(e,t,o)=>{o.r(t),o.d(t,{addAutomationAction:()=>L,clearInvalidVariables:()=>H,createAutomation:()=>W,deleteAutomation:()=>Y,disableAutomation:()=>J,duplicateAutomation:()=>G,duplicateAutomationAction:()=>z,enableAutomation:()=>X,insertEmptyTextInDuplicateBlockAction:()=>Z,messages:()=>U,removeAutomationAction:()=>Q,reorderAutomationActions:()=>$,restartAutomation:()=>q});o(16280),o(517642),o(658004),o(733853),o(845876),o(432475),o(515024),o(731698),o(898992),o(354520),o(672577),o(803949),o(581454);var n=o.n(o(794148)),r=()=>o(906745),i=()=>o(564884),a=()=>o(726637),s=()=>o(908006),c=()=>o(422540),l=()=>o(890409),d=()=>o(192845),p=()=>o(390527),u=()=>o(522328),m=()=>o(433519),f=()=>o(247331),v=()=>o(134025),h=()=>o(696706),g=()=>o(912720),S=()=>o(199378),_=()=>o(161479),y=()=>o(201980),w=()=>o(496603),I=()=>o(183558),b=()=>o(973647),T=()=>o(534177),k=()=>o(722101),C=()=>o(44729),A=()=>o(384944),M=()=>o(903864),P=()=>o(231297),x=()=>o(479788),R=()=>o(213477),N=()=>o(909470),E=()=>o(594794),V=()=>o(695625),O=()=>o(546461),F=()=>o(252463),B=()=>o(770586),D=()=>o(190019);const U=(0,o(69708).YK)({genericErrorMessage:{id:"automations.buttonTrigger.genericErrorMessage",defaultMessage:"Button failed to execute"},open:{defaultMessage:"Open",id:"automations.buttonTrigger.open"},undo:{defaultMessage:"Undo",id:"automations.buttonTrigger.undo"},defaultConfirmationWorkflowText:{defaultMessage:"Are you sure you want to continue?",id:"automations.buttonTrigger.defaultConfirmationWorkflowText"},defaultContinueWorkflowMessage:{defaultMessage:"Continue",id:"automations.buttonTrigger.defaultContinueWorkflowMessage"},defaultStopWorkflowMessage:{defaultMessage:"Cancel",id:"automations.buttonTrigger.defaultStopWorkflowMessage"},errorQueryCollectionTooManyPages:{defaultMessage:"Button impacts too many pages",id:"automations.buttonTrigger.errorQueryCollectionTooManyPages"},errorRecordInTrash:{id:"automations.buttonTrigger.errorRecordInTrash",defaultMessage:"Button is editing a page in trash"}});function W(e){const{actionIds:t,automationId:o,automationName:r,environment:i,inMemoryRecordCache:a,parentPointer:s,transaction:c,trigger:l}=e,d=o??(0,E().Z1)({environment:i,table:g().yB,spaceId:s.spaceId}),p=A().eC({environment:i,inMemoryRecordCache:a??i.defaultRecordCache.inMemoryRecordCache,table:g().yB,transaction:c,value:{action_ids:t,alive:!0,id:d,parent_id:s.id,parent_table:s.table,properties:{name:r},space_id:s.spaceId,status:"active",trigger:l}});return n()(p.isTriggerType(l.type),"Trigger type mismatch"),p}function L(e){const{actionId:t,environment:o,intl:r,automationStore:i,actionType:a,transaction:c,insertionPoint:d,config:p,createDuplicateBlocksContainer:u=!0,builderType:m="sidebar"}=e,f=i.getSpaceId();if(!f)return;let v;if("duplicate_blocks"===a&&u){v=A().Wv({environment:o,inMemoryRecordCache:i.inMemoryRecordCache,transaction:c,type:"text"});const e=Z({environment:o,contentStore:v.getContentStore(),transaction:c});s().default.afterNextFlush((()=>{const t=V().T.find((t=>h().L3.isEqual(t.props.store.pointer,e.pointer)));t&&(0,M().e)({store:t.props.store.getBlockTitleStore()})}))}const _=p??function(e){const{actionType:t,automationStore:o,intl:n}=e;if("modal_confirmation"===t)return{continue_button:{text:n.formatMessage(U.defaultContinueWorkflowMessage)},cancel_button:{text:n.formatMessage(U.defaultStopWorkflowMessage)},text:{type:"simple",value:(0,y().x9d)(n.formatMessage(U.defaultConfirmationWorkflowText))}};if("define_variables"===t){const e=(0,I().Ay)();return{values:{[e]:{name:(0,B().v)(o.getActionStores(),n.formatMessage(S().xC)),value:{type:"simple",value:[[""]]}}},variableIds:[e]}}}({actionType:a,automationStore:i,intl:r})??{},w=A().eC({environment:o,inMemoryRecordCache:i.inMemoryRecordCache,table:S().SC,transaction:c,value:{id:t,type:a,parent_id:i.id,parent_table:g().yB,alive:!0,space_id:f,config:_,blocks:v?[v.id]:[]}});return v&&k().BC({transaction:c,parentStore:w.getKeyStore("blocks"),appendStore:v}),!d||"afterActionId"in d?k().BC({transaction:c,parentStore:i.getActionIdsStore(),appendStore:w,after:null==d?void 0:d.afterActionId}):"beforeActionId"in d?k().Hs({transaction:c,parentStore:i.getActionIdsStore(),prependStore:w,before:d.beforeActionId}):(0,T().HB)(d),K({transaction:c,automationStore:i}),(0,F().CM)(((e,t,n)=>{const r=(0,x().Q)(o),a=(0,F().zc)({automationActionStore:w,formulaAnalyticsModule:t,formulasModule:e,simpleFormulasModule:n});(0,T().O9)(a)&&(0,l().dW)(r,{automation_action:a,automation_action_id:w.id,automation_id:w.getParentId(),builder_type:m}),w.isDefined()&&(0,l().c_)(r,{automation_action_id:w.id,automation_action_type:w.getType(),automation_id:i.id,builder_type:m})})),n()(w.isType(a),"Action type mismatch"),w}function q(e){var t,o;const{automationStore:n,transaction:i}=e,a=n.getRecurrence();if(!a)return;const s=r().c9.now().plus({day:1}).startOf("day"),c={...a,start_date:s.toMillis(),end_condition:"date"===(null===(t=a.end_condition)||void 0===t?void 0:t.type)?{type:"date",end_at:(0,p().getNewEndTimestamp)(s,a.start_date,null===(o=a.end_condition)||void 0===o?void 0:o.end_at).toMillis()}:a.end_condition};A().zv({store:n,transaction:i,data:{status:"active"}}),A().zv({store:n.getKeyStore("trigger"),transaction:i,data:{recurrence:(0,p().convertFromUnpersistedRecurrenceConfig)(c)}})}function G(e){const{actorPointer:t,environment:o,includeParenting:n,sourceAutomationStore:r,targetAutomationId:i,transaction:a}=e,s=r.getParentStore();if(!s||!s.isReady())throw new Error("Automation parent store not ready");const c=r.getValue(),l=r.getSpaceId();if(!(0,T().O9)(c)||!(0,T().O9)(l))throw new Error("Undefined automation value or space id");const d={},p={...(0,w().mg)(c),id:i??(0,E().Z1)({environment:o,table:g().yB,spaceId:(0,_().e)(l)})};d[r.id]=p.id,(0,T().O9)(p.action_ids)&&(0,T().EI)(p.action_ids)&&p.action_ids.forEach((e=>d[e]=(0,E().Z1)({environment:o,table:S().SC,spaceId:(0,_().e)(l)})));const u=({requested:e})=>{const t=d[e.id];return(0,T().O9)(t)?{...e,id:t}:e};(0,m().i)({actor:t,duplicateRecord:p,options:{},mapper:u,originalRecord:c});const f=A().eC({environment:o,inMemoryRecordCache:r.inMemoryRecordCache,table:g().yB,transaction:a,value:p});n&&C().NI({childStore:f,parentStore:s,transaction:a});const v=r.getActionStores(),h=Promise.all(v.map((e=>{const t=d[e.id],{automationActionStore:n,onComplete:r}=z({environment:o,includeParenting:!1,mapper:u,sourceActionStore:e,targetAutomationActionId:t,transaction:a});return C().NI({childStore:n,parentStore:f,transaction:a}),r})));return{automationStore:f,onComplete:h.then((()=>{}))}}function z(e){const{environment:t,includeParenting:o,insertionPoint:n,mapper:r,sourceActionStore:i,targetAutomationActionId:s,transaction:c}=e,d=i.getParentStore();if(!d||!d.isReady())throw new Error("Automation store is not ready");const p=i.getValue(),m=i.getSpaceId();if(!(0,T().O9)(p)||!(0,T().O9)(m))throw new Error("Undefined action value or space id");const f={...(0,w().mg)(p),id:s??(0,E().Z1)({environment:t,table:S().SC,spaceId:(0,_().e)(m)})},v=t.currentUser.id,h=i.inMemoryRecordCache.makeGetRecordRoleFn(v);(0,u().I)({duplicateRecord:f,getRecordRole:h,originalRecord:p,mapper:e=>(null==r?void 0:r(e))??e.requested,options:{},originOptions:{baseUrl:a().A.domainBaseUrl,publicDomainName:a().A.publicDomainName},duplicateBlocks:!1});const g=A().eC({environment:t,inMemoryRecordCache:i.inMemoryRecordCache,table:S().SC,transaction:c,value:f});o&&(!n||"afterActionId"in n?C().NI({after:null==n?void 0:n.afterActionId,childStore:g,parentStore:d,transaction:c}):"beforeActionId"in n?C().Ti({before:null==n?void 0:n.beforeActionId,childStore:g,parentStore:d,transaction:c}):(0,T().HB)(n),K({transaction:c,automationStore:d}));const y=i.getBlockStores(),I=y.length>0?(0,R().hh)({environment:t,sourceBlocks:y,destination:{type:"automation_action",parent:g.pointer},from:"duplicate_automation_action",skipUserFacingMessages:!0,options:{addCopyName:!1,allowRedundancy:!0,deepCopyTransclusionContainers:!1,resolveTemplateVariables:!1},useDuplicateSubtreeFlow:!0}):Promise.resolve(),b=g.getModel();return(0,T().O9)(b)&&(0,F().CM)(((e,o,n)=>{const r=(0,x().Q)(t),i=(0,F().zc)({automationActionStore:g,formulaAnalyticsModule:o,formulasModule:e,simpleFormulasModule:n});(0,T().O9)(i)&&(0,l().dW)(r,{automation_action:i,automation_action_id:b.id,automation_id:b.parent_id,from:"duplicate"}),(0,l().c_)(r,{automation_action_id:b.id,automation_action_type:b.type,automation_id:d.id,from:"duplicate"})})),{automationActionStore:g,onComplete:I.then((()=>{}))}}function $(e){const{automationStore:t,automationTypecheckModule:o,contextType:n,environment:r,formulasModule:a,from:s,intl:c,isSubscribed:l,movedActionId:d,newActionIds:p,transaction:u,pageStore:m}=e;A().zv({store:t,transaction:u,data:{action_ids:p}}),K({automationStore:t,transaction:u});j({automationStore:t,transaction:u,typecheckResult:(0,D().Z)({environment:r,automationStore:t,automationTypecheckModule:o,contextType:n,formulasModule:a,intl:c,isSubscribed:l,pageStore:m})}),(0,i().u)({environment:r,event:{eventName:"automation_action_move",eventProperties:{automation_id:t.id,automation_action_id:d,from:s}}})}function Q(e){const{actionStore:t,automationStore:o,automationTypecheckModule:n,contextType:r,environment:i,formulasModule:a,intl:s,isSubscribed:c,transaction:d,pageStore:p}=e,u=(0,D().Z)({environment:i,automationStore:o,automationTypecheckModule:n,contextType:r,formulasModule:a,intl:s,isSubscribed:c,pageStore:p});!function(e){const{automationActionStore:t,automationStore:o,environment:n,transaction:r,hasError:i=!1}=e;let a=t.getParentStore();if((0,T().O9)(o)){const e=t.getParentPointer();if(!(0,T().O9)(e))throw new Error("Automation action does not have a parent pointer");if(!h().L3.isEqual(e,o.pointer))throw new Error(`Automation action parent pointer does not match argument: ${h().L3.toKey(e)}, ${h().L3.toKey(o.pointer)}`);a=o}else if(!(0,T().O9)(a))throw new Error("Automation store is undefined");C().zz({childStore:t,parentStore:a,transaction:r});const s=t.getModel();(0,T().O9)(s)&&(0,F().CM)(((e,o,r)=>{const c=(0,x().Q)(n),d=(0,F().zc)({automationActionStore:t,formulaAnalyticsModule:o,formulasModule:e,simpleFormulasModule:r});(0,T().O9)(d)&&(0,l().YO)(c,{automation_action:d,automation_action_id:s.id,automation_id:s.parent_id,has_error:i}),(0,l().gW)(c,{automation_action_id:s.id,automation_action_type:s.type,automation_id:a.id,has_error:i})}))}({automationActionStore:t,environment:i,transaction:d,hasError:(b().Q.isSuccess(u)&&u.value.actionValidationFailures[t.id]||[]).length>0}),j({automationStore:o,transaction:d,typecheckResult:u})}function H(e){const{environment:t,automationStore:o,automationTypecheckModule:n,contextType:r,formulasModule:i,intl:a,isSubscribed:s,transaction:c,pageStore:l}=e;j({automationStore:o,transaction:c,typecheckResult:(0,D().Z)({environment:t,automationStore:o,automationTypecheckModule:n,contextType:r,formulasModule:i,intl:a,isSubscribed:s,pageStore:l})})}function K(e){const{automationStore:t,transaction:o}=e;t.getSpaceId()&&t.getActionStores().forEach(((e,t)=>{var n;if(!e.isDefined())return;const r=e.getModel();r.isType("open_page")&&"url"===(null===(n=r.getConfig())||void 0===n||null===(n=n.target)||void 0===n?void 0:n.type)&&!(0,c().cQ)(t)&&A().zv({store:e.getConfigStore(),transaction:o,data:{target:null}})}))}function j(e){const{automationStore:t,transaction:o,typecheckResult:n}=e,r=t.getSpaceId(),i=t.getModel();if(r&&i&&!b().Q.isFail(n))for(const s of i.getActionIds()){const e=t.getRecordStore(t,{table:S().SC,id:s,spaceId:r});if(!e.isDefined())continue;const i=e.getModel(),c=new Set(n.value.actionInputValueTypes[s].map((e=>{if(e.kind===f().FormulaContextValueKind.Binding||e.kind===f().FormulaContextValueKind.ContextValue)return e.id;e.kind===f().FormulaContextValueKind.ThisRow||(0,T().HB)(e)})).filter(T().O9)),{value:l}=(0,d().G)({automationActionModel:i,baseUrl:a().A.domainBaseUrl,preventClearingConfig:!0,publicDomainName:a().A.publicDomainName,sourceSpaceId:r,visitors:{visitCollectionProperty:void 0,visitCollectionPropertyPointer:void 0,visitFormulaContextValue:e=>c.has(e)?{type:"keep"}:{type:"replace",value:void 0},visitFormulaPageProperty:void 0,visitRecordPointer:void 0}}),p=v().op.update({pointer:e.pointer,path:["config"],args:l.getConfig()??{}});P().applyOperation({store:e,operation:p,transaction:o})}}function Z(e){const{environment:t,contentStore:o,transaction:n}=e,r=A().Wv({environment:t,type:"text",inMemoryRecordCache:o.inMemoryRecordCache,transaction:n,spaceId:o.pointer.spaceId});return k().BC({parentStore:o,appendStore:r,transaction:n}).childStore}function X(e){const{automationStore:t,environment:o,transaction:n}=e;A().zv({store:t,data:{status:"active"},transaction:n});const r=t.getModel();(0,T().O9)(r)&&(0,F().CM)(((e,n,i)=>{const a=(0,O().To)(t);let s=[];a&&b().Q.isSuccess(a)&&(s=a.value.valueTypes);const c=(0,x().Q)(o),d=(0,l().sp)({automationModel:r,formulaAnalyticsModule:n,formulasModule:e,formulaTypecheckContextValues:s,getRecordModel:t.getRecordModel,featureGates:(0,N().i)(),simpleFormulasModule:i});(0,l().Ah)(c,d)}))}function J(e){const{automationStore:t,environment:o,status:n,transaction:r}=e,i=n??"disabled";A().zv({store:t,data:{status:i},transaction:r}),t.isTriggerType("recurrence")&&A().zv({store:t,data:{run_at:void 0},transaction:r});const a=t.getModel();(0,T().O9)(a)&&(0,F().CM)(((e,n,r)=>{const i=(0,O().To)(t);let s=[];i&&b().Q.isSuccess(i)&&(s=i.value.valueTypes);const c=(0,x().Q)(o),d=(0,l().sp)({automationModel:a,formulaAnalyticsModule:n,formulasModule:e,formulaTypecheckContextValues:s,getRecordModel:t.getRecordModel,featureGates:(0,N().i)(),simpleFormulasModule:r});(0,l().vN)(c,d)}))}function Y(e){const{automationStore:t,environment:o,transaction:n}=e;A().zv({store:t,data:{alive:!1},transaction:n});const r=t.getModel();(0,T().O9)(r)&&(0,F().CM)(((e,n,i)=>{const a=(0,O().To)(t);let s=[];a&&b().Q.isSuccess(a)&&(s=a.value.valueTypes);const c=(0,x().Q)(o),d=(0,l().sp)({automationModel:r,formulaAnalyticsModule:n,formulasModule:e,formulaTypecheckContextValues:s,getRecordModel:t.getRecordModel,featureGates:(0,N().i)(),simpleFormulasModule:i});(0,l().Iv)(c,d)}))}},348869:(e,t,o)=>{o.d(t,{g:()=>s});o(944114);var n=()=>o(386164),r=()=>o(532659),i=()=>o(559506),a=()=>o(901389);async function s(e){const{environment:t,onResponse:o,data:s,userId:c,tracking:l,abortSignal:d}=e,p=await i().callStreamApi({eventName:"runInferenceTranscript",environment:t,data:s,userId:c,tracking:l,abortSignal:d,headers:(0,n().WS)({spaceId:s.spaceId})});if("success"!==p.type)return null!=d&&d.aborted?{error:{message:"Aborted",code:0}}:(a().Qg(p),{error:{message:p.error.message,code:p.status}});const u=[];if(r().hS.is(p.data))for await(const n of p.data){if("error"===n.type)return{error:{message:n.message,code:n.errorCode}};null==o||o(n),u.push(n)}return{value:u}}},349379:(e,t,o)=>{o.d(t,{DF:()=>p,HD:()=>s,If:()=>d,Vd:()=>l,g2:()=>c,os:()=>a});var n=()=>o(564884),r=()=>o(242422),i=()=>o(116225);function a({environment:e,eventProperties:t}){const o="suggested_collection_template_clicked";(0,n().u)({environment:e,event:{eventName:o,eventProperties:t}}),r().default.logEvent(o,t.collection_template_id,t)}function s({environment:e,eventProperties:t}){(0,n().u)({environment:e,event:{eventName:"workflow_template_onboarding_placeholder_created",eventProperties:t}})}function c({environment:e,eventProperties:t,modalState:o}){const a="workflow_template_onboarding_done";var s;((0,n().u)({environment:e,event:{eventName:a,eventProperties:t}}),r().default.logEvent(a,t.collection_template_id,t),i().u4({name:"collection_created_from_workflow_template",args:{template_id:t.collection_template_id??"",origin:t.origin,experiment_group:"personalized"}}),o.collectionTemplate.isAiGenerated)&&(null===(s=o.setupGenerator)||void 0===s||s.trackSessionEnded({reason:"instantiated"}))}function l({environment:e,eventProperties:t}){const o="setup_generator_session_started";(0,n().u)({environment:e,event:{eventName:o,eventProperties:t}}),r().default.logEvent(o,void 0,t)}function d({environment:e,eventProperties:t}){const o="setup_generator_generated_setup";(0,n().u)({environment:e,event:{eventName:o,eventProperties:t}}),r().default.logEvent(o,void 0,t)}function p({environment:e,eventProperties:t}){const o="template_picker_opened";(0,n().u)({environment:e,event:{eventName:o,eventProperties:t}}),r().default.logEvent(o,t.origin,t)}},354785:(e,t,o)=>{o.d(t,{Bg:()=>a,MU:()=>v,Rk:()=>l,Yh:()=>r,ay:()=>i,g$:()=>s,hK:()=>d,nM:()=>p,q0:()=>m,tK:()=>f,uH:()=>c,zJ:()=>u});o(898992),o(354520);var n=()=>o(564884);function r(e){return e.filter((e=>"researcher-agent"===e.type)).length}function i(e){return e.filter((e=>"researcher-next-steps"===e.type)).length}function a(e){const{environment:t,threadId:o,traceId:r,isFollowUp:i,searchSources:a,searchScopeType:s}=e;(0,n().u)({environment:t,event:{eventName:"research_mode_start_turn",eventProperties:{thread_id:o,trace_id:r,is_follow_up:i,search_sources:a,search_scope_type:s}}})}function s(e){const{environment:t,threadId:o,traceId:r,isFollowUp:i,isError:a,numSearchResults:s,numCitationsShown:c,resultsBySource:l,citationsBySource:d,stepsGenerated:p,planningRounds:u,searchSources:m,searchScopeType:f}=e;(0,n().u)({environment:t,event:{eventName:"research_mode_end_turn",eventProperties:{thread_id:o,trace_id:r,is_follow_up:i,is_error:a,num_search_results:s,num_citations_shown:c,results_by_source:l,citations_by_source:d,steps_generated:p,planning_rounds:u,search_sources:m,search_scope_type:f}}})}function c(e){(0,n().u)({environment:e.environment,event:{eventName:"research_mode_start",eventProperties:{query_length:e.queryLength,query_words:e.queryWords,search_session_id:e.searchSessionId,qna_session_id:e.qnaSessionId,research_mode_thread_id:e.researchModeThreadId,source:e.source,source_event_id:e.sourceEventId,suggested_query:e.suggestedQuery,attachment_count:e.attachmentCount??0}}})}function l(e){(0,n().u)({environment:e.environment,event:{eventName:"research_mode_step_expanded",eventProperties:{research_mode_thread_id:e.researchModeThreadId}}})}function d(e){(0,n().u)({environment:e.environment,event:{eventName:"research_mode_step_collapsed",eventProperties:{research_mode_thread_id:e.researchModeThreadId}}})}function p(e){(0,n().u)({environment:e.environment,event:{eventName:"research_mode_report_first_char_rendered",eventProperties:{research_mode_thread_id:e.researchModeThreadId}}})}function u(e){(0,n().u)({environment:e.environment,event:{eventName:"research_mode_report_last_char_rendered",eventProperties:{research_mode_thread_id:e.researchModeThreadId}}})}function m(e){(0,n().u)({environment:e.environment,event:{eventName:"research_mode_report_copied",eventProperties:{research_mode_thread_id:e.researchModeThreadId}}})}function f(e){(0,n().u)({environment:e.environment,event:{eventName:"research_mode_report_saved_to_page",eventProperties:{research_mode_thread_id:e.researchModeThreadId}}})}function v(e){(0,n().u)({environment:e.environment,event:{eventName:"research_mode_report_visited",eventProperties:{research_mode_thread_id:e.researchModeThreadId,source:e.source}}})}},458097:(e,t,o)=>{o.r(t),o.d(t,{default:()=>i});class n extends(()=>o(757695))().Store{getInitialState(){return{open:!1,isShowingLoadingState:!1}}updateUserCustomizations(e,t){this.state.open&&this.state.collectionTemplate&&this.setState({...this.state,userCustomizations:{...this.state.userCustomizations,[e]:t}})}updateCollectionTemplate(e){this.state.open&&this.state.collectionTemplate&&this.setState({...this.state,collectionTemplate:e})}updatePreviewFocusViewTemplateId(e){this.state.open&&this.state.collectionTemplate&&this.state.previewCollectionInfo&&this.state.previewCollectionInfo.focusViewTemplateId!==e&&this.setState({...this.state,previewCollectionInfo:{...this.state.previewCollectionInfo,focusViewTemplateId:e}})}updatePreviewCollectionContextStore(e){this.state.open&&this.state.collectionTemplate&&this.state.previewCollectionInfo&&this.state.previewCollectionInfo.collectionContextStore!==e&&this.setState({...this.state,previewCollectionInfo:{...this.state.previewCollectionInfo,collectionContextStore:e}})}getPreviewCollectionContextStore(){if(this.state.open&&this.state.collectionTemplate&&this.state.previewCollectionInfo)return this.state.previewCollectionInfo.collectionContextStore}getParentStore(){return this.state.open?this.state.parentStore:void 0}getShouldShowExpandedTemplateList(){return this.state.open&&this.state.shouldShowExpandedTemplateList}setShouldShowExpandedTemplateList(e){this.state.open&&this.setState({...this.state,shouldShowExpandedTemplateList:e})}close(e){var t,o;this.state.open&&(null===(t=(o=this.state).onClose)||void 0===t||t.call(o,e),this.setState({open:!1,isShowingLoadingState:!1}))}reset(){this.setState(this.getInitialState())}}const r=new n;(0,o(852832).exposeDebugValue)("InitializeWorkflowTemplateModalStore",r);const i=r},484127:(e,t,o)=>{o.d(t,{Mi:()=>c,W6:()=>p,ut:()=>d,y5:()=>s,ye:()=>u});o(944114),o(517642),o(658004),o(733853),o(845876),o(432475),o(515024),o(731698),o(898992),o(354520),o(672577),o(581454),o(908872),o(737550);var n=()=>o(832443),r=()=>o(252050),i=()=>o(412412);function a(e){const t=[],o=e.matchAll(/\[(step-[^\[\]]*?),(artifact|claim),(\d+)\]/g);for(const n of o){const[,e,o,r]=n;"claim"!==o&&"artifact"!==o||t.push({planKey:e,citationType:o,resourceId:r})}return t}function s(e){let t=1;return e.replace(/\[(step-[^\[\]]*?),(artifact|claim),(\d+)\]/g,((e,o,n,r)=>{const i=encodeURIComponent(o),a=encodeURIComponent(n),s=encodeURIComponent(r),c=encodeURIComponent(",");return`[**[${t++}]**](#citation:${i}${c}${a}${c}${s})`}))}function c(e,t){const o={stepCitations:{...e.stepCitations}};for(const[n,r]of Object.entries(t.stepCitations)){if(!o.stepCitations[n]){o.stepCitations[n]={claims:[...r.claims],artifacts:[...r.artifacts]};continue}const e=new Set(o.stepCitations[n].claims.map((e=>e.id)));for(const i of r.claims)e.has(i.id)||o.stepCitations[n].claims.push(i);const t=new Set(o.stepCitations[n].artifacts.map((e=>e.id)));for(const i of r.artifacts)t.has(i.id)||o.stepCitations[n].artifacts.push(i)}return o}const l={"slack-result":"slack","google-drive-result":"google-drive","helpdoc-result":"helpdoc","github-result":"github","webpage-result":"webpage","jira-result":"jira","microsoft-teams-result":"microsoft-teams","sharepoint-result":"sharepoint"};function d(e,t){const o=[],a=(0,i().BD)(e.value,!1,{parseNoneClosedTags:!0})[0];if("element"!==a.type)return o;for(const c of a.children){if("element"!==c.type)continue;let e;const a=t.mapCounterToKey((0,r().VB)(c.attributes.id));if("element"!==c.type||"page"!==c.tagName&&"block"!==c.tagName){if("element"===c.type&&("slack-result"===c.tagName||"github-result"===c.tagName||"google-drive-result"===c.tagName||"jira-result"===c.tagName||"sharepoint-result"===c.tagName||"microsoft-teams-result"===c.tagName||"webpage"===c.tagName||"helpdoc"===c.tagName)){var s;const t=n().tD.parseAssistantHref(a.key),o="text"===(null===(s=c.children[0])||void 0===s?void 0:s.type)?c.children[0].value:"",r="slack-result"===c.tagName||"microsoft-teams-result"===c.tagName?c.attributes.channel:c.attributes.title;e={citationType:"universal_search",target:l[c.tagName],href:a.key,title:r,text:o,number:Number(c.attributes.id),...t}}}else{const o=t.mapCounterToKey((0,r().VB)(null==c?void 0:c.attributes.id));e={citationType:"notion",pageId:o.key,blockId:"block"===c.tagName?a.key:o.key,number:Number(c.attributes.id)}}o.push({id:c.attributes.id,artifactType:"text",content:(0,i()._o)(c),citationInfo:e})}return o}function p(e){try{const t=[];for(const r in e.stepCitations){const o=e.stepCitations[r];for(const e of o.artifacts||[])e.citationInfo&&t.push(e.citationInfo)}const o=t.length,n={};for(const e of t){if(!e)continue;let t="unknown";"notion"===e.citationType?t="notion":"universal_search"===e.citationType&&(t=e.target||"unknown"),n[t]=(n[t]||0)+1}return{allArtifacts:t,resultsBySource:n,numSearchResults:o}}catch(t){return{allArtifacts:[],resultsBySource:{},numSearchResults:0}}}function u(e,t){try{const l=a(e),d={};for(const e of l){const{planKey:a,citationType:l,resourceId:p}=e;try{var o;if(!a||!l||!p)continue;const e=t.stepCitations[a];if(!e)continue;let c;if("claim"===l){var n,r;const t=null===(n=e.claims)||void 0===n?void 0:n.find((e=>e.id===p));var i;if(null!=t&&null!==(r=t.supportingArtifactIds)&&void 0!==r&&r[0])c=null===(i=e.artifacts)||void 0===i?void 0:i.find((e=>e.id===t.supportingArtifactIds[0]))}else if("artifact"===l){var s;c=null===(s=e.artifacts)||void 0===s?void 0:s.find((e=>e.id===p))}if(null!==(o=c)&&void 0!==o&&o.citationInfo){let e="unknown";"notion"===c.citationInfo.citationType?e="notion":"universal_search"===c.citationInfo.citationType&&(e=c.citationInfo.target||"unknown"),d[e]=(d[e]||0)+1}}catch(c){continue}}return{citationsBySource:d,numCitationsShown:Object.values(d).reduce(((e,t)=>e+t),0)}}catch(c){return{citationsBySource:{},numCitationsShown:0}}}},592933:(e,t,o)=>{o.d(t,{Vf:()=>n,yD:()=>r});o(410838),o(944114),o(898992),o(354520),o(672577),o(803949),o(581454),o(737550);function n(e){return"inference"!==e.type&&"queue-handoff"!==e.type&&"record-map"!==e.type&&"patch-start"!==e.type&&"patch"!==e.type&&"agent-search-extracted-results"!==e.type}function r(e){return"patch"===e.type||"patch-start"===e.type}},597527:(e,t,o)=>{o.r(t),o.d(t,{addSidebarWorkflow:()=>a,moveSidebarWorkflow:()=>c,removeSidebarWorkflow:()=>s});o(898992),o(354520);var n=()=>o(765957),r=()=>o(72234),i=()=>o(231297);function a({environment:e,workflowId:t}){var o;const a=n().default.state.sidebarSpaceViewStore;if(!a)return;const s=(null===(o=a.getSettings())||void 0===o?void 0:o.sidebar_workflow_ids)||[];s.includes(t)||i().createAndCommit({userAction:"sidebarWorkflowsActions.addSidebarWorkflow",environment:e,canUndo:!0,cellTarget:"main",perform:e=>{const o=[t,...s];r().AG(a,e,{...a.getSettings(),sidebar_workflow_ids:o})}})}function s({environment:e,workflowId:t}){var o;const a=n().default.state.sidebarSpaceViewStore;if(!a)return;const s=(null===(o=a.getSettings())||void 0===o?void 0:o.sidebar_workflow_ids)||[],c=s.filter((e=>e!==t));c.length!==s.length&&i().createAndCommit({userAction:"sidebarWorkflowsActions.removeSidebarWorkflow",environment:e,canUndo:!0,cellTarget:"main",perform:e=>{r().AG(a,e,{...a.getSettings(),sidebar_workflow_ids:c})}})}function c({environment:e,workflowId:t,afterWorkflowId:o}){var a;const s=n().default.state.sidebarSpaceViewStore;if(!s)return;const c=(null===(a=s.getSettings())||void 0===a?void 0:a.sidebar_workflow_ids)||[];c.includes(t)&&i().createAndCommit({userAction:"sidebarWorkflowsActions.moveSidebarWorkflow",environment:e,canUndo:!0,cellTarget:"main",perform:e=>{const n=c.filter((e=>e!==t));let i;if(o){const e=n.indexOf(o);i=-1===e?[...n,t]:[...n.slice(0,e+1),t,...n.slice(e+1)]}else i=[t,...n];r().AG(s,e,{...s.getSettings(),sidebar_workflow_ids:i})}})}},616878:(e,t,o)=>{o.d(t,{f:()=>r});o(517642),o(658004),o(733853),o(845876),o(432475),o(515024),o(731698),o(898992),o(354520);class n extends(()=>o(757695))().Store{getInitialState(){return{statuses:[],previousStepIdToIndex:{},threadId:void 0}}updateStatus({threadId:e,index:t,status:o,previousStepId:n}){this.state.threadId!==e&&this.reset();const r=[...this.state.statuses];r[t]=o;const i={...this.state.previousStepIdToIndex};n&&(i[n]=t),this.setState({threadId:e,statuses:r,previousStepIdToIndex:i})}removeStatusesForMessageIds(e){const t=new Set;for(const o of e){const e=this.state.previousStepIdToIndex[o];e&&t.add(e)}if(t.size>0){const e=[...this.state.statuses];for(const o of t)delete e[o];this.setState({...this.state,statuses:e.filter(Boolean)})}}}const r=new n},631611:(e,t,o)=>{o.d(t,{Ui:()=>d,hP:()=>R,jw:()=>N,wy:()=>P});o(16280);var n,r=o(296540),i=o(474848);const a={fullPage:!0,mobileNative:!0,mobileWeb:!0,commandSearch:!0,mobileNativeTab:!0,searchPane:!0,mobileSearch:!1,writer:!1,corner:!1,mobileWriter:!1,workflowEditor:!1,inferenceTranscriptChatView:!1},s={fullPage:!0,mobileNative:!0,mobileWeb:!0,mobileNativeTab:!0,commandSearch:!1,searchPane:!1,mobileSearch:!1,writer:!1,corner:!1,mobileWriter:!1,workflowEditor:!1,inferenceTranscriptChatView:!1},c={mobileNative:!0,mobileWeb:!0,mobileSearch:!0,mobileWriter:!0,mobileNativeTab:!0,fullPage:!1,writer:!1,corner:!1,searchPane:!1,commandSearch:!1,workflowEditor:!1,inferenceTranscriptChatView:!1},l={writer:!0,mobileWriter:!0,mobileWeb:!1,mobileNative:!1,mobileSearch:!1,fullPage:!1,corner:!1,searchPane:!1,commandSearch:!1,workflowEditor:!1,mobileNativeTab:!1,inferenceTranscriptChatView:!1};function d(e){return l[e]}const p={corner:!0,searchPane:!0,fullPage:!1,mobileNative:!1,mobileWeb:!1,mobileSearch:!1,commandSearch:!1,writer:!1,mobileWriter:!1,workflowEditor:!1,mobileNativeTab:!1,inferenceTranscriptChatView:!1},u={corner:!0,searchPane:!0,fullPage:!0,mobileNative:!0,mobileWeb:!0,mobileSearch:!0,commandSearch:!0,mobileNativeTab:!0,writer:!1,mobileWriter:!1,workflowEditor:!1,inferenceTranscriptChatView:!1},m={corner:!0,searchPane:!0,fullPage:!0,mobileNative:!0,mobileNativeTab:!0,commandSearch:!0,mobileWeb:!1,mobileSearch:!1,writer:!1,mobileWriter:!1,workflowEditor:!1,inferenceTranscriptChatView:!0},f={corner:!0,searchPane:!0,fullPage:!0,commandSearch:!0,writer:!0,mobileWriter:!0,workflowEditor:!0,mobileNative:!1,mobileWeb:!1,mobileSearch:!1,mobileNativeTab:!1,inferenceTranscriptChatView:!1},v={corner:!0,searchPane:!0,commandSearch:!0,mobileNative:!0,mobileSearch:!0,mobileWeb:!0,writer:!1,fullPage:!1,mobileWriter:!1,workflowEditor:!1,mobileNativeTab:!1,inferenceTranscriptChatView:!1},h={corner:!0,writer:!0,mobileWriter:!0,fullPage:!1,searchPane:!1,commandSearch:!1,mobileNative:!1,mobileWeb:!1,mobileSearch:!1,workflowEditor:!1,mobileNativeTab:!1,inferenceTranscriptChatView:!1},g={corner:!0,fullPage:!0,searchPane:!0,mobileNative:!0,mobileNativeTab:!0,commandSearch:!0,mobileWeb:!0,mobileSearch:!0,writer:!1,mobileWriter:!1,workflowEditor:!1,inferenceTranscriptChatView:!1},S={corner:!0,fullPage:!0,searchPane:!1,mobileNative:!1,commandSearch:!1,mobileWeb:!1,mobileSearch:!1,writer:!1,mobileWriter:!1,workflowEditor:!1,mobileNativeTab:!1,inferenceTranscriptChatView:!1},_={corner:!0,fullPage:!0,commandSearch:!1,searchPane:!1,mobileNative:!1,mobileWeb:!1,mobileSearch:!1,writer:!1,mobileWriter:!1,workflowEditor:!1,mobileNativeTab:!1,inferenceTranscriptChatView:!1},y={fullPage:!0,writer:!0,corner:!0,commandSearch:!1,searchPane:!1,mobileNative:!1,mobileWeb:!1,mobileSearch:!1,mobileWriter:!1,workflowEditor:!1,mobileNativeTab:!1,inferenceTranscriptChatView:!1},w={corner:!0,fullPage:!1,writer:!1,commandSearch:!1,searchPane:!1,mobileNative:!1,mobileWeb:!1,mobileSearch:!1,mobileWriter:!1,workflowEditor:!1,mobileNativeTab:!1,inferenceTranscriptChatView:!1},I={fullPage:!0,writer:!1,corner:!1,commandSearch:!1,searchPane:!1,mobileNative:!1,mobileWeb:!1,mobileSearch:!1,mobileWriter:!1,workflowEditor:!1,mobileNativeTab:!1,inferenceTranscriptChatView:!1},b={writer:!0,fullPage:!1,corner:!1,commandSearch:!1,searchPane:!1,mobileNative:!1,mobileWeb:!1,mobileSearch:!1,mobileWriter:!1,workflowEditor:!1,mobileNativeTab:!1,inferenceTranscriptChatView:!1},T={corner:!0,fullPage:!1,searchPane:!1,mobileNative:!1,commandSearch:!1,mobileWeb:!1,mobileSearch:!1,writer:!1,mobileWriter:!1,workflowEditor:!1,mobileNativeTab:!1,inferenceTranscriptChatView:!1},k={corner:!0,fullPage:!0,searchPane:!1,mobileNative:!1,commandSearch:!1,mobileWeb:!1,mobileSearch:!1,writer:!1,mobileWriter:!1,workflowEditor:!1,mobileNativeTab:!1,inferenceTranscriptChatView:!1},C={fullPage:!0,corner:!1,searchPane:!1,mobileNative:!1,commandSearch:!1,mobileWeb:!1,mobileSearch:!1,writer:!1,mobileWriter:!1,workflowEditor:!1,mobileNativeTab:!1,inferenceTranscriptChatView:!1},A={fullPage:!0,corner:!1,searchPane:!1,mobileNative:!1,commandSearch:!1,mobileWeb:!1,mobileSearch:!1,writer:!1,mobileWriter:!1,workflowEditor:!1,mobileNativeTab:!1,inferenceTranscriptChatView:!1},M={commandSearch:!1,searchPane:!1,fullPage:!0,writer:!0,corner:!0,mobileNative:!0,mobileWeb:!0,mobileSearch:!0,mobileWriter:!0,workflowEditor:!0,mobileNativeTab:!0,inferenceTranscriptChatView:!0};class P{constructor(e){this.type=e}get renderAsFullPage(){return a[this.type]}get renderChatHistoryAsFullPage(){return s[this.type]}get isCommandSearchOrSearchPane(){return this.isType("commandSearch")||this.isType("searchPane")}get isQuickSearchMode(){return this.isType("commandSearch")}get isMobile(){return c[this.type]}get isWriter(){return l[this.type]}isType(...e){return e.includes(this.type)}get shouldShowExpandToFullPageChat(){return p[this.type]}get isValidSurfaceForAttachmentUploads(){return m[this.type]}get shouldShowChatHistory(){return u[this.type]}get canUseCurrentPageContext(){return f[this.type]}get showCloseButton(){return v[this.type]}get surfaceSupportsContextWithSelection(){return h[this.type]}get surfaceSupportsParameterization(){return g[this.type]}get surfaceSupportsTutorialAction(){return S[this.type]}get surfaceSupportsShareAnswerAction(){return _[this.type]}get canShowNewChonkifiedInput(){return y[this.type]}canShowSessionStarterInContext(e){return P[e.from].isWriter===this.isWriter}get canUseUpdatedSkillDisplayFormat(){return T[this.type]}get canUseGetAiConnectorScopeMenuFooter(){return k[this.type]}get canShowNewFullPageWelcomeState(){return I[this.type]}get canShowNewWriterDesign(){return b[this.type]}get canShowNewCornerChatWelcomeState(){return w[this.type]}get supportsStartingNewChatAsInferenceTranscript(){return C[this.type]}get supportsChatHistoryWithInferenceTranscripts(){return A[this.type]}get shouldOpenAssistantMenuOnRestoreChatSession(){return M[this.type]}}n=P,P.fullPage=new n("fullPage"),P.corner=new n("corner"),P.searchPane=new n("searchPane"),P.commandSearch=new n("commandSearch"),P.mobileNative=new n("mobileNative"),P.mobileNativeTab=new n("mobileNativeTab"),P.writer=new n("writer"),P.mobileWeb=new n("mobileWeb"),P.mobileSearch=new n("mobileSearch"),P.mobileWriter=new n("mobileWriter"),P.workflowEditor=new n("workflowEditor"),P.inferenceTranscriptChatView=new n("inferenceTranscriptChatView");const x=r.createContext(void 0);function R(e){return(0,i.jsx)(x.Provider,{value:e.surface,children:e.children})}function N(){const e=r.useContext(x);return e||P.corner}x.displayName="AssistantSurfaceContext"},717375:(e,t,o)=>{o.d(t,{Ol:()=>a,ak:()=>c,bl:()=>d,xm:()=>l});o(898992),o(354520),o(581454);var n=()=>o(370657),r=()=>o(534177),i=()=>o(844317);function a(e){const{config:t,isResearchModeWebSearchEnabled:o,showSetupGenerator:n}=e;if("researcher"===t.type)return{...t,useWebSearch:o};if("setup-generator"===t.type){if(!n)return}else if("workflow"===t.type){return(0,i().n)({})}return t}function s(e){const{configs:t,isResearchModeWebSearchEnabled:o,showSetupGenerator:n}=e;return t.map((e=>a({config:e,isResearchModeWebSearchEnabled:o,showSetupGenerator:n}))).filter(r().O9)}function c(e){const{hasHomeEntryPoint:t,isResearchModeWebSearchEnabled:o,showSetupGenerator:r}=e;return s({configs:(0,n().qG)({agentEnabled:t}),isResearchModeWebSearchEnabled:o,showSetupGenerator:r})}function l(e){const{isResearchModeWebSearchEnabled:t,showSetupGenerator:o}=e;return s({configs:n().hx,isResearchModeWebSearchEnabled:t,showSetupGenerator:o})}function d(){return n().Vf}},770586:(e,t,o)=>{o.d(t,{v:()=>n});o(517642),o(658004),o(733853),o(845876),o(432475),o(515024),o(731698),o(898992),o(908872);function n(e,t){const o=e.reduce(((e,t)=>{if(t.isType("define_variables")){var o;const n=null===(o=t.getModel())||void 0===o?void 0:o.getVariables();if(n)for(const t of Object.values(n))e.add(t.name)}return e}),new Set),n=t.replace(/\s*\d+$/,"");let r=1,i=`${n} ${r}`;for(;o.has(i);)i=`${n} ${r}`,r++;return i}},839754:(e,t,o)=>{o.d(t,{Bi:()=>T,My:()=>b,ZM:()=>k,navigateToWorkflowTemplateOnboardingModal:()=>C});o(16280),o(944114),o(517642),o(658004),o(733853),o(845876),o(432475),o(515024),o(731698),o(898992),o(354520),o(672577),o(581454);var n=()=>o(584262),r=()=>o(663077),i=()=>o(179034),a=()=>o(201980),s=()=>o(401176),c=()=>o(896628),l=()=>o(857783),d=()=>o(601866),p=()=>o(319975),u=()=>o(231297),m=()=>o(840153),f=()=>o(147503),v=()=>o(180762),h=()=>o(799832),g=()=>o(111379),S=()=>o(765957),_=()=>o(148832),y=()=>o(541801),w=()=>o(373444),I=()=>o(204067);function b({transaction:e,collectionStore:t,propertyTemplates:o}){var n;const i=(null===(n=t.getParentBlockStore())||void 0===n?void 0:n.getCollectionViewStores().filter((e=>"table"===e.getType())))??[];if(0===i.length)return;const a=[];for(const c of o){const e=(0,I().S1)({collectionStore:t,templateId:c.templateId,instancePointerType:"property"});e&&a.push({property:e.id,visible:!(0,r().Sz)(c),...c.tablePropertyFormat})}if(0!==a.length)for(const r of i){var s;const t=(null===(s=r.getPropertyFormatsStore("table_properties"))||void 0===s?void 0:s.getValue())??[],o=new Set(t.map((e=>e.property))),n=a.filter((e=>!o.has(e.property)));0!==n.length&&c().zA({stores:[r],update:{table_properties:[...t,...n]},transaction:e})}}function T({transaction:e,collectionStore:t,propertyTemplates:o}){const n=[];for(const s of o){const e=(0,I().S1)({collectionStore:t,templateId:s.templateId,instancePointerType:"property"});e&&n.push({property:e.id,visible:!0})}const r=t.getFormat().collection_page_properties??[],i=new Set(r.map((e=>e.property))),a=n.filter((e=>!i.has(e.property)));a.length&&c().zA({stores:[t],update:{collection_page_properties:[...r,...a]},transaction:e})}function k({environment:e,userAction:t,result:o,existingCollectionViewBlockStore:n,existingCollectionStore:r}){if("canceled"!==o.type){if("accepted_empty_collection"===o.type&&r){const n=r.getKeyStore("name"),i=(0,a().x9d)(o.newCollectionTitle);n&&u().createAndCommit({userAction:t,environment:e,canUndo:!0,perform:t=>p().R9({environment:e,store:n,transaction:t,value:i})})}if(n){var i;const e=null===(i=(0,h().U)(n))||void 0===i?void 0:i.settingsStore;e&&f().os({collectionSettingsStore:e})}if("accepted_template"===o.type&&null!=n&&n.isCollectionView()&&(null==n||!n.hasSingleSourceAndNoLinkedCollections())){const t=(0,h().U)(n),r=n.getCollectionViewStores().find((e=>{var t;return(null===(t=e.getCollectionStore())||void 0===t?void 0:t.id)===o.collectionId}));if(!t||!r)return;(0,v().t)({environment:e,collectionContextStore:t,collectionViewId:r.id,isFullScreen:t.isFullScreenStore.state,isRootChild:t.isRootChildStore.state,isInPeekRenderer:t.isInPeekRendererStore.state})}}}async function C({environment:e,collectionViewBlockId:t}){let o=new(_().B)(e,{table:i().ev,id:t});if(await o.load(),!o.isDefined()){const n=await s().$f({environment:e,blockId:t});if(!n)return;e=await m().T({environment:e,newCurrentUserId:n}),o=new(_().B)(e,{table:i().ev,id:t}),await o.load()}const r=o.getSpaceId();if(!r)throw new Error("Space ID not found for collection block");const a=(0,g().k)(r);if(!a)throw new Error(`Space view not found for space ID: ${r}`);const{sidebarSpaceStore:c}=S().default.state;(null==c?void 0:c.id)!==r&&await d().yV({environment:e,spaceViewStore:a});const p=o.getFormat();if("workflow_template_placeholder"===(null==p?void 0:p.collection_view_sub_type)&&null!=p&&p.placeholder_workflow_template_id&&o.isCollectionView()){const{getCollectionTemplateFromId:t}=await y().tA.load(),n=t(p.placeholder_workflow_template_id);if(!n)throw new Error(`Collection template "${p.placeholder_workflow_template_id}" not found`);const{onNavigateToPlaceholderWorkflowTemplateBlock:r}=await w().O.load();r({environment:e,collectionTemplate:n,collectionViewBlockStore:o})}else l().uK({environment:e,store:o,pageVisitSource:n().y8.WorkflowTemplatesDeeplink})}},844317:(e,t,o)=>{o.d(t,{n:()=>p});var n=()=>o(242422),r=()=>o(81986),i=()=>o(365646),a=()=>o(915671),s=()=>o(534177);const c=new(o(178624).R)({key:"agent_memory_database_page",namespace:o(553737).Bq,important:!0,trackingType:"preference"});var l=()=>o(604018),d=()=>o(430483);function p(e){const{searchScopes:t,useWebSearch:o,model:p,isCustomAgent:m}=e,f=p&&(0,s().Xk)(i().eN,p)?p:void 0,v=void 0===o||o,h=d().zD.isZeroRetentionEnabled(),g=(0,r().MI)((0,r().VD)("custom_agents"),u),S=(0,r().MI)((0,r().VD)("agent_automations"),u),_=n().default.checkGate({gateName:"agent_codegen_integration"}),y=(0,r().MI)((0,r().VD)("background_agents"),u),w=(0,r().MI)((0,r().VD)("agent_support_linked_databases"),u),I=(0,r().MI)((0,r().VD)("agent_integrations"),u),b=(0,r().MI)((0,r().VD)("experimental_integrations"),u),T=(0,r().MI)((0,r().VD)("database_agents"),u),k=(0,r().MI)((0,r().VD)("agent_makes_formulas"),u),C=(0,r().MI)((0,r().VD)("agent_user_session_context"),u),A=(0,r().MI)((0,r().VD)("agent_comments"),u),M=(0,r().MI)((0,r().VD)("agent_create_form"),u),P=u("agent_version_history_tool_enabled"),x=c.getState(),R=null==x?void 0:x.pageId;return{type:"workflow",enableAgentAutomations:S,enableAgentIntegrations:I,enableBackgroundAgents:y,enableCodegenIntegration:_,enableCustomAgents:g,enableExperimentalIntegrations:b,enableLinkedDatabases:w,enableAgentViewVersionHistoryTool:P,searchScopes:t??a().R2,enableDatabaseAgents:T,enableAgentComments:A,enableAgentForms:M,useWebSearch:!h&&v,enableAgentMakesFormulas:k,availableConnectors:(0,l().wd)(),enableUserSessionContext:C,memoryDatabasePageId:R,model:f,modelFromUser:void 0!==f,isCustomAgent:Boolean(m)}}function u(e){return n().default.checkGate({gateName:e})}},874753:(e,t,o)=>{o.d(t,{P:()=>r});class n extends(()=>o(757695))().Store{getInitialState(){return{open:!1,currentView:"chat",from:void 0,isAssistantInputEmpty:!0}}}const r=new n;(0,o(852832).exposeDebugValue)("AssistantMenuStore",r)},878456:(e,t,o)=>{o.d(t,{Mt:()=>m,RM:()=>p,dC:()=>s,f_:()=>f,h6:()=>l,ie:()=>d,q1:()=>a,uF:()=>u});o(410838),o(813451),o(944114),o(898992),o(354520),o(737550);var n=()=>o(534177),r=()=>o(724639),i=()=>o(484127);function a(e){return e.some((e=>"config"===e.type&&"workflow"===e.value.type))}function s(e){return e.some((e=>"config"===e.type&&"researcher"===e.value.type))}const c=/<lang\s+.*?>\s*/g;function l(e){return e.replace(c,"")}function d(e){if("string"==typeof e.value)return{...e,value:l(e.value)};if(Array.isArray(e.value)){const t=e.value.findIndex((e=>"text"===e.type));if(-1===t)return e;let o="";for(const a of e.value.slice(t)){if("text"!==a.type)break;o+=a.content}if(!c.exec(o))return e;let n="",r=t;for(;r<e.value.length;r++){const t=e.value[r];if("text"!==t.type)break;n+=t.content}const i=[...e.value.slice(0,t),{type:"text",content:n.replace(c,"")},...e.value.slice(r)];return"text"===i[0].type&&0===i[0].content.length&&i.shift(),{...e,value:i}}return e}function p(e,t){const o={};for(const n of e)"registered-tool-grouping"===n.type&&(o[n.toolCallId]=n);let a=[...e];if("user"===t.type||"error"===t.type||"premium-feature-unavailable"===t.type||"context"===t.type||"title"===t.type||"retry"===t.type||"autocorrect"===t.type||"autocomplete"===t.type||"search-observation"===t.type||"researcher-text-observation"===t.type||"debug-inference"===t.type||"wait"===t.type||"agent-search-query-generation"===t.type||"fast-researcher-plan"===t.type||"fast-researcher-search-results"===t.type||"memory-agent"===t.type||"summarize-transcript"===t.type||"summarize-transcript-record-map"===t.type||"summarize-transcript-error"===t.type||"record-pointers-updated"===t.type||(0,r().P0)(t)||"researcher-agent-group"===t.type||"agent-debug-error"===t.type||"eval-result"===t.type||"attachment"===t.type||"agent-transcript-summary"===t.type||"agent-records-updated"===t.type||"agent-turn-start"===t.type||"agent-record-map"===t.type||"user-specified-context"===t.type||"mention"===t.type||"agent-integration"===t.type||"aiBlockResponse"===t.type||"system-notification"===t.type||"agent-trigger"===t.type||"agent-prebuilt-prompt"===t.type||"agent-route-trigger"===t.type||"workflow-effect-calling"===t.type||"workflow-effect-called"===t.type||"workflow-effect-error"===t.type)a.push({...t});else if("agent-turn-full-record-map"===t.type){const e=a.findLastIndex((e=>e.id===t.id));if(-1!==e&&"agent-turn-full-record-map"===a[e].type){const o=a[e];a[e]={...o,threadRecordMap:t.threadRecordMap,recordVersions:t.recordVersions}}else a.push({...t})}else if("search"===t.type)a=[...a.filter((e=>e.id!==t.id)),{...t}];else if("agent-inference"===t.type||"agent-tool-result"===t.type||"config"===t.type){const e=a.findLastIndex((e=>e.id===t.id));-1!==e?a[e]=t:a.push({...t})}else if("markdown-chat"===t.type){const e=a.findLastIndex((e=>e.id===t.id));if(-1!==e&&"markdown-chat"===a[e].type){const o=a[e];a[e]={...o,value:`${o.value}${t.value}`}}else a.push({...t})}else if("search-chat"===t.type){const e=a.findLastIndex((e=>e.id===t.id));if(-1!==e&&"search-chat"===a[e].type){const o=a[e];a[e]={...o,value:`${o.value}${t.value}`}}else a.push({...t})}else if("fast-researcher-chat"===t.type){const e=a.findLastIndex((e=>e.id===t.id));if(-1!==e&&"fast-researcher-chat"===a[e].type){const o=a[e];a[e]={...o,value:`${o.value}${t.value}`}}else a.push({...t})}else if("setup"===t.type){const e=a.findLastIndex((e=>e.id===t.id));-1!==e&&"setup"===a[e].type?a[e]=t:a.push({...t})}else if("researcher-report"===t.type){const e=a.findLastIndex((e=>e.id===t.id));if(-1!==e&&"researcher-report"===a[e].type){const o=a[e];a[e]={...o,value:`${o.value}${t.value}`,citationInfo:(0,i().Mi)(o.citationInfo,t.citationInfo)}}else a.push({...t})}else if("researcher-agent"===t.type){const e=a.findIndex((e=>e.id===t.id));-1!==e&&"researcher-agent"===a[e].type?a[e]={...a[e],value:Object.assign(a[e].value,t.value),updatedAt:t.updatedAt}:a.push({...t})}else if("researcher-next-steps"===t.type){const e=a.findIndex((e=>e.id===t.id));-1!==e?a[e]={...t}:a.push({...t})}else if("registered-tool-call"===t.type||"registered-tool-output"===t.type||"registered-tool-error"===t.type){let e=o[t.toolCallId];e||(e={id:t.toolCallId,type:"registered-tool-grouping",toolName:t.toolName,toolCallId:t.toolCallId,steps:[]},o[t.toolCallId]=e,a.push(e));const n={...t};e.steps.push(n)}else if("registered-tool-grouping"===t.type)o[t.toolCallId]||(o[t.toolCallId]=t,a.push({...t}));else if("setup-operations"===t.type){const e=a.findLastIndex((e=>e.id===t.id)),o=a[e];(null==o?void 0:o.type)===t.type?a[e]={...o,operations:[...o.operations,...t.operations]}:a.push({...t})}else if("generate-formula"===t.type){const e=a.findLastIndex((e=>e.id===t.id));-1!==e&&"generate-formula"===a[e].type?a[e]={...a[e],value:t.value}:a.push({...t})}else(0,n().HB)(t);return a}const u="inferenceTranscript";function m(e){return"object"==typeof e&&null!==e&&"transcript"in e}function f(e){const t=e.findLast((e=>"config"===e.type));return null==t?void 0:t.value}},922952:(e,t,o)=>{o.d(t,{u:()=>a});var n=()=>o(148832),r=()=>o(985405),i=()=>o(95758);function a(e){return e instanceof i().h||e instanceof r().SpaceStore||e instanceof n().B}}}]);