(globalThis.webpackChunknotion_next=globalThis.webpackChunknotion_next||[]).push([[44425],{53718:(e,t,n)=>{"use strict";n.d(t,{T:()=>r});var o=()=>n(44551);async function r(){var e;return null===o().electronApi||void 0===o().electronApi||null===(e=o().electronApi.getSqliteDiskUsage)||void 0===e?void 0:e.call(o().electronApi)}},140290:(e,t,n)=>{const o=()=>n(194755),r=";",i=">",s="<";function a(e){let t="";e>0&&(t+=r);const n=e.toString();return n.length>1&&(t+=a(n.length)),t+=n,t}function c(e,t){if(!e)throw new Error(`Input is not a valid ELEN-encoded number: ${t}.`)}e.exports={encode:function(e){if("number"!=typeof e)throw new Error(`Value is not of type number: ${e}.`);const{sign:t,exponent:n,mantissa:r}=o().deconstruct(e);let c="";return c+=1===t?s:i,c+=a(1===t?o().MAX_EXPONENT-n:n),c+=a(1===t?o().MAX_MANTISSA-r:r),c},decode:function(e){if("string"!=typeof e)throw new Error(`Value is not of type string: ${e}.`);const{signLength:t,sign:n}=function(e,t){if(c(t<e.length,e),e[t]===i)return{signLength:1,sign:0};if(e[t]===s)return{signLength:1,sign:1};c(!1,e)}(e,0),{exponentLength:a,exponent:d}=function(e,t,n){if(c(n<e.length,e),"0"===e[n])return{exponentLength:1,exponent:0===t?0:o().MAX_EXPONENT};let i,s,a=n,d=0;for(;e[a]===r;)d+=1,a+=1;c(0!==d,e),s=1;for(;d>0;)i=s,s=Number.parseInt(e.substr(a,s)),c(s>0,e),a+=i,d-=1;return{exponentLength:a-n,exponent:0===t?s:o().MAX_EXPONENT-s}}(e,n,t),{mantissaLength:l,mantissa:u}=function(e,t,n){if(c(n<e.length,e),"0"===e[n])return{mantissaLength:1,mantissa:0===t?0:o().MAX_MANTISSA};let i,s,a=n,d=0;for(;e[a]===r;)d+=1,a+=1;c(0!==d,e),s=1;for(;d>0;)i=s,s=Number.parseInt(e.substr(a,s)),c(s>0,e),a+=i,d-=1;return{mantissaLength:a-n,mantissa:0===t?s:o().MAX_MANTISSA-s}}(e,n,t+a);return c(e.length===t+a+l,e),o().construct({sign:n,exponent:d,mantissa:u})}}},194755:e=>{const t=0xfffffffffffff;function n(e){return s(e[7],7)}function o(e){let t=0;return t+=i(127&e[7],4),t+=s(e[6],4),t}function r(e){let t=0;return t+=i(15&e[6],48),t+=i(e[5],40),t+=i(e[4],32),t+=i(e[3],24),t+=i(e[2],16),t+=i(e[1],8),t+=e[0],t}function i(e,t){return e*Math.pow(2,t)}function s(e,t){return Math.floor(e/Math.pow(2,t))}e.exports={MAX_EXPONENT:2047,MAX_MANTISSA:t,construct:function({sign:e,exponent:n,mantissa:o}){if(0!==e&&1!==e)throw new Error(`Invalid value for sign: ${e}.`);if("number"!=typeof n||n<0||2047<n)throw new Error(`Invalid value for exponent: ${n}.`);if("number"!=typeof o||o<0||t<o)throw new Error(`Invalid value for mantissa: ${o}.`);const r=new ArrayBuffer(8),a=new Float64Array(r),c=new Uint8Array(r);return function(e,t){t[7]|=i(e,7)}(e,c),function(e,t){t[7]|=s(e,4),t[6]|=i(15&e,4)}(n,c),function(e,t){t[6]|=255&s(e,48),t[5]|=255&s(e,40),t[4]|=255&s(e,32),t[3]|=255&s(e,24),t[2]|=255&s(e,16),t[1]|=255&s(e,8),t[0]|=255&e}(o,c),a[0]},deconstruct:function(e){if("number"!=typeof e)throw new Error(`Value is not of type number: ${e}.`);const t=new ArrayBuffer(8),i=new Float64Array(t),s=new Uint8Array(t);return i[0]=e,{sign:n(s),exponent:o(s),mantissa:r(s)}}}},352733:(e,t,n)=>{"use strict";n.d(t,{j:()=>i,n:()=>s});var o=()=>n(671593),r=()=>n(416845);function i(e,t,n={}){const i=(0,o().tf)(e,t,n);if(i)throw new(r().yI)(i.message)}function s(e,t){const n=(0,o().tf)(e,t);if(void 0!==n)throw new(r().yI)(n.message);return t}},408863:function(e,t,n){"use strict";var o=this&&this.__createBinding||(Object.create?function(e,t,n,o){void 0===o&&(o=n);var r=Object.getOwnPropertyDescriptor(t,n);r&&!("get"in r?!t.__esModule:r.writable||r.configurable)||(r={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,o,r)}:function(e,t,n,o){void 0===o&&(o=n),e[o]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),i=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&o(t,e,n);return r(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.jsonCodec=t.Codec=t.MaxEncoding=t.MinEncoding=t.MAX=t.MIN=t.ObjectLegacyEncoding=t.ObjectEncoding=t.ArrayEncoding=t.NumberEncoding=t.StringEncoding=t.BooleanEncoding=t.NullEncoding=void 0;const s=i(n(140290)),a=()=>n(881270);t.NullEncoding={match:e=>null===e,encode:()=>"",decode:()=>null,compare:()=>0},t.BooleanEncoding={match:e=>!0===e||!1===e,encode:e=>JSON.stringify(e),decode:e=>JSON.parse(e),compare:a().compare},t.StringEncoding={match:e=>"string"==typeof e,encode:e=>e,decode:e=>e,compare:a().compare},t.NumberEncoding={match:e=>"number"==typeof e,encode:e=>s.encode(e),decode:e=>s.decode(e),compare:a().compare},t.ArrayEncoding={match:e=>Array.isArray(e),encode:(e,t)=>e.map(((e,n)=>t(e).replace(/\x01/g,"").replace(/\x00/g,"\0")+"\0")).join(""),decode:(e,t)=>{if(""===e)return[];const n=/(\x01(\x01|\x00)|\x00)/g,o=[];let r=0;for(;;){const i=n.exec(e);if(null===i)return o;if(""===i[0][0])continue;const s=i.index,a=t(e.slice(r,s).replace(/\x01\x01/g,"").replace(/\x01\x00/g,"\0"));o.push(a),r=s+1}},compare:(e,t,n)=>{const o=Math.min(e.length,t.length);for(let r=0;r<o;r++){const o=n(e[r],t[r]);if(0!==o)return o}return(0,a().compare)(e.length,t.length)}},t.ObjectEncoding={match:e=>"object"==typeof e&&null!==e&&Object.getPrototypeOf(e)===Object.prototype,encode:(e,n)=>{const o=function(e){const t=[];for(const n of e)for(const e of n)t.push(e);return t}(Object.entries(e).sort((([e],[t])=>(0,a().compare)(e,t))));return t.ArrayEncoding.encode(o,n)},decode:(e,n)=>{const o=function(e,t){const n=[];for(let o=0;o<e.length;o+=t){const r=e.slice(o,o+t);n.push(r)}return n}(t.ArrayEncoding.decode(e,n),2),r={};for(const[t,i]of o)r[t]=i;return r},compare:(e,t,n)=>{const o=Object.entries(e).sort((([e],[t])=>(0,a().compare)(e,t))),r=Object.entries(t).sort((([e],[t])=>(0,a().compare)(e,t))),i=Math.min(o.length,r.length);for(let s=0;s<i;s++){const[e,t]=o[s],[i,c]=r[s],d=(0,a().compare)(e,i);if(0!==d)return d;const l=n(t,c);if(0!==l)return l}return(0,a().compare)(o.length,r.length)}},t.ObjectLegacyEncoding={match:e=>"object"==typeof e&&null!==e&&Object.getPrototypeOf(e)===Object.prototype,encode:(e,n)=>{const o=Object.entries(e).sort((([e],[t])=>(0,a().compare)(e,t)));return t.ArrayEncoding.encode(o,n)},decode:(e,n)=>{const o=t.ArrayEncoding.decode(e,n),r={};for(const[t,i]of o)r[t]=i;return r},compare:t.ObjectEncoding.compare},t.MIN=Symbol("min"),t.MAX=Symbol("max"),t.MinEncoding={match:e=>e===t.MIN,encode:()=>"",decode:()=>t.MIN,compare:()=>0},t.MaxEncoding={match:e=>e===t.MAX,encode:()=>"",decode:()=>t.MAX,compare:()=>0};class c{constructor(e){this.encodings=e,this.encode=e=>{for(const[t,n]of Object.entries(this.encodings))if(n.match(e))return t+n.encode(e,this.encode);throw new Error(`Missing encoding for value: ${e}`)},this.decode=e=>{const t=e[0],n=e.slice(1);for(const[o,r]of Object.entries(this.encodings))if(o===t)return r.decode(n,this.decode);throw new Error(`Missing encoding for value: ${e}`)},this.compare=(e,t)=>{if(e===t)return 0;let n,o;for(const[r,i]of Object.entries(this.encodings))if(!n&&i.match(e)&&(n=[r,i]),!o&&i.match(t)&&(o=[r,i]),n&&o)break;if(!n)throw new Error(`Missing encoding for value: ${e}`);if(!o)throw new Error(`Missing encoding for value: ${t}`);return n[0]!==o[0]?(0,a().compare)(n[0],o[0]):n[1].compare(e,t,this.compare)};for(const t in e)if(1!==t.length)throw new Error(`Encoding prefix is not 1 byte: ${t}`)}}t.Codec=c,t.jsonCodec=new c({"\0":t.MinEncoding,b:t.NullEncoding,c:t.ObjectEncoding,d:t.ArrayEncoding,e:t.NumberEncoding,f:t.StringEncoding,g:t.BooleanEncoding,"ÿ":t.MaxEncoding})},424127:(e,t,n)=>{"use strict";n.d(t,{uW:()=>u});n(16280);var o=n(296540),r=()=>n(726637),i=()=>n(484714),s=()=>n(763824),a=()=>n(615234),c=()=>n(534177),d=()=>n(645873);const l=100;function u(e,t,n,u=!1){const p=function(e){var t,n;const s=(0,i().v3)(),a=null===(t=s.sqliteConnection)||void 0===t||null===(n=t.getObserver)||void 0===n?void 0:n.call(t),c=a?g.get(a):void 0,[u,p]=(0,o.useState)(c),h=(0,d().fJ)(f,{disabled:!e});return(0,o.useEffect)((()=>{if(u||!a||!e)return;const t=g.get(a);if(t)return void p(t);if("resolved"!==h.status||!a)return;const{TabSqliteSubscriptionBackend:n,SqliteSubscriptionManager:o}=h.value,i=new o(new n({observer:a,debounceMs:l,broadcastWritesChannel:new BroadcastChannel("sqlite-writes"),config:r().A}));g.set(a,i),p(i)}),[a,h,u,e]),e?u:void 0}(Boolean(t)),h=function(e,t,n,r,s){const a=(0,i().v3)().currentUser.id,d=t?function(e,t,n,o,r,i){var s,a;if(!n&&null!==(s=o.rowType)&&void 0!==s&&s.singleton)throw new Error(`Must use useSqliteSingleton for singleton row type: ${o.rowType.name}`);const d=t.sql();let l=o.readTables;if(!l){const e=null==r?void 0:r.parseQuery(d);var u;if(e)switch(e.type){case"unknown":l=e.tables;break;case"error":throw e.error;case"crud":if(e.writeTables.length>0)throw new Error(`useSqliteQuery: cannot subscribe to query that writes to tables: ${e.writeTables.join(", ")}`);l=e.readTables;break;default:(0,c().HB)(e)}else l=null===(u=o.rowType)||void 0===u?void 0:u.readTables}const f={_key:`sqlite:KeyCreatorNotLoaded:${e}`,_options:o,singleton:n,sql:d,args:t.args,queryName:e,readTables:l,primaryKey:o.primaryKey??(null===(a=o.rowType)||void 0===a?void 0:a.primaryKey),rowType:o.rowType,userId:i||"guest"};r&&(f._key=r.keyCreator.getKeyUncached(f));return f}(e,t,n,r,s,a):void 0,[l,u]=(0,o.useState)(d);if((null==d?void 0:d._key)!==(null==l?void 0:l._key))return u(d),d;return l}(e,t,u,n,p),v=h?null==p?void 0:p.createQuery(h._key,h):void 0,b=v??m,y=(0,o.useSyncExternalStore)(b.subscribe,b.getSnapshot),w=function(e,t,n){var r;const i=null===(r=(0,d().fJ)(f,{disabled:!e}).value)||void 0===r?void 0:r.OptimisticUpdateComposer;return(0,o.useCallback)(((o,r)=>e&&n&&i&&e?async function(e,t,n,o,r,i){const c=o.rowType;if(!c)throw new Error(`Optimistic updates not supported for queries without a RowType or primaryKey: ${o.key}`);const d=new i(c,n);let l;try{t(d)}finally{l=d.done()}const{queryUpdate:u,rowTypeUpdate:f}=l;if(!u&&!f)return e();let g,p;const h=()=>{var e,t;null===(e=g)||void 0===e||e(),null===(t=p)||void 0===t||t()};f&&(r.dispatchRowTypeUpdate(o.userId,c,{type:"put",update:f}),g=()=>{r.dispatchRowTypeUpdate(o.userId,c,{type:"del",id:f.id})});u&&(o.dispatch({type:"put",update:u}),p=()=>{o.dispatch({type:"del",id:u.id})});const m=(0,s().nQ)(10*a().TD,o.waitForRerun()),v=e();return Promise.all([v,m]).finally(h),await v}(o,r,t,e,n,i):o()),[e,n,i,t])}(v,Boolean(null==h?void 0:h.singleton),p),_=Boolean(t),S=(0,o.useMemo)((()=>({...y,withOptimistic:w,enabled:_})),[y,w,_]);if(S.error&&(null==h||!h._options.allowError))throw S.error;return S}const f=new(d().O2)("SqliteSubscriptions",(async()=>{const[{TabSqliteSubscriptionBackend:e},{SqliteSubscriptionManager:t},{OptimisticUpdateComposer:o}]=await Promise.all([Promise.all([n.e(14208),n.e(93199)]).then(n.bind(n,384233)),Promise.all([n.e(14208),n.e(93199)]).then(n.bind(n,316878)),Promise.all([n.e(14208),n.e(93199)]).then(n.bind(n,415123))]);return{TabSqliteSubscriptionBackend:e,SqliteSubscriptionManager:t,OptimisticUpdateComposer:o}})),g=new WeakMap;function p(){}const h=Object.freeze({loading:!0,seq:-1,value:void 0,valueSeq:void 0,error:void 0,errorSeq:void 0}),m={subscribe:()=>p,getSnapshot:()=>h,dispatch:p}},430837:function(e,t,n){"use strict";var o=this&&this.__createBinding||(Object.create?function(e,t,n,o){void 0===o&&(o=n);var r=Object.getOwnPropertyDescriptor(t,n);r&&!("get"in r?!t.__esModule:r.writable||r.configurable)||(r={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,o,r)}:function(e,t,n,o){void 0===o&&(o=n),e[o]=t[n]}),r=this&&this.__exportStar||function(e,t){for(var n in e)"default"===n||Object.prototype.hasOwnProperty.call(t,n)||o(t,e,n)};Object.defineProperty(t,"__esModule",{value:!0}),r(n(408863),t)},448835:(e,t,n)=>{"use strict";n.d(t,{Pz:()=>c,bG:()=>i,lI:()=>s,of:()=>r,ym:()=>a});var o=()=>n(645873);const r=new(o().O2)("offlineSettings",(()=>Promise.all([n.e(4422),n.e(4330),n.e(3551)]).then(n.bind(n,991165)))),i=(0,o()._h)(r,(e=>e.OfflineSettings)),s=(0,o()._h)(r,(e=>e.OfflineSettingsMobile)),a=(0,o()._h)(r,(e=>e.MobileOfflineSettingsSection)),c=(0,o()._h)(r,(e=>e.OfflineModeDebugSettings))},881270:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.compare=void 0,t.compare=function(e,t){return e>t?1:e<t?-1:0}},978161:(e,t,n)=>{"use strict";n.r(t),n.d(t,{cacheSidebarImagesDebounced:()=>Y,debugAttemptFetch:()=>xe,loadRemotePageAndImagesBatched:()=>G,maybeDownloadImageForOffline:()=>K,useCacheSidebarImages:()=>fe,useOfflineTransitionTracking:()=>Fe,usePageSubscriptionManager:()=>$e,useRefetchOfflinePages:()=>ke,useUpdateAutosyncedPages:()=>je().u});n(16280),n(944114),n(517642),n(658004),n(733853),n(845876),n(432475),n(515024),n(731698),n(898992),n(354520),n(581454);var o=()=>n(992437),r=()=>n(386164),i=()=>n(142748),s=()=>n(388821),a=()=>n(179034),c=()=>n(430837),d=()=>n(638681),l=()=>n(852832);const u=d().lazy((()=>d().union([d().tuple([d().instanceOf(v),d().instanceOf(Date),d().instanceOf(v),d().instanceOf(v),d().string()]),d().tuple([d().instanceOf(v),d().instanceOf(Date),d().instanceOf(v),d().isNull(),d().isNull()])])));let f;const g=-2n,p={BEFORE_ALL_OFFSETS:g,atStart:()=>({type:1,timestamp:-1,offset:g}),atTimestamp:e=>({type:1,timestamp:e,offset:g}),encode:function(e){let t;if(e.pointer){const o="number"==typeof e.pointer.encodedTable?e.pointer.encodedTable:(0,n(628536).vi)(e.pointer.encodedTable);t=[new v(e.type,16),new Date(e.timestamp),new v(e.offset,64),new v(o,16),e.pointer.id]}else t=[new v(e.type,16),new Date(e.timestamp),new v(e.offset,64),null,null];return(0,n(747595)._)(y.encode(t))},decode:function(e){try{const t=y.decode(e);(0,n(352733).j)(u,t);const[o,r,i,s,a]=t,c=o.toFloat64(),d=1;if(c!==d)throw new Error(`decoded type from payload[0]: is \`${c}\`, should be \`${d}\``);const l={type:c,timestamp:r.getTime(),offset:i.value};return s&&null!==a&&(l.pointer={encodedTable:s.toFloat64(),id:a}),l}catch(t){const e=(0,n(319625).A)(t);throw e.message=`SyncCursor decode error: ${e.message}`,e}},encodedStartCursor:()=>f??=p.encode(p.atStart()),encodedAtTimestamp:e=>p.encode(p.atTimestamp(e))};function h(e,t){return e<t?-1:e>t?1:0}class m{constructor(e){this.prefix="i",this.match=e=>Boolean(e&&e instanceof v&&e.bits===this.bits),this.compare=(e,t)=>h(e.value,t.value),this.encode=e=>this.encodeBigint(e.value),this.decode=e=>new v(this.decodeBigint(e),this.bits),this.encodeBigint=e=>{this.assertFitsBits(e);const t=e<0n?"-":"",n=e<0n?2n**BigInt(this.bits)+e:e;if(n<0n)throw new Error(`Expected abs value twos compliment >0, instead was: ${n}`);const o=n.toString(16).padStart(this.bits/4,"0");return`${t}${this.prefix}${o}`},this.decodeBigint=e=>{const t="-"===e[0]?e.slice(1+this.prefix.length):e.slice(this.prefix.length),n=BigInt("0x"+t);return BigInt.asIntN(this.bits,n)},this.assertFitsBits=e=>{const t=BigInt.asIntN(this.bits,e);if(t!==e)throw new Error(`IntN bigint out of range for IntN<${this.bits}>: truncated to ${t}, expected ${e}`)},this.bits=e}}class v{constructor(e,t){this.value=void 0,this.bits=t,this.value=BigInt(e)}toFloat64(){if(this.value>BigInt(Number.MAX_SAFE_INTEGER)||this.value<BigInt(Number.MIN_SAFE_INTEGER))throw new Error(`IntN value ${this.value} out of range ${Number.MIN_SAFE_INTEGER}-${Number.MAX_SAFE_INTEGER} for Float64`);return Number(this.value)}toString(){return`IntN<${this.bits}>(${this.value})`}}const b={match:e=>Boolean(e&&e instanceof Date),compare:(e,t)=>h(e,t),encode:e=>e.toISOString(),decode:e=>new Date(e)},y=new(c().Codec)({"\0":c().MinEncoding,'"':c().StringEncoding,"#":c().NumberEncoding,"%":b,2:new m(16),4:new m(32),8:new m(64),"?":c().BooleanEncoding,"[":c().ArrayEncoding,"{":c().ObjectEncoding,"þ":c().NullEncoding,"ÿ":c().MaxEncoding});(0,l().exposeDebugValue)("SyncCursor",p),(0,l().exposeDebugValue)("SyncCursorCodec",y);var w=()=>n(449412),_=()=>n(496603),S=()=>n(763824),I=()=>n(534177),C=()=>n(559506),T=()=>n(494043),R=()=>n(144460),M=()=>n(530684),E=()=>n(451169),O=()=>n(996720),A=()=>n(700500);function P(e,t){const n=t.getModel({table:a().ev,id:e});if((null==n?void 0:n.getType())===A().xd.collectionView)return[];return t.getModelsByTable(a().ev).filter((n=>((t,n)=>{if(t.getType()!==A().xd.collectionView)return!1;const o=(0,i().MR)(t.pointer,n);for(const r of o.slice(1)){if(r.id===e)return!0;if(r.table===a().ev&&r.getType()===A().xd.page)return!1}return!1})(n,t))).map((e=>e.id))}function k(e){const{pageId:t,cellId:n}=e;return[t,n||"NoCellId","EmptyStack"].join("|")}function x(e){const{cursorItem:t,pageId:n,cellId:o}=e,{id:r,table:i,index:s}=t;return[n,o||"NoCellId",r,i,s].join("|")}n(964979);var q=()=>n(929219),B=()=>n(825237),N=()=>n(651124),$=()=>n(837420),U=()=>n(201980),j=()=>n(179266),L=()=>n(765957),F=()=>n(959462),D=()=>n(944620),V=()=>n(152651);function W({icon:e,permissionRecord:t,recordMap:n,environment:o}){var r;const i=(0,N().WO)(e);switch(i.type){case"custom_emoji":const s=(null==n?void 0:n.getModel(i.emoji.pointer))??o.defaultRecordCache.inMemoryRecordCache.getRecordModel({pointer:i.emoji.pointer,userId:o.currentUser.id});if(!s)return;const a=null===(r=s.getIconIfAlive())||void 0===r?void 0:r.icon;if(!a)return;return{url:a,permissionRecord:i.emoji.pointer};case"url":return{url:e,permissionRecord:t};case"unicode_emoji":case"notion_icon":case"app_package_asset":return;default:(0,I().HB)(i)}}async function X({urlAndPermissionRecords:e,environment:t,abortSignal:n}){for(const{url:o,permissionRecord:r}of e){const e=await(0,j().L)({url:o,isAuthenticated:!0,permissionRecord:r},t),i=B().MU(e);i&&await new Promise(((e,t)=>{if(n.aborted)return void t(new(D().f));const o=new Image,r=()=>{o.onload=null,o.onerror=null};o.onload=()=>{r(),e()},o.onerror=n=>{r(),n instanceof DOMException&&"AbortError"===n.name||n instanceof D().f?t(new(D().f)):(w().O8(n,{from:"cacheImagesForOffline",type:"error",data:{url:i}}),e())},o.src=i}))}}function K(e){var t;if(!e)return;if(!q().A.state.online)return;if(!(0,V().C)())return;const n=null===(t=L().default.state.mainEditorCurrentBlockStore)||void 0===t||null===(t=t.getNavigableBlockStore())||void 0===t?void 0:t.id;if(!n)return;if(!(n in(F().A.state.offlinePages??{})))return;const o=(0,B().MU)(e);if(!o)return;const r=new Image;r.src=o,r.onerror=e=>{w().O8(e,{from:"useOfflineImages",type:"error",data:{url:o}})}}const z=100;async function G(e){var t;const{request:n,environment:o,abortSignal:r,skipBatching:i}=e,s=performance.now();let c=0;const d=(0,R().L)("download_batch_size");if(d<1)return{imageCount:0,downloadedVersion:void 0,downloadedSyncCursor:void 0,collectionViewBlockIds:[],pageDownloadTime:0,imagesDownloadTime:0,batchedSyncCount:0};const l=i?1:d;let u;switch(n.type){case"syncOfflinePages":u=await Q.getInstance().syncPage({batchSize:l,request:n,environment:o,abortSignal:r});break;case"syncPageRecordSinceTimestamp":u=await Z.getInstance().syncPage({batchSize:l,request:n,environment:o,abortSignal:r});break;default:(0,I().HB)(n)}r.throwIfAborted();const f=performance.now(),g=u.recordMap.getModel({table:a().ev,id:n.page.id});if(g){const e=function({blockModel:e,environment:t,recordMap:n}){const o=[],r=[e.pointer,...e.getRenderableContentPointers()],i=new Set;if(e.getType()===A().xd.page){const t=e.getFormatValue("page_cover");t&&o.push({url:t,permissionRecord:e.pointer})}for(;r.length;){const e=r.shift();if(!e)continue;if(i.has(e.id))continue;i.add(e.id);const a=(null==n?void 0:n.getModel(e))??t.defaultRecordCache.inMemoryRecordCache.getRecordModel({pointer:e,userId:t.currentUser.id});if(a){if(a.getType()===A().xd.image){const e=a.getFormatValue("display_source");e&&o.push({url:e,permissionRecord:a.pointer})}else if(a.getType()===A().xd.page||a.getType()===A().xd.callout){const e=a.getFormatValue("page_icon");if(e){const r=W({icon:e,permissionRecord:a.pointer,recordMap:n,environment:t});r&&o.push(r)}}else if(a.isCollectionView()){const e=a.getCollectionPointers()??[];for(const r of e){const e=(null==n?void 0:n.getModel(r))??t.defaultRecordCache.inMemoryRecordCache.getRecordModel({pointer:r,userId:t.currentUser.id});if(e){const i=e.getRawIcon();if(i){const e=W({icon:i,permissionRecord:r,recordMap:n,environment:t});e&&o.push(e)}}}}else if((0,A().Db)(a.getType(),a.getFormat())){const e=a.getProperties().title,r=U().air(e,{spaceId:void 0,inlinePageLink:void 0}).filter((e=>e.table===$().e));for(const i of r){const e=(null==n?void 0:n.getModel(i))??t.defaultRecordCache.inMemoryRecordCache.getRecordModel({pointer:i,userId:t.currentUser.id});if(e){var s;const t=null===(s=e.getIconIfAlive())||void 0===s?void 0:s.icon;t&&o.push({url:t,permissionRecord:i})}}}if(!a.isNavigableBlock())if(a.getType()===A().xd.transclusionReference){const e=a.getTransclusionReferenceTargetPointer();if(!e)continue;const o=(null==n?void 0:n.getModel(e))??t.defaultRecordCache.inMemoryRecordCache.getRecordModel({pointer:e,userId:t.currentUser.id});if(!o)continue;r.push(...o.getRenderableContentPointers())}else r.push(...a.getRenderableContentPointers())}}return o}({blockModel:g,environment:o,recordMap:u.recordMap});r.throwIfAborted(),c=e.length,await X({urlAndPermissionRecords:e,environment:o,abortSignal:r})}r.throwIfAborted();const p=f-s,h=performance.now()-f;return{imageCount:c,downloadedVersion:u.serverPageVersionsByPageId[n.page.id],downloadedSyncCursor:null===(t=u.serverPageSyncCursorsByPageId)||void 0===t?void 0:t[n.page.id],collectionViewBlockIds:P(n.page.id,u.recordMap),pageDownloadTime:p,imagesDownloadTime:h,batchedSyncCount:u.batchedSyncCount}}function H(){return(0,R().L)("download_max_requests_per_api_call")}class J{constructor(e){this.queueBySize=new(n(99895).G)((e=>this.createQueue(e))),this.performRequests=e}async enqueue(e,t){if(e<=1){const[e]=await this.performRequests([t]);return e}return this.queueBySize.get(e).enqueue(t)}createQueue(e){return new(n(56322).A)({performRequests:this.performRequests,batchSize:e,maxWorkers:1,requestDelayMs:100})}}class Q{constructor(){this.queue=new J((async e=>{const t=await async function(e){var t;const{requestBatch:c,environment:d,abortSignal:l}=e,{trackRequests:u,filterNextRequests:f}=function(){const e=new Set([]),t=new Set([]);return{trackRequests:function(n){for(const{page:o,cellId:r,cursor:i}of n){0===i.stack.length&&e.add(k({pageId:o.id,cellId:r}));for(const e of i.stack)for(const n of e)t.add(x({cursorItem:n,pageId:o.id,cellId:r}))}},filterNextRequests:function(n){const o=[];for(const r of n){const{cellId:n,page:i}=r,s=[];0===r.cursor.stack.length&&(e.has(k({pageId:i.id,cellId:n}))||o.push(r));for(const e of r.cursor.stack){const o=[];for(const r of e){const e=x({cursorItem:r,pageId:i.id,cellId:n});t.has(e)||o.push(r)}o.length>0&&s.push(o)}const a=n?{stack:s,cellId:n}:{stack:s};s.length>0&&o.push({...r,cursor:a})}return o}}}(),g=[],p={};let h=0,m=0;const v=[],b=[],y=n(206267).JW();let R=c.map((({page:e,offlinePageMetadata:t,originType:n,isOrigin:o})=>({page:e,lastDownloadedVersion:null==t?void 0:t.last_downloaded_version,originType:n,isOrigin:o,cursor:{stack:[]},forceFresh:!1})));for(;R.length>0&&m<z;){u(R),v.push(R);const e=new Map;for(const o of R)e.set(o.page.id,o);const t=R.map((e=>({...e,headers:(0,r().WS)({recordId:e.page.id,spaceId:e.page.spaceId,cellId:e.cellId})}))),n=(0,r().E5)(t),c=await S().lX(n.entries(),10,(async([e,t])=>{const n=H();return await S().vA(t,n,(async t=>{const n=t.map((e=>_().cJ(e,["cellId"]))),o=await C().callApi({eventName:"syncOfflinePages",environment:d,data:{requests:n,verticalColumns:d.device.isMobile,dedupeSessionId:y},headers:e,inMemoryRecordCache:E().o,abortSignal:l});return h++,"failed"===o.type?{...o,requestBatch:t}:o}))})),A=[];for(const r of c.flat()){if("failed"===r.type){const e=new(O().y)(r);throw r.offline||w().O8(e,{from:"loadRemotePages",type:"syncOfflinePagesFailed",data:{syncOfflinePagesRequests:r.requestBatch}}),e}const t=s().RecordMapWithRole.create(r.data.recordMap);g.push(t);for(const[e,o]of Object.entries(r.data.serverPageVersionsByPageId))p[e]=o;r.data.offlineModeSettings&&M().h.updateSettings(r.data.offlineModeSettings);for(const o of r.data.nextChunks)for(const t of o.cursors){const{cellId:n}=t,r=e.get(o.page.id);A.push({page:o.page,lastDownloadedVersion:void 0,cursor:t,cellId:n,originType:(null==r?void 0:r.originType)??"none",isOrigin:(null==r?void 0:r.isOrigin)??!1,forceFresh:o.forceFresh})}const n=o().b.fromRecordMapWithRole(t),c=t.getModelsByTable(a().ev).filter((e=>T().Yt(e.getType(),e.getFormat()))).map((t=>{const o=(0,i().LW)(t.pointer,n),r=(0,i().J_)(o,(t=>e.has(t.id)));if(r)return{model:t,ancestorInRequests:r}})).filter(I().O9);A.push(...c.map((({model:t,ancestorInRequests:n})=>{const o=e.get(n.id);return{page:{id:t.id,spaceId:t.getSpaceId()},cursor:{stack:[]},lastDownloadedVersion:void 0,originType:(null==o?void 0:o.originType)??"none",isOrigin:(null==o?void 0:o.isOrigin)??!1,forceFresh:(null==o?void 0:o.forceFresh)??!1}})));for(const e of r.data.pagesToDelete){const{currentUser:{id:t},defaultRecordCache:{persistedRecordCache:n}}=d;t&&n&&(n.deleteOfflineActionsWithOriginPageIdAndCleanUp({userId:t,originPageId:e,autosyncTypes:["not_autosynced"]}),n.deleteRecord({table:a().ev,id:e},t))}b.push(r.handleRecordMapForResponsePromise)}R=f(A),m++}m>=z&&w().O8(new Error("Recursively fetched syncOfflinePages too many times."),{from:"loadRemotePages",type:"infiniteFetchPrevented"});return await Promise.all(b),await(null===(t=d.defaultRecordCache.persistedRecordCache)||void 0===t?void 0:t.flushPendingWrites()),{recordMap:s().RecordMapWithRole.merge(g),serverPageVersionsByPageId:p,serverPageSyncCursorsByPageId:void 0,batchedSyncCount:h}}({environment:e[0].environment,requestBatch:e.map((e=>e.request)),abortSignal:(0,n(245725).N)(e.map((e=>e.abortSignal)))});return e.map((()=>t))}))}static getInstance(){return Q.instance??=new Q}syncPage(e){return this.queue.enqueue(e.batchSize,e)}}Q.instance=void 0;class Z{constructor(){this.queue=new J((e=>this.performSyncPageRecordSinceTimestampRequests(e)))}static getInstance(){return Z.instance??=new Z}syncPage(e){return this.queue.enqueue(e.batchSize,e)}async performSyncPageRecordSinceTimestampRequests(e){var t;if(0===e.length)return[];const{environment:n,abortSignal:o}=e[0],i=s().RecordMapWithRole.create(),c=new Map;let d=0,l=0;const u=[];for(const s of e){const{page:e,offlinePageMetadata:t}=s.request;if(c.has(e.id))continue;const n=(null==t?void 0:t.last_downloaded_sync_cursor)??p.encodedStartCursor();c.set(e.id,{page:e,shouldDelete:!1,nextCursor:n,lastCursor:n,done:!1,initialCursor:n,headers:(0,r().WS)({recordId:e.id,spaceId:e.spaceId,cellId:void 0})})}const f=new Set(c.keys()),g=async e=>{const t=(0,r().E5)(e.map((e=>{const t=c.get(e);if(!t)throw new Error("Page state not found");return t})).filter((e=>e.nextCursor)));return await S().lX(t.entries(),10,(async([e,t])=>{const r=H();return await S().vA(t,r,(async t=>{const r=t.map((({page:e,nextCursor:t})=>{if(!t)throw new Error(`Internal sync error: page ${e.id} has no next cursor`);return{page:e,cursor:t}})),i=await C().callApi({eventName:"syncPageRecordSinceTimestamp",environment:n,data:{requests:r},headers:e,inMemoryRecordCache:E().o,abortSignal:o});return d++,"failed"===i.type?{...i,requestBatch:r}:i}))}))};for(;f.size>0&&l<z;){const e=await g(Array.from(f));for(const t of e.flat()){if("failed"===t.type){const e=new(O().m)(t);throw t.offline||w().O8(e,{from:"loadRemotePages",type:"syncPageRecordSinceTimestampFailed",data:{syncPageRecordSinceTimestampRequests:t.requestBatch}}),e}const e=s().RecordMapWithRole.create(t.data.recordMap);i.assign(e);const o=[];for(const[n,r]of Object.entries(t.data.results)){const e=c.get(n);if(!e)throw new Error(`Server returned unexpected page id: ${n}`);e.shouldDelete=e.shouldDelete||r.shouldDelete,e.nextCursor=r.nextCursor,e.lastCursor=r.lastCursor??r.nextCursor??e.lastCursor,e.done=!r.nextCursor||r.shouldDelete,e.done&&f.delete(n),e.shouldDelete&&o.push(n)}for(const t of o){const{currentUser:{id:e},defaultRecordCache:{persistedRecordCache:o}}=n;e&&o&&(o.deleteOfflineActionsWithOriginPageIdAndCleanUp({userId:e,originPageId:t,autosyncTypes:["not_autosynced"]}),o.deleteRecord({table:a().ev,id:t},e))}u.push(t.handleRecordMapForResponsePromise)}l++}l>=z&&w().O8(new Error("Recursively fetched syncPageRecordSinceTimestamp too many times."),{from:"loadRemotePages",type:"infiniteFetchPrevented",data:{}});const h={},m={};for(const[r,s]of c.entries()){s.lastCursor!==s.initialCursor&&(m[r]=s.lastCursor);const e=i.getModel({table:a().ev,id:r});e&&(h[r]=e.getVersion())}await Promise.all(u),await(null===(t=n.defaultRecordCache.persistedRecordCache)||void 0===t?void 0:t.flushPendingWrites());const v={recordMap:i,serverPageVersionsByPageId:h,serverPageSyncCursorsByPageId:m,batchedSyncCount:d};return e.map((()=>v))}}Z.instance=void 0;const Y=(0,_().sg)((async function({pageStores:e,environment:t,currentUserId:o,currentSpaceStore:r,abortSignal:i}){o&&r&&(i.aborted||await navigator.locks.request(`sidebar_images_${o}_${r.id}`,{ifAvailable:!0},(async s=>{var a;if(!s)return;const c=[],d=null===(a=(0,n(625247).c)(t,r))||void 0===a?void 0:a.icon;if(d){const e=W({icon:d,permissionRecord:r.pointer,recordMap:void 0,environment:t});e&&c.push(e)}for(const n of e){var l;const e=null===(l=n.getIcon())||void 0===l?void 0:l.icon;if(e){const o=W({icon:e,permissionRecord:n.pointer,recordMap:void 0,environment:t});o&&c.push(o)}const r=n.getTitleValue(),s=U().air(r,{spaceId:void 0,inlinePageLink:void 0}).filter((e=>e.table===$().e));for(const n of s){const e=t.defaultRecordCache.inMemoryRecordCache.getRecordModel({pointer:n,userId:o});if(e){var u;const t=null===(u=e.getIconIfAlive())||void 0===u?void 0:u.icon;t&&c.push({url:t,permissionRecord:n})}}i.throwIfAborted()}await X({urlAndPermissionRecords:c,environment:t,abortSignal:i}),(0,n(564884).u)({environment:t,event:{eventName:"offline_cache_sidebar_images",eventProperties:{number_of_images_fetched:c.length}}})})))}),1e4);var ee=n(296540),te=()=>n(484714),ne=()=>n(56366),oe=()=>n(99040),re=()=>n(249847),ie=()=>n(923455),se=()=>n(961581),ae=()=>n(135055);const ce=5,de=5,le=10,ue=10;function fe(){const e=(0,te().v3)(),t=(0,ae().y6)(),n=(0,ie().Rx)(),o=(0,ne().O$)(L().AppStoreSidebarSpaceViewStore),r=(0,ne().O$)(L().AppStoreSidebarSpaceStore),i=(0,re().T)(),s=(0,ne().K8)((()=>{if(!se().A.state.initialRenderCompleted)return;if(!(n&&o&&r&&i))return;if(!t)return;if(!q().A.state.online)return;const e=[...n.visiblePrivatePagesStores.slice(0,ce),...n.visibleSharedPagesStores.slice(0,de),...(o.getWorkspacePages()??[]).slice(0,le),...o.getBookmarkedPages().slice(0,ue)];for(const t of n.visibleTeamsStores)e.push(...t.getTeamPagesStores());return e}),[n,o,i,r,t]);(0,ee.useEffect)((()=>{const t=new AbortController;return(async()=>{if(void 0!==s){const{cacheSidebarImagesDebounced:n}=await oe().W.load();await n({pageStores:s,environment:e,currentUserId:i,currentSpaceStore:r,abortSignal:t.signal})}})(),()=>{t.abort()}}),[s,i,r,e])}n(430670),n(803949);class ge{constructor(e,t=(()=>n(941541))().Ay){this.shouldConnect=!1,this.keys=new Set,this.authToken=void 0,this.authTokenExpiresTimestamp=void 0,this.listener=void 0,this.listeners=new Map,this.groupListener=e=>{var t;return null===(t=this.listener)||void 0===t?void 0:t.call(this,e)},this.environment=e,this.dispatcher=t}connect(e){const{keys:t,authToken:n,listener:o}=e;this.shouldConnect=!0,this.listener=o,this.keys=new Set(t),this.authToken=n,this.reconcile()}getKeys(){return this.keys.values()}setKeys(e){this.keys=new Set(e),this.reconcile()}getListenerFn(){return this.listener}setListenerFn(e){this.listener=e}getListenerReferences(){return this.listeners.values().map((e=>e.reference))}disconnect(){this.shouldConnect=!1,this.reconcile()}reconcile(){if(this.shouldConnect){for(const[e,t]of this.listeners)this.keys.has(e)||(this.dispatcher.removeListener(t.reference,this.environment),this.listeners.delete(e));for(const e of this.keys){const t=this.listeners.get(e);if(t){if(t.authToken===this.authToken)continue;this.dispatcher.removeListener(t.reference,this.environment)}const n=this.dispatcher.addListener(e,this.authToken,this.groupListener,null==t?void 0:t.reference.subscriptionId,this.environment);n?this.listeners.set(e,{reference:n,authToken:this.authToken}):this.listeners.delete(e)}}else this.listeners.size>0&&(this.listeners.values().forEach((e=>{this.dispatcher.removeListener(e.reference,this.environment)})),this.listeners.clear())}}var pe=()=>n(59226),he=()=>n(68336),me=()=>n(424127);var ve=()=>n(242422);var be=()=>n(591779),ye=()=>n(582676),we=()=>n(745875),_e=()=>n(53718),Se=()=>n(406792),Ie=()=>n(95723),Ce=()=>n(929480),Te=()=>n(459040),Re=()=>n(754981);const Me=5,Ee=3e5;async function Oe(e){const{environment:t,fetchTriggerType:n}=e;return"page_subscription_update"===n?async function(e){const{environment:t,pageSubscriptionUpdate:n}=e,{defaultRecordCache:{persistedRecordCache:o},currentUser:{id:r}}=t,{pageId:i,lastServerUpdateTime:s}=n;if(!o||!r)return[];const a=await o.getOfflinePageMetadata({pageId:i,userId:r});if(!a)return[];if(void 0===a.last_downloaded_at||a.last_downloaded_at<s)return[a];return[]}({environment:t,pageSubscriptionUpdate:e.pageSubscriptionUpdate}):"default_interval"===n||"app_boot_or_user_change"===n||"force_debug"===n?async function(e,t){var n;const{defaultRecordCache:{persistedRecordCache:o},currentUser:{id:r}}=e;if(!o||!r)return[];const i=null===(n=L().default.state.sidebarSpaceStore)||void 0===n?void 0:n.id;if(!i)return[];let s=[];if(t){const e=(0,R().L)("num_collections_per_refetch");s=await o.getOfflineCollectionViewBlocksForRefetch({userId:r,limit:e})}const a=(0,R().L)("num_pages_per_refetch"),c=(await(0,Ie().W)({environment:e,userId:r,spaceId:i,orderBy:"mostStaleFirst"})).filter((e=>"failed"===e.download_status||"to_download"===e.download_status||"downloading"===e.download_status||void 0===e.download_status)).slice(0,a),d=new Map;for(const l of[...s,...c])d.set(l.id,l);return Array.from(d.values())}(t,e.shouldRefetchCollections):[]}async function Ae(e){const{environment:t,fetchTriggerType:n,abortSignal:o}=e,{defaultRecordCache:{persistedRecordCache:r},currentUser:{id:i}}=t,s=performance.now();if(!r||!i)return;const a=await Oe(e);if(o.aborted)return;if(0===a.length)return;Ne((()=>`Refetching ${a.length} pages in batches of ${Me}.`)),Ne((()=>`Fetching ids: ${a.map((e=>e.id)).join(", ")}`)),Ne((()=>"--------------------------------"));const c={imageCount:0,batchedSyncCount:0,queryCollectionCount:0},d=new Set;if(await S().lX(a,Me,(async e=>{var n;const s=e.id,a=null===(n=F().A.state.offlinePages)||void 0===n||null===(n=n[s])||void 0===n?void 0:n.last_downloaded_version;Ne((()=>`Fetching page ${s}. Last downloaded version: ${a}.`));try{const n=(await r.getOfflineActions({impactedPageId:s,userId:i})).map((e=>({autosyncType:e.autosync_type,originPageId:e.origin_page_id}))).filter((e=>(0,I().O9)(e.autosyncType)&&(0,I().O9)(e.originPageId)));if(!(0,I().EI)(n))return void Ne((()=>`Warning: skipping refetch of page ${s} because it has no origin autosync type pairs.`));const l=await(0,Te().og)({from:"useRefetchOfflinePages",page:{id:s,spaceId:e.space_id},environment:t,originAutosyncTypePairs:n,visitedBlockIds:{forThisOriginPage:new Set,forThisInterval:d},stats:c,downloadAbortSignal:o});o.throwIfAborted(),Ne((()=>`Fetched and saved page ${s}. Last downloaded version: ${a}. Version from server: ${null==l?void 0:l.downloadedVersion}.`))}catch(l){l instanceof D().f||(Ne((()=>`Fetch page ${s} failed.${l instanceof Error?` Error: ${l.message}`:""}`)),w().O8(l,{from:"useRefetchOfflinePages",type:"loadRemotePageAndImagesError",data:{pageId:s}}))}})),"force_debug"!==n){var l;const o=await(0,Ie().W)({environment:t,userId:i});let r=0,d=0,u=0,f=0;for(const e of o)(e.is_autosynced_origin||e.is_explicitly_offlined_origin||e.is_offline_created_origin)&&f++,e.is_explicitly_offlined_origin&&r++,e.is_autosynced_origin&&d++,e.is_offline_created_origin&&u++;const g=(0,we().JZ)(o.map((e=>e.last_downloaded_at)).filter((e=>void 0!==e))),p=await(0,_e().T)();Se().default.measure({metricName:"background_refetch_offline_pages",startTime:s,endTime:performance.now()},{environment:t,data:{fetch_trigger_type:n,fetch_trigger_update_source:"page_subscription_update"===n?null===(l=e.pageSubscriptionUpdate)||void 0===l?void 0:l.updateSource:void 0,fetch_interval_ms:(0,R().L)("refetch_interval_ms"),number_of_offline_pages_fetched:a.length,total_number_of_offline_pages:Object.keys(F().A.state.offlinePages??{}).length,median_last_updated_at:g,number_of_images_fetched:c.imageCount,total_number_of_explicitly_marked_offline_pages:r,total_number_of_pages_created_offline:u,total_number_of_offline_origin_pages:f,total_number_of_favorites:0,total_number_of_recents:d,number_of_images_fetched_per_page:c.imageCount/a.length,...c.didUseBatchedApi?{number_of_sync_offline_pages:c.batchedSyncCount,number_of_sync_offline_pages_per_page:c.batchedSyncCount/a.length}:{number_of_load_page_chunk_v2_for_offline_per_page:c.batchedSyncCount/a.length},number_of_query_collection_per_page:c.queryCollectionCount/a.length,disk_usage:t.device.isElectron?p:void 0}})}}async function Pe(e){const{fetchTriggerType:t,environment:n,abortSignal:o}=e,{defaultRecordCache:{persistedRecordCache:r},currentUser:{id:i}}=n;if(!r||!i)return;const s=(0,R().L)("refetch_interval_ms"),a=(0,R().L)("refetch_collections_interval_ms");await navigator.locks.request(`toggle_offline_page_${n.currentUser.id}`,(()=>{})),o.aborted||await navigator.locks.request(`offline_background_task_${n.currentUser.id}`,{ifAvailable:!0},(async e=>{if(!e)return void Ne((()=>"Skipping default interval refetch because another default interval refetch is already in progress"));Ne((()=>`Acquired lock for ${t}.`)),Ne((()=>"Checking when we last refetched."));const c=await r.getOfflineMetadataLastExecutedAt({userId:i,taskType:"refetch"});if(c&&"force_debug"!==t){const e=Date.now()-c;if(e<.95*s)return void Ne((()=>`Skipping refetch because we refetched ${e/1e3/60} minutes ago.`))}const d=await r.getOfflineMetadataLastExecutedAt({userId:i,taskType:"refetch_collections"}),l=void 0===d||Date.now()-d>a,u=Date.now();await Ae({environment:n,fetchTriggerType:t,abortSignal:o,shouldRefetchCollections:l}),await r.updateOfflineMetadataLastExecutedAt({userId:i,taskType:"refetch",lastExecutedAt:u}),l&&await r.updateOfflineMetadataLastExecutedAt({userId:i,taskType:"refetch_collections",lastExecutedAt:u})}))}function ke(){const e=(0,te().v3)(),t=(0,ae().y6)(),n=(0,ae().Rs)(),o=(0,ne().K8)((()=>{if(!se().A.state.initialRenderCompleted)return!1;if(!q().A.state.online)return!1;if(e.device.isMobileNative){if("wifi"!==q().A.state.mobileConnectivityType)return!1}else{const e=navigator.connection;if(e&&(e.saveData||["slow-2g","2g"].includes(e.effectiveType??"")))return!1}return!!n||!!t&&!!(0,V().C)()}),[e.device,t,n]),r=(0,ne().K8)((()=>{var e;return null===(e=Re().Z.state.globalAbortController)||void 0===e?void 0:e.signal}),[]),i=(0,R().m)("refetch_interval_ms"),s=(0,ee.useRef)(!1),a=(0,be().ZC)(e.currentUser.id);Boolean(e.currentUser.id)&&e.currentUser.id!==a&&(s.current=!0),(0,ee.useEffect)((()=>{if(s.current&&o){Ne((()=>"Attempt fetch due to app boot or user change"));const t=(0,ye().HO)([0,Ee]),n=window.setTimeout((()=>{Pe({fetchTriggerType:"app_boot_or_user_change",environment:e,abortSignal:r}),s.current=!1}),t);return()=>{window.clearTimeout(n)}}}),[r,o,e]),(0,ee.useEffect)((()=>{Boolean(e.currentUser.id)&&Boolean(a)&&e.currentUser.id!==a&&((0,Ce().Rq)(),M().h.clearSettings())}),[e.currentUser.id,a]),(0,ee.useEffect)((()=>{let t;const n=(0,ye().HO)([0,i]),s=window.setTimeout((()=>{o&&(Pe({fetchTriggerType:"default_interval",environment:e,abortSignal:r}),t=window.setInterval((()=>{o&&Pe({fetchTriggerType:"default_interval",environment:e,abortSignal:r})}),i))}),n);return()=>{window.clearTimeout(s),t&&window.clearInterval(t)}}),[r,o,e,i])}function xe(e){if(!e)throw new Error("Pass in `__console.environment` as the first param.");Pe({fetchTriggerType:"force_debug",environment:e,abortSignal:(new AbortController).signal})}let qe,Be=!1;function Ne(e){Be&&console.log(`[useRefetchOfflinePages] ${e()}`)}function $e(){const e=(0,te().v3)(),{currentUser:{id:t}}=e,n=(0,ae().y6)(),o=(0,ae().Rs)(),r=(0,ne().K8)((()=>ve().default.getConfigKey("offline_mode_sync_engine_config","update_sources")),[]),i=(0,I().EI)(r),s=function(){const e=(0,te().v3)().currentUser.id,t=(0,pe().X)("use_sqlite_query"),n=t&&e?he().F4`
			SELECT offline_page.id 
			FROM offline_page 
			WHERE download_status = 'success' 
			AND meta_user_id = ${e} 
		`:void 0,{value:o}=(0,me().uW)("useOfflinePageIds",n,{allowError:!0,primaryKey:["id"]}),r=(0,ee.useMemo)((()=>null==o?void 0:o.map((e=>e.id))),[o]),i=(0,ne().K8)((()=>F().A.state.offlinePages?Object.values(F().A.state.offlinePages).filter((e=>"success"===(null==e?void 0:e.download_status))).map((e=>null==e?void 0:e.id)).filter(I().O9):void 0),[]);return t?r:i}();(0,ee.useEffect)((()=>{(n||o)&&i&&t&&s&&(qe?qe.environment=e:qe=new Ue(e,r,s,t))}),[e,t,n,o,i,r,s]);const a=qe&&t!==qe.userId;(0,ee.useEffect)((()=>{a&&qe&&s&&qe.handleUserChange(t,s)}),[t,a,s]),(0,ee.useEffect)((()=>{qe&&s&&qe.handleOfflinePagesChange(s)}),[s])}(0,l().exposeDebugValue)("debugAttemptFetch",xe),(0,l().exposeDebugValue)("debugAttemptFetchSinglePage",(async function(e,t){const{defaultRecordCache:{persistedRecordCache:n},currentUser:{id:o}}=e;if(!n||!o)return;if(!(await n.getOfflinePageMetadata({pageId:t,userId:o})))throw new Error(`Page ${t} is not available offline`);Ne((()=>`Debug refetching single page ${t}`));const r={pageId:t,lastServerUpdateTime:1/0,updateSource:"create_snapshot"};await navigator.locks.request(`offline_background_task_${o}`,(async t=>{if(!t)throw new Error("Failed to acquire lock for offline background task");await Ae({environment:e,fetchTriggerType:"page_subscription_update",abortSignal:(new AbortController).signal,pageSubscriptionUpdate:r})}))})),(0,l().exposeDebugValue)("toggleOfflineRefetchDebugLogs",(function(){Be=!Be,console.log(Be?"Offline refetch debug logs enabled.":"Offline refetch debug logs disabled.")}));class Ue{constructor(e,t,n,o){this.status="stopped",this.lockAbortController=void 0,this.releaseUserLock=void 0,this.listenerGroup=new ge(this.environment),this.messageStoreKeys=new Map,this.handleMessageStoreEvent=({key:e,value:t})=>{if("number"!=typeof t)return;const n=this.messageStoreKeys.get(e);if(!n)return;const{pageId:o,updateSource:r}=n,i={pageId:o,lastServerUpdateTime:t,updateSource:r};!async function(e,t){await navigator.locks.request(`offline_background_task_${e.currentUser.id}`,(async n=>{if(n)return Ae({environment:e,fetchTriggerType:"page_subscription_update",abortSignal:(new AbortController).signal,pageSubscriptionUpdate:t})}))}(this.environment,i)},this.environment=e,this.updateSources=t,this.offlineIds=n,this.userId=o,this.handleOfflinePagesChange=_().nF(this.handleOfflinePagesChange.bind(this),1e3,{leading:!0}),this.trySubscribing(n)}trySubscribing(e){if(!this.userId)throw new Error("No userId provided for subscribing");var t;this.lockAbortController=new AbortController,this.status="waiting-for-lock",navigator.locks.request((t=this.userId,`page-updates-${t}`),{signal:this.lockAbortController.signal},(()=>(this.status="subscribing",this.refreshListeners(e),new Promise((e=>{this.releaseUserLock=e}))))).catch((e=>{}))}handleUserChange(e,t){var n;if(this.userId=e,"subscribing"===this.status)this.removeAllListeners(),this.status="stopped",null===(n=this.releaseUserLock)||void 0===n||n.call(this),this.releaseUserLock=void 0;else if("waiting-for-lock"===this.status){var o;null===(o=this.lockAbortController)||void 0===o||o.abort(),this.lockAbortController=void 0,this.status="stopped"}this.userId&&this.trySubscribing(t)}handleOfflinePagesChange(e){"subscribing"===this.status&&this.refreshListeners(e)}refreshListeners(e){const{defaultRecordCache:{persistedRecordCache:t}}=this.environment;if(!t||!this.userId)return;const o=e.flatMap((e=>this.updateSources.map((t=>[(0,n(921997).z9)({pageId:e,updateSource:t}),{pageId:e,updateSource:t}]))));this.messageStoreKeys=new Map(o),this.listenerGroup.connect({keys:o.map((([e,t])=>e)),authToken:void 0,listener:this.handleMessageStoreEvent})}removeAllListeners(){this.listenerGroup.disconnect(),this.messageStoreKeys=new Map}}var je=()=>n(54525),Le=()=>n(300789);function Fe(){const e=(0,te().v3)(),t=(0,ae().y6)(),n=(0,ae().Rs)(),o=(0,ne().O$)(q().e),r=(0,be().ZC)(o);(0,ee.useEffect)((()=>{void 0!==r&&(t||n)&&!r&&o&&(0,Le().HH)(e,"offline_mode_sidebar_callout")}),[e,t,n,o,r])}}}]);